Leia o CLAUDE.md e o estado atual. Crie o mÃ³dulo de RecuperaÃ§Ã£o Judicial â€” Quadro de Credores em /dashboard/recuperacao-judicial/quadro-credores.
Este mÃ³dulo gerencia o quadro geral de credores conforme Lei 11.101/2005, incluindo importaÃ§Ã£o, classificaÃ§Ã£o, subclassificaÃ§Ã£o (com validaÃ§Ã£o STJ), habilitaÃ§Ãµes, impugnaÃ§Ãµes, divergÃªncias e exportaÃ§Ã£o. Ã‰ o mÃ³dulo-base sobre o qual os mÃ³dulos 5.2 (AprovaÃ§Ã£o PRJ) e 5.3 (NegociaÃ§Ãµes) operam.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PARTE A â€” SCHEMA DO BANCO DE DADOS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1) TABELAS PRISMA
Adicionar ao schema.prisma as seguintes tabelas. Todas vinculadas ao caseId (processo de RJ):
prisma// â”€â”€â”€â”€â”€ PROCESSO DE RJ â”€â”€â”€â”€â”€
model JudicialRecoveryCase {
  id                    String   @id @default(cuid())
  caseId                String   @unique // FK para Case existente
  case                  Case     @relation(fields: [caseId], references: [id])

  // Dados especÃ­ficos RJ
  courtName             String   // Vara
  judgeName             String?  // Juiz
  administratorName     String   // Administrador Judicial
  administratorCpfCnpj  String?
  filingDate            DateTime // Data do pedido
  grantDate             DateTime? // Data do deferimento
  stayExpirationDate    DateTime? // Vencimento do stay period
  planDeadline          DateTime? // Prazo para apresentaÃ§Ã£o do plano
  agcDate               DateTime? // Data da AGC
  planApprovalDate      DateTime? // Data de aprovaÃ§Ã£o do plano
  status                JRStatus @default(PROCESSAMENTO)

  // Totais consolidados (recalculados automaticamente)
  totalDebt             BigInt   @default(0) // Em centavos
  totalCreditors        Int      @default(0)

  // RelaÃ§Ãµes
  creditors             Creditor[]
  subclasses            CreditorSubclass[]
  creditorTableVersions CreditorTableVersion[]
  financialProjections  FinancialProjection[]
  negotiations          Negotiation[]
  votingScenarios       VotingScenario[]

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([status])
}

enum JRStatus {
  PROCESSAMENTO        // Pedido deferido, em processamento
  VERIFICACAO_CREDITOS // Fase de verificaÃ§Ã£o de crÃ©ditos
  AGC_PENDENTE         // Aguardando AGC
  PLANO_APROVADO       // Plano aprovado
  CUMPRIMENTO          // Em cumprimento do plano
  ENCERRADA            // RJ encerrada com sucesso
  CONVOLADA_FALENCIA   // Convolada em falÃªncia
}

// â”€â”€â”€â”€â”€ CREDOR â”€â”€â”€â”€â”€
model Creditor {
  id                    String   @id @default(cuid())
  jrCaseId              String
  jrCase                JudicialRecoveryCase @relation(fields: [jrCaseId], references: [id], onDelete: Cascade)

  // IdentificaÃ§Ã£o
  name                  String
  cpfCnpj               String?
  email                 String?
  phone                 String?
  lawyerName            String?
  lawyerOab             String?

  // ClassificaÃ§Ã£o â€” Art. 41 Lei 11.101/2005
  creditClass           CreditClass
  creditNature          CreditNature
  originalAmount        BigInt   // Valor original em centavos
  updatedAmount         BigInt   // Valor atualizado em centavos
  currency              String   @default("BRL")

  // Garantias (Classe II)
  guaranteeType         GuaranteeType?
  guaranteeDescription  String?
  guaranteeAssetValue   BigInt?  // Valor do bem gravado em centavos
  isFiduciaryAssignment Boolean  @default(false) // CessÃ£o fiduciÃ¡ria â€” Art. 49 Â§3Âº

  // Subclasse (opcional)
  subclassId            String?
  subclass              CreditorSubclass? @relation(fields: [subclassId], references: [id])

  // Status do crÃ©dito
  creditStatus          CreditStatus @default(HABILITADO)
  habitationDate        DateTime?
  challengeDeadline     DateTime?

  // Dados de votaÃ§Ã£o
  votingPower           BigInt?  // Poder de voto em centavos (pode diferir do valor)
  hasVotingRight        Boolean  @default(true)
  voteDirection         VoteDirection? // null = nÃ£o votou ainda

  // Dados de pagamento (pÃ³s-aprovaÃ§Ã£o)
  paymentTermMonths     Int?     // Prazo em meses
  gracePeriodMonths     Int?     // CarÃªncia em meses
  haircut               Int?     // DesÃ¡gio em basis points (5000 = 50%)
  interestRate          Int?     // Taxa de juros em basis points (100 = 1%)
  indexationType        IndexationType?
  paymentStartDate      DateTime?

  // Metadados
  source                CreditorSource @default(MANUAL)
  notes                 String?
  isPartnerCreditor     Boolean  @default(false)
  partnerCreditorTier   String?  // Tier do programa de credor parceiro

  // RelaÃ§Ãµes
  challenges            CreditorChallenge[]
  documents             CreditorDocument[]
  negotiations          NegotiationCreditor[]
  paymentSchedule       PaymentInstallment[]

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@unique([jrCaseId, cpfCnpj])
  @@index([jrCaseId, creditClass])
  @@index([jrCaseId, creditStatus])
  @@index([jrCaseId, subclassId])
}

enum CreditClass {
  CLASSE_I_TRABALHISTA    // Trabalhistas e acidentÃ¡rios
  CLASSE_II_GARANTIA_REAL // Garantia real
  CLASSE_III_QUIROGRAFARIO // QuirografÃ¡rios, privilÃ©gio especial/geral, subordinados
  CLASSE_IV_ME_EPP        // Microempresas e EPPs
}

enum CreditNature {
  // Classe I
  TRABALHISTA
  ACIDENTARIO
  // Classe II
  HIPOTECA
  PENHOR
  ALIENACAO_FIDUCIARIA_IMOVEL
  ALIENACAO_FIDUCIARIA_MOVEL
  CESSAO_FIDUCIARIA_RECEBIVEIS  // Art. 49 Â§3Âº â€” pode estar excluÃ­do da RJ
  ANTICRESE
  // Classe III
  QUIROGRAFARIO
  PRIVILEGIO_ESPECIAL
  PRIVILEGIO_GERAL
  SUBORDINADO
  // Classe IV
  ME_EPP
}

enum GuaranteeType {
  HIPOTECA
  PENHOR
  ALIENACAO_FIDUCIARIA
  CESSAO_FIDUCIARIA
  ANTICRESE
  NONE
}

enum CreditStatus {
  HABILITADO               // IncluÃ­do no QGC
  HABILITACAO_RETARDATARIA // HabilitaÃ§Ã£o retardatÃ¡ria (Art. 10 Â§Â§1Âº-6Âº)
  IMPUGNADO                // Com impugnaÃ§Ã£o pendente
  DIVERGENCIA              // DivergÃªncia entre AJ e credor
  EXCLUIDO                 // ExcluÃ­do do QGC
  EXTRACONCURSAL           // CrÃ©dito extraconcursal (Art. 49 Â§3Âº e Â§4Âº)
}

enum VoteDirection {
  FAVOR         // A favor do plano
  CONTRA        // Contra o plano
  ABSTENCAO     // AbstenÃ§Ã£o
  AUSENTE       // Ausente na AGC
}

enum IndexationType {
  TR             // Taxa Referencial â€” mais comum (33.3% dos planos)
  IPCA           // IPCA
  IGP_M          // IGP-M
  CDI            // CDI
  SELIC          // Selic
  INPC           // INPC
  SEM_CORRECAO   // Sem correÃ§Ã£o monetÃ¡ria
}

enum CreditorSource {
  MANUAL
  IMPORT_CSV
  IMPORT_EXCEL
  IMPORT_PJE
  HABILITACAO
}

// â”€â”€â”€â”€â”€ SUBCLASSES â”€â”€â”€â”€â”€
// Framework baseado no REsp 1.634.844/SP (STJ)
model CreditorSubclass {
  id                    String   @id @default(cuid())
  jrCaseId              String
  jrCase                JudicialRecoveryCase @relation(fields: [jrCaseId], references: [id], onDelete: Cascade)

  // IdentificaÃ§Ã£o
  name                  String   // Ex: "Fornecedores EstratÃ©gicos", "Credores Financeiros"
  description           String?
  parentClass           CreditClass // Classe-mÃ£e (II ou III tipicamente)

  // CritÃ©rios objetivos â€” REsp 1.634.844/SP, Requisito 1
  objectiveCriteria     Json     // Array de critÃ©rios objetivos documentados
  // Formato: [{ type: 'NATUREZA_CREDITO'|'VALOR'|'GARANTIA'|'CONDICAO_CREDOR'|'RELACAO_COMERCIAL',
  //             description: string, parameter: string, threshold?: number }]

  // Justificativa de interesses homogÃªneos â€” REsp 1.634.844/SP, Requisito 2
  homogeneousInterestsJustification String

  // DeclaraÃ§Ã£o de nÃ£o anulaÃ§Ã£o de direitos â€” REsp 1.634.844/SP, Requisito 3
  noRightsAnnulationDeclaration     String

  // CondiÃ§Ãµes de pagamento para esta subclasse
  proposedHaircut       Int?     // DesÃ¡gio em basis points
  proposedTermMonths    Int?     // Prazo em meses
  proposedGracePeriod   Int?     // CarÃªncia em meses
  proposedInterestRate  Int?     // Taxa em basis points
  proposedIndexation    IndexationType?

  // ValidaÃ§Ã£o jurÃ­dica
  validationStatus      SubclassValidation @default(RASCUNHO)
  validationNotes       String?  // Notas do validador jurÃ­dico
  cramDownRiskLevel     CramDownRisk @default(BAIXO) // Risco de inviabilizar cram down

  // Totais (recalculados)
  totalCreditors        Int      @default(0)
  totalAmount           BigInt   @default(0)

  // RelaÃ§Ãµes
  creditors             Creditor[]

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@unique([jrCaseId, name])
  @@index([jrCaseId, parentClass])
}

enum SubclassValidation {
  RASCUNHO
  PENDENTE_VALIDACAO
  VALIDADA
  REJEITADA
  REQUER_AJUSTE
}

enum CramDownRisk {
  BAIXO              // Subclasse nÃ£o gera risco ao cram down
  MEDIO              // PossÃ­vel impedimento se classe rejeitar
  ALTO               // ProvÃ¡vel impedimento ao cram down (Art. 58 Â§2Âº)
  CRITICO            // IncompatÃ­vel com cram down
}

// â”€â”€â”€â”€â”€ VERSÃ•ES DO QUADRO DE CREDORES â”€â”€â”€â”€â”€
model CreditorTableVersion {
  id                    String   @id @default(cuid())
  jrCaseId              String
  jrCase                JudicialRecoveryCase @relation(fields: [jrCaseId], references: [id], onDelete: Cascade)

  versionNumber         Int
  versionType           TableVersionType
  description           String?
  snapshot              Json     // Snapshot completo do quadro nesta versÃ£o
  totalDebt             BigInt
  totalCreditors        Int
  publishedAt           DateTime?
  publishedBy           String?

  createdAt             DateTime @default(now())

  @@unique([jrCaseId, versionNumber])
  @@index([jrCaseId])
}

enum TableVersionType {
  INICIAL              // RelaÃ§Ã£o Art. 51, III (lista inicial do devedor)
  AJ_VERIFICACAO       // ApÃ³s verificaÃ§Ã£o pelo AJ (Art. 7Âº Â§2Âº)
  POS_HABILITACOES     // ApÃ³s habilitaÃ§Ãµes e impugnaÃ§Ãµes
  CONSOLIDADO_AGC      // Consolidado para votaÃ§Ã£o na AGC (Art. 15)
  RETIFICACAO          // RetificaÃ§Ã£o judicial
  HOMOLOGADO           // Homologado pelo juiz
}

// â”€â”€â”€â”€â”€ IMPUGNAÃ‡Ã•ES E HABILITAÃ‡Ã•ES â”€â”€â”€â”€â”€
model CreditorChallenge {
  id                    String   @id @default(cuid())
  creditorId            String
  creditor              Creditor @relation(fields: [creditorId], references: [id], onDelete: Cascade)

  challengeType         ChallengeType
  requestedAmount       BigInt?  // Valor pretendido (em centavos)
  requestedClass        CreditClass?
  reason                String
  filingDate            DateTime
  deadline              DateTime?
  resolution            ChallengeResolution?
  resolutionDate        DateTime?
  resolutionAmount      BigInt?
  resolutionNotes       String?
  processNumber         String?  // NÂº do incidente processual

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([creditorId])
}

enum ChallengeType {
  HABILITACAO             // HabilitaÃ§Ã£o de crÃ©dito (Art. 7Âº Â§1Âº)
  HABILITACAO_RETARDATARIA // HabilitaÃ§Ã£o retardatÃ¡ria (Art. 10)
  IMPUGNACAO_CREDOR       // ImpugnaÃ§Ã£o por credor (Art. 8Âº)
  IMPUGNACAO_MP           // ImpugnaÃ§Ã£o pelo MP
  IMPUGNACAO_DEVEDOR      // ImpugnaÃ§Ã£o pelo devedor
  DIVERGENCIA             // DivergÃªncia (Art. 8Âº)
}

enum ChallengeResolution {
  DEFERIDA
  DEFERIDA_PARCIAL
  INDEFERIDA
  DESISTENCIA
  ACORDO
  PENDENTE
}

// â”€â”€â”€â”€â”€ DOCUMENTOS DO CREDOR â”€â”€â”€â”€â”€
model CreditorDocument {
  id                    String   @id @default(cuid())
  creditorId            String
  creditor              Creditor @relation(fields: [creditorId], references: [id], onDelete: Cascade)

  documentType          CreditorDocType
  fileName              String
  fileUrl               String
  fileSize              Int?
  description           String?
  uploadedAt            DateTime @default(now())

  @@index([creditorId])
}

enum CreditorDocType {
  CONTRATO
  NOTA_FISCAL
  DUPLICATA
  CCB                  // CÃ©dula de CrÃ©dito BancÃ¡rio
  CPR                  // CÃ©dula de Produto Rural
  SENTENCA_TRABALHISTA
  CERTIDAO_CREDITO
  COMPROVANTE_GARANTIA
  HABILITACAO_PETICAO
  IMPUGNACAO_PETICAO
  PROCURACAO
  OUTROS
}

// â”€â”€â”€â”€â”€ PARCELAS DE PAGAMENTO â”€â”€â”€â”€â”€
model PaymentInstallment {
  id                    String   @id @default(cuid())
  creditorId            String
  creditor              Creditor @relation(fields: [creditorId], references: [id], onDelete: Cascade)

  installmentNumber     Int
  dueDate               DateTime
  principalAmount       BigInt   // Em centavos
  interestAmount        BigInt   @default(0)
  indexationAmount      BigInt   @default(0)
  totalAmount           BigInt   // Em centavos
  paidAmount            BigInt   @default(0)
  paidDate              DateTime?
  status                InstallmentStatus @default(PENDENTE)

  @@unique([creditorId, installmentNumber])
  @@index([creditorId, status])
  @@index([dueDate])
}

enum InstallmentStatus {
  PENDENTE
  VENCIDO
  PAGO
  PAGO_PARCIAL
  INADIMPLIDO
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PARTE B â€” SERVICES (src/lib/services/)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

2) CREDITOR SERVICE (creditor-service.ts)
typescript// ServiÃ§o principal de gerenciamento de credores
// REGRA CARDINAL: Todos os valores monetÃ¡rios sÃ£o armazenados como BigInt em centavos
// Nunca usar number nativo para valores monetÃ¡rios

interface CreditorFilters {
  creditClass?: CreditClass;
  creditStatus?: CreditStatus;
  subclassId?: string;
  search?: string; // Busca por nome, CPF/CNPJ
  isPartnerCreditor?: boolean;
  minAmount?: bigint;
  maxAmount?: bigint;
}

interface CreditorSummary {
  totalCreditors: number;
  totalDebt: bigint; // centavos
  byClass: {
    class: CreditClass;
    count: number;
    totalAmount: bigint;
    percentage: number; // do total
  }[];
  byStatus: {
    status: CreditStatus;
    count: number;
  }[];
  bySubclass: {
    subclassId: string;
    subclassName: string;
    parentClass: CreditClass;
    count: number;
    totalAmount: bigint;
  }[];
}

export class CreditorService {
  // CRUD
  async createCreditor(jrCaseId: string, data: CreateCreditorInput): Promise<Creditor>;
  async updateCreditor(id: string, data: UpdateCreditorInput): Promise<Creditor>;
  async deleteCreditor(id: string): Promise<void>;
  async getCreditor(id: string): Promise<Creditor & { challenges: CreditorChallenge[]; documents: CreditorDocument[] }>;

  // Listagem com filtros
  async listCreditors(jrCaseId: string, filters: CreditorFilters, pagination: PaginationInput): Promise<PaginatedResult<Creditor>>;

  // Resumo/Dashboard
  async getCreditorSummary(jrCaseId: string): Promise<CreditorSummary>;

  // ImportaÃ§Ã£o em massa
  async importFromCSV(jrCaseId: string, file: File): Promise<ImportResult>;
  async importFromExcel(jrCaseId: string, file: File): Promise<ImportResult>;
  // Formato esperado CSV: nome,cpf_cnpj,classe,natureza,valor_original,valor_atualizado,garantia_tipo,garantia_valor

  // ExportaÃ§Ã£o
  async exportToExcel(jrCaseId: string, filters?: CreditorFilters): Promise<Buffer>;
  async exportToPDF(jrCaseId: string, filters?: CreditorFilters): Promise<Buffer>;

  // Recalcular totais
  async recalculateTotals(jrCaseId: string): Promise<void>;

  // Versioning
  async createTableVersion(jrCaseId: string, type: TableVersionType, description: string): Promise<CreditorTableVersion>;
  async getTableVersion(versionId: string): Promise<CreditorTableVersion>;
  async listTableVersions(jrCaseId: string): Promise<CreditorTableVersion[]>;
  async compareVersions(versionId1: string, versionId2: string): Promise<VersionDiff>;

  // ValidaÃ§Ã£o de classe
  async validateCreditorClass(creditor: Creditor): Promise<ValidationResult>;
  // Regras:
  // - Classe I: limite de 150 salÃ¡rios mÃ­nimos (Art. 83 Â§4Âº CTN c/c Art. 41 Â§2Âº)
  // - Classe II: crÃ©dito atÃ© limite do bem gravado; excedente vai para Classe III
  // - CessÃ£o fiduciÃ¡ria de recebÃ­veis (Art. 49 Â§3Âº): marcar como EXTRACONCURSAL
  // - Classe IV: verificar se credor Ã© ME/EPP (CNPJ + enquadramento)
}

3) SUBCLASS SERVICE (subclass-service.ts)
typescript// ServiÃ§o de gerenciamento de subclasses
// Implementa validaÃ§Ã£o conforme REsp 1.634.844/SP (STJ)

interface SubclassValidationResult {
  isValid: boolean;
  errors: SubclassValidationError[];
  warnings: SubclassValidationWarning[];
  cramDownRisk: CramDownRisk;
  cramDownRiskExplanation: string;
}

interface SubclassValidationError {
  code: string;
  field: string;
  message: string;
  legalBasis: string; // FundamentaÃ§Ã£o legal
}

interface SubclassValidationWarning {
  code: string;
  message: string;
  recommendation: string;
}

export class SubclassService {
  // CRUD
  async createSubclass(jrCaseId: string, data: CreateSubclassInput): Promise<CreditorSubclass>;
  async updateSubclass(id: string, data: UpdateSubclassInput): Promise<CreditorSubclass>;
  async deleteSubclass(id: string): Promise<void>;
  async listSubclasses(jrCaseId: string): Promise<CreditorSubclass[]>;

  // AtribuiÃ§Ã£o de credores a subclasses
  async assignCreditorToSubclass(creditorId: string, subclassId: string): Promise<void>;
  async removeCreditorFromSubclass(creditorId: string): Promise<void>;
  async bulkAssignToSubclass(creditorIds: string[], subclassId: string): Promise<void>;

  // â•â•â• VALIDAÃ‡ÃƒO STJ (REsp 1.634.844/SP) â•â•â•
  async validateSubclass(id: string): Promise<SubclassValidationResult>;
  // Implementar as 3 verificaÃ§Ãµes cumulativas:

  // REQUISITO 1 â€” CritÃ©rios objetivos
  // Verificar que objectiveCriteria contÃ©m pelo menos 1 critÃ©rio com:
  // - type: deve ser NATUREZA_CREDITO, VALOR, GARANTIA, CONDICAO_CREDOR ou RELACAO_COMERCIAL
  // - description: nÃ£o pode ser genÃ©rica ("credores que eu quiser")
  // - parameter: deve ser verificÃ¡vel objetivamente
  // ERRO se: critÃ©rios vagos, potestatividade (depende da vontade exclusiva do devedor)
  // ERRO se: condiciona parceria Ã  aprovaÃ§Ã£o do plano (TJ-SP AI 2118997-68.2024.8.26.0000)

  // REQUISITO 2 â€” Interesses homogÃªneos
  // Verificar que homogeneousInterestsJustification:
  // - Descreve caracterÃ­sticas comuns dos credores da subclasse
  // - Demonstra que os credores tÃªm situaÃ§Ã£o jurÃ­dica/econÃ´mica similar
  // ERRO se: justificativa genÃ©rica ou ausente

  // REQUISITO 3 â€” VedaÃ§Ã£o de anulaÃ§Ã£o de direitos
  // Verificar que noRightsAnnulationDeclaration:
  // - Confirma que credores fora da subclasse mantÃªm direitos reais
  // - O haircut da subclasse menos favorecida nÃ£o Ã© confiscatÃ³rio (>90% = alerta)
  // ERRO se: subclasse minoritÃ¡ria recebe tratamento que equivale a eliminaÃ§Ã£o do crÃ©dito

  // â•â•â• ANÃLISE DE RISCO CRAM DOWN (Art. 58 Â§2Âº) â•â•â•
  async analyzeCramDownRisk(jrCaseId: string): Promise<CramDownRiskAnalysis>;
  // Art. 58 Â§2Âº proÃ­be tratamento diferenciado entre credores da classe que rejeitou
  // Se existem subclasses com tratamento diferente na mesma classe:
  // - BAIXO: diferenÃ§a de haircut < 10pp entre subclasses
  // - MÃ‰DIO: diferenÃ§a de haircut 10-30pp
  // - ALTO: diferenÃ§a de haircut > 30pp
  // - CRÃTICO: subclasse com haircut >90% enquanto outra <50%
  // O sistema deve ALERTAR o usuÃ¡rio sobre esse risco ao criar subclasses

  // â•â•â• VEDAÃ‡Ã•ES EXPRESSAS (TJ-SP) â•â•â•
  // O service deve rejeitar automaticamente:
  // 1. "Gerrymandering creditÃ³rio" â€” subclasses que manipulam quÃ³rum de votaÃ§Ã£o
  //    Detectar: se mover credores para subclasse mudaria resultado de votaÃ§Ã£o
  // 2. CondiÃ§Ã£o potestativa â€” devedor escolhe livremente quem entra
  //    Detectar: critÃ©rio baseado apenas em decisÃ£o unilateral do devedor
  // 3. Condicionar parceria Ã  aprovaÃ§Ã£o do plano
  //    Detectar: critÃ©rio que menciona voto/aprovaÃ§Ã£o como condiÃ§Ã£o
  // 4. NegociaÃ§Ãµes individuais sem critÃ©rios objetivos
  //    Detectar: subclasse com 1 Ãºnico credor sem justificativa
}

4) PAYMENT CALCULATOR SERVICE (payment-calculator-service.ts)
typescript// ServiÃ§o de cÃ¡lculos financeiros
// USA Decimal.js para TODOS os cÃ¡lculos â€” NUNCA number nativo
// Armazena resultados como BigInt (centavos) no banco

import Decimal from 'decimal.js';

// ConfiguraÃ§Ã£o global obrigatÃ³ria
Decimal.set({
  precision: 20,
  rounding: Decimal.ROUND_HALF_UP, // PadrÃ£o financeiro brasileiro
  toExpNeg: -9,
  toExpPos: 20,
});

interface PaymentScheduleInput {
  originalAmount: bigint;       // centavos
  haircut: number;              // basis points (5000 = 50%)
  termMonths: number;
  gracePeriodMonths: number;
  interestRate: number;         // basis points anuais (100 = 1%)
  indexation: IndexationType;
  startDate: Date;
  amortizationType: 'SAC' | 'PRICE' | 'BULLET' | 'CUSTOM';
}

interface PaymentScheduleOutput {
  installments: {
    number: number;
    dueDate: Date;
    principal: bigint;
    interest: bigint;
    indexation: bigint;
    total: bigint;
    outstandingBalance: bigint;
  }[];
  summary: {
    totalPaid: bigint;
    totalInterest: bigint;
    totalIndexation: bigint;
    effectiveHaircut: number;     // DesÃ¡gio efetivo em valor presente
    npv: bigint;                  // NPV descontado Ã  Selic
    recoveryRate: number;         // Centavos por real recuperados
    irr: number;                  // TIR em basis points
  };
}

export class PaymentCalculatorService {
  // Gerar cronograma de pagamento para um credor
  async generatePaymentSchedule(input: PaymentScheduleInput): Promise<PaymentScheduleOutput>;

  // Gerar cronograma para toda uma subclasse
  async generateSubclassSchedule(subclassId: string): Promise<PaymentScheduleOutput[]>;

  // Gerar cronograma consolidado por classe
  async generateClassSchedule(jrCaseId: string, creditClass: CreditClass): Promise<ConsolidatedSchedule>;

  // â•â•â• NPV â€” Valor Presente LÃ­quido â•â•â•
  // Calcular NPV dos pagamentos descontados Ã  taxa especificada
  // Taxas comuns: Selic (14.25%), CDI (14.15%), IPCA+spread
  async calculateNPV(
    cashflows: { date: Date; amount: bigint }[],
    discountRate: number, // basis points anuais
    referenceDate: Date
  ): Promise<bigint>;

  // â•â•â• COMPARAÃ‡ÃƒO RJ vs. FALÃŠNCIA â•â•â•
  // AnÃ¡lise waterfall comparativa
  async compareRJvsBankruptcy(jrCaseId: string): Promise<{
    rjScenario: {
      byClass: { class: CreditClass; totalReceived: bigint; npv: bigint; recoveryRate: number }[];
      totalRecovered: bigint;
      timelineYears: number;
    };
    bankruptcyScenario: {
      estimatedAssetValue: bigint;
      liquidationCosts: bigint; // Tipicamente 20-30% do valor
      byClass: { class: CreditClass; estimatedRecovery: bigint; recoveryRate: number }[];
      totalRecovered: bigint;
      estimatedTimelineYears: number; // 10+ anos tipicamente
    };
    advantage: 'RJ' | 'FALENCIA';
    advantageAmount: bigint;
  }>;

  // â•â•â• CAPACIDADE DE PAGAMENTO â•â•â•
  // EBITDA Ajustado â†’ (-) Impostos â†’ (-) CAPEX manutenÃ§Ã£o â†’ (-/+) Î”NCG â†’ FCF
  async calculatePaymentCapacity(projectionId: string): Promise<{
    freeCAshFlow: bigint;
    dscr: number; // Debt Service Coverage Ratio (meta: >1.2x)
    maxAnnualPayment: bigint; // 70-80% do FCF
    isViable: boolean;
  }>;

  // â•â•â• IMPACTO TRIBUTÃRIO DO DESÃGIO â•â•â•
  // Art. 50-A: PIS/Cofins excluÃ­dos, mas IRPJ+CSLL incidem a 34%
  async calculateHaircutTaxImpact(
    totalHaircut: bigint,
    accumulatedTaxLoss: bigint // PrejuÃ­zo fiscal acumulado
  ): Promise<{
    grossTaxLiability: bigint;   // 34% sobre o desÃ¡gio
    offsetByTaxLoss: bigint;     // Compensado com prejuÃ­zo fiscal
    netTaxLiability: bigint;     // Tributo efetivamente devido
    effectiveHaircut: bigint;    // DesÃ¡gio lÃ­quido apÃ³s tributos
  }>;
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PARTE C â€” LAYOUT E COMPONENTES DA PÃGINA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

5) LAYOUT DA PÃGINA (/dashboard/recuperacao-judicial/quadro-credores)
Layout com sidebar esquerda + Ã¡rea principal com tabs.
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Header: "Quadro de Credores" + [Caso: Grupo B&F Agro] + AÃ§Ãµes    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              â”‚  [Resumo] [Lista] [Subclasses] [ImpugnaÃ§Ãµes]        â”‚
â”‚  SIDEBAR     â”‚  [VersÃµes] [Pagamentos]                              â”‚
â”‚  Resumo do   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Caso        â”‚                                                      â”‚
â”‚              â”‚  CONTEÃšDO DA TAB ATIVA                                â”‚
â”‚  Stats       â”‚                                                      â”‚
â”‚  rÃ¡pidos     â”‚  (ver detalhamento abaixo)                           â”‚
â”‚              â”‚                                                      â”‚
â”‚  Filtros     â”‚                                                      â”‚
â”‚              â”‚                                                      â”‚
â”‚  AÃ§Ãµes       â”‚                                                      â”‚
â”‚  rÃ¡pidas     â”‚                                                      â”‚
â”‚              â”‚                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Status bar: "1.247 credores | R$ 892.4M | Ãšltima versÃ£o: #5"      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Header

TÃ­tulo "Quadro de Credores" com Ã­cone Users (lucide-react)
Select do caso de RJ vinculado (se o usuÃ¡rio tiver mÃºltiplos casos)
BotÃµes de aÃ§Ã£o: "Importar" (Upload), "Exportar" (Download), "Nova VersÃ£o" (GitBranch), "RelatÃ³rio AJ" (FileText)
Badge de status do caso (PROCESSAMENTO, VERIFICAÃ‡ÃƒO, etc.) com cor correspondente

Sidebar (w-[320px])
Card "Resumo do Caso":

Nome do caso, vara, juiz, AJ
Data pedido, deferimento, prazo plano
Status com badge colorido
Barra de progresso do timeline (pedido â†’ deferimento â†’ verificaÃ§Ã£o â†’ AGC â†’ aprovaÃ§Ã£o)

Card "Totais":

Total de credores (nÃºmero grande)
DÃ­vida total (formatado R$ com separadores)
4 mini-cards para cada classe com count + valor + % do total:

Classe I: Ã­cone HardHat, cor blue
Classe II: Ã­cone Shield, cor amber
Classe III: Ã­cone FileText, cor slate
Classe IV: Ã­cone Building2, cor emerald



Filtros (collapsible):

Select "Classe" (Todas, I, II, III, IV)
Select "Status" (Todos, Habilitado, Impugnado, etc.)
Select "Subclasse" (Todas, listar subclasses existentes)
Toggle "Apenas credores parceiros"
Range de valor (min/max)
BotÃ£o "Limpar filtros"

AÃ§Ãµes RÃ¡pidas:

"Adicionar Credor" (abre modal)
"Criar Subclasse" (abre modal â€” ver seÃ§Ã£o 8)
"Validar Quadro" (executa validaÃ§Ãµes)
"Comparar com versÃ£o anterior"


6) TAB "RESUMO" (Dashboard visual)
Dashboard com visualizaÃ§Ãµes do quadro de credores. Usar Recharts para grÃ¡ficos.
Linha 1 â€” KPIs (4 cards):

Total Credores | DÃ­vida Total | Haircut MÃ©dio Ponderado | Taxa RecuperaÃ§Ã£o NPV

Linha 2 â€” GrÃ¡ficos lado a lado:

Donut chart: DistribuiÃ§Ã£o por classe (valores) â€” Recharts PieChart com innerRadius
Bar chart horizontal: Top 10 maiores credores com nome + valor + classe (cor-coded)

Linha 3 â€” GrÃ¡ficos lado a lado:

Stacked bar chart: DistribuiÃ§Ã£o por subclasse dentro de cada classe
Waterfall chart: ComposiÃ§Ã£o da dÃ­vida (original â†’ juros â†’ correÃ§Ã£o â†’ haircut â†’ valor plano)

Linha 4 â€” Tabela resumo:

Tabela consolidada por classe com: Classe | NÂº Credores | Valor Original | Valor Atualizado | Haircut Proposto | Valor Plano | NPV | Prazo MÃ©dio
Linha de total no footer

Linha 5 â€” Comparativo RJ vs. FalÃªncia:

Dois waterfall charts lado a lado (ver seÃ§Ã£o 4 do service)
Card com "Vantagem da RJ: R$ X.XXX.XXX" em destaque verde


7) TAB "LISTA" (Tabela editÃ¡vel de credores)
Usar TanStack Table v8 com virtualizaÃ§Ã£o para performance.
Colunas da tabela:
ColunaTipoLarguraOrdenÃ¡velEditÃ¡velCheckbox (seleÃ§Ã£o)checkbox40pxnÃ£oâ€”#nÃºmero sequencial50pxsimnÃ£oNome/RazÃ£o Socialtexto250pxsimnÃ£oCPF/CNPJtexto formatado150pxsimnÃ£oClassebadge colorido100pxsimsim (select)Naturezatexto140pxsimsim (select)Subclassebadge160pxsimsim (select)Valor Originalmoeda (R$)140pxsimsim (input)Valor Atualizadomoeda (R$)140pxsimsim (input)Haircut%80pxsimsim (input)Valor Planomoeda (calculado)140pxsimnÃ£oPrazo (meses)nÃºmero80pxsimsimCarÃªncianÃºmero80pxsimsimJuros (% a.a.)%80pxsimsimIndexaÃ§Ã£oselect80pxsimsimStatusbadge120pxsimsim (select)Credor Parceirotoggle80pxâ€”simAÃ§ÃµesbotÃµes100pxnÃ£oâ€”
Funcionalidades da tabela:

EdiÃ§Ã£o inline: click em cÃ©lula editÃ¡vel â†’ campo de ediÃ§Ã£o aparece â†’ Enter para salvar, Esc para cancelar
SeleÃ§Ã£o em massa: checkbox no header seleciona todos â†’ barra de aÃ§Ãµes em massa aparece no topo
AÃ§Ãµes em massa: "Mover para subclasse", "Alterar classe", "Definir condiÃ§Ãµes de pagamento", "Exportar selecionados"
AÃ§Ãµes por linha: menu dropdown com Editar (abre modal), Documentos, HabilitaÃ§Ãµes, ImpugnaÃ§Ãµes, HistÃ³rico, Excluir
Busca: campo de texto no topo da tabela com busca em nome + CPF/CNPJ
Sticky header: header da tabela fixo durante scroll
Sticky primeira coluna: nome do credor visÃ­vel durante scroll horizontal
Totais no footer: linha fixa com soma dos valores
VirtualizaÃ§Ã£o: @tanstack/react-virtual para 1000+ credores
Drag & drop: reordenar credores dentro da mesma classe (para prioridade visual)

Modal "Editar Credor" (Sheet lateral):
FormulÃ¡rio completo com todas as informaÃ§Ãµes do credor, organizado em seÃ§Ãµes:

SeÃ§Ã£o "IdentificaÃ§Ã£o" (nome, CPF/CNPJ, email, telefone, advogado)
SeÃ§Ã£o "ClassificaÃ§Ã£o" (classe, natureza, subclasse)
SeÃ§Ã£o "Valores" (original, atualizado, moeda)
SeÃ§Ã£o "Garantia" (tipo, descriÃ§Ã£o, valor do bem, Ã© cessÃ£o fiduciÃ¡ria?)
SeÃ§Ã£o "CondiÃ§Ãµes de Pagamento" (haircut, prazo, carÃªncia, juros, indexaÃ§Ã£o)
SeÃ§Ã£o "Programa Credor Parceiro" (toggle + tier + condiÃ§Ãµes especiais)
SeÃ§Ã£o "Documentos" (upload + lista de docs vinculados)
SeÃ§Ã£o "Notas" (campo de texto livre)


8) TAB "SUBCLASSES" (CriaÃ§Ã£o e gestÃ£o conforme STJ)
VisÃ£o geral das subclasses
Grid de cards, um por subclasse existente:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ·ï¸ Fornecedores EstratÃ©gicos               â”‚
â”‚ Classe III â€” QuirografÃ¡rios                  â”‚
â”‚                                              â”‚
â”‚ Credores: 47    |  Total: R$ 23.8M          â”‚
â”‚ Haircut: 30%    |  Prazo: 5 anos            â”‚
â”‚                                              â”‚
â”‚ âœ… Validada STJ  |  âš ï¸ Risco Cram Down: MÃ©dioâ”‚
â”‚                                              â”‚
â”‚ [Ver Credores] [Editar] [Validar]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Modal "Criar/Editar Subclasse" (Dialog grande ou pÃ¡gina)
Este modal Ã© CRÃTICO â€” implementa os 3 requisitos do REsp 1.634.844/SP:
SeÃ§Ã£o 1 â€” IdentificaÃ§Ã£o:

Campo "Nome da Subclasse" (obrigatÃ³rio)
Select "Classe-mÃ£e" (Classe II ou Classe III â€” Classe I e IV raramente subclassificam)
Campo "DescriÃ§Ã£o" (textarea)

SeÃ§Ã£o 2 â€” CritÃ©rios Objetivos (Requisito 1 STJ):
Banner informativo azul: "O STJ exige critÃ©rios objetivos, impessoais e verificÃ¡veis para diferenciaÃ§Ã£o de credores (REsp 1.634.844/SP). CritÃ©rios vagos ou potestativos serÃ£o rejeitados."
Array dinÃ¢mico de critÃ©rios (botÃ£o "Adicionar CritÃ©rio"):
Para cada critÃ©rio:

Select "Tipo de CritÃ©rio":

NATUREZA_CREDITO â†’ "Natureza do crÃ©dito" (ex: "fornecedores de insumos agrÃ­colas")
VALOR â†’ "Faixa de valor" (ex: "crÃ©ditos atÃ© R$ 100.000")
GARANTIA â†’ "Tipo de garantia" (ex: "credores com alienaÃ§Ã£o fiduciÃ¡ria de imÃ³vel")
CONDICAO_CREDOR â†’ "CondiÃ§Ã£o do credor" (ex: "instituiÃ§Ãµes financeiras reguladas pelo BACEN")
RELACAO_COMERCIAL â†’ "RelaÃ§Ã£o comercial com o devedor" (ex: "fornecedores que mantiveram fornecimento pÃ³s-pedido")


Campo "DescriÃ§Ã£o detalhada" (obrigatÃ³rio)
Campo "ParÃ¢metro verificÃ¡vel" (obrigatÃ³rio)
Campo "Limiar quantitativo" (opcional â€” ex: valor, percentual)

Alerta vermelho aparece se:

Nenhum critÃ©rio adicionado
CritÃ©rio usa linguagem potestativa ("a critÃ©rio do devedor", "conforme decisÃ£o do recuperando")
CritÃ©rio condiciona Ã  aprovaÃ§Ã£o do plano

SeÃ§Ã£o 3 â€” Interesses HomogÃªneos (Requisito 2 STJ):
Banner informativo: "Demonstre que os credores desta subclasse compartilham interesses e caracterÃ­sticas similares."

Textarea "Justificativa de Interesses HomogÃªneos" (obrigatÃ³rio, mÃ­nimo 100 caracteres)
SugestÃµes contextuais baseadas no tipo de critÃ©rio selecionado:

Se NATUREZA_CREDITO: "Os fornecedores de [X] compartilham o interesse em manter a relaÃ§Ã£o comercial continuada..."
Se VALOR: "Credores de pequeno valor tÃªm interesse homogÃªneo em pagamento cÃ©lere..."
Se CONDICAO_CREDOR: "InstituiÃ§Ãµes financeiras compartilham expertise e capacidade de..."



SeÃ§Ã£o 4 â€” ProteÃ§Ã£o de Direitos (Requisito 3 STJ):
Banner informativo: "A criaÃ§Ã£o de subclasses NÃƒO pode resultar na eliminaÃ§Ã£o virtual de direitos de credores minoritÃ¡rios."

Textarea "DeclaraÃ§Ã£o de nÃ£o anulaÃ§Ã£o de direitos" (obrigatÃ³rio)
ValidaÃ§Ã£o automÃ¡tica: se haircut proposto > 90%, warning amarelo
ValidaÃ§Ã£o automÃ¡tica: se prazo > 15 anos com juros < Selic, warning amarelo
CÃ¡lculo automÃ¡tico do "valor presente da recuperaÃ§Ã£o" para demonstrar que credores fora da subclasse ainda recuperam valor significativo

SeÃ§Ã£o 5 â€” CondiÃ§Ãµes de Pagamento:

Input "DesÃ¡gio" (%) â€” com slider 0-100%
Input "Prazo" (meses) â€” com slider 12-180
Input "CarÃªncia" (meses) â€” com slider 0-36
Input "Taxa de juros" (% a.a.)
Select "IndexaÃ§Ã£o" (TR, IPCA, CDI, etc.)
Select "Tipo de amortizaÃ§Ã£o" (SAC, Price, Bullet, Custom)

SeÃ§Ã£o 6 â€” Preview e ValidaÃ§Ã£o:

BotÃ£o "Validar conforme STJ" â€” executa SubclassService.validateSubclass()
Card de resultado com Ã­cones: âœ… Aprovado / âš ï¸ Alerta / âŒ Rejeitado para cada requisito
Se hÃ¡ warnings: lista detalhada com fundamentaÃ§Ã£o legal e recomendaÃ§Ã£o
Card "Risco Cram Down" com nÃ­vel (Baixo/MÃ©dio/Alto/CrÃ­tico) e explicaÃ§Ã£o

SeÃ§Ã£o 7 â€” SeleÃ§Ã£o de Credores:

Tabela filtrada mostrando apenas credores da classe-mÃ£e
Checkbox para selecionar credores que pertencem a esta subclasse
BotÃ£o "Selecionar por critÃ©rio" â€” aplica automaticamente os critÃ©rios objetivos definidos
Resumo: "47 credores selecionados | R$ 23.8M | 26% da Classe III"


9) TAB "IMPUGNAÃ‡Ã•ES"
Tabela de habilitaÃ§Ãµes e impugnaÃ§Ãµes com status tracking:
ColunaDescriÃ§Ã£oCredorNome + CPF/CNPJTipoBadge (HabilitaÃ§Ã£o, ImpugnaÃ§Ã£o Credor, ImpugnaÃ§Ã£o MP, etc.)Valor PretendidoR$ formatadoClasse PretendidaBadgeData ProtocoloDataPrazoData com indicador de vencimentoStatusBadge (Pendente, Deferida, Indeferida, etc.)IncidenteLink para nÂº do processoAÃ§ÃµesVer detalhes, Vincular ao credor
Acima da tabela:

KPIs: Total habilitaÃ§Ãµes | Total impugnaÃ§Ãµes | Pendentes | Impacto no quadro (R$)
BotÃ£o "Nova HabilitaÃ§Ã£o" e "Nova ImpugnaÃ§Ã£o"


10) TAB "VERSÃ•ES"
Timeline visual de versÃµes do quadro de credores:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“‹ VersÃ£o #5 â€” Consolidado AGC                  â”‚
â”‚  Publicada em 15/01/2025 por Jean Rodrigo Cioffi â”‚
â”‚  1.247 credores | R$ 892.4M                      â”‚
â”‚  [Visualizar] [Comparar com v4] [Exportar PDF]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“‹ VersÃ£o #4 â€” PÃ³s-habilitaÃ§Ãµes                 â”‚
â”‚  Publicada em 03/12/2024                          â”‚
â”‚  1.198 credores | R$ 856.1M                      â”‚
â”‚  [Visualizar] [Comparar] [Exportar]              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ... versÃµes anteriores ...                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Modal "Comparar VersÃµes": side-by-side diff mostrando credores adicionados (verde), removidos (vermelho), valores alterados (amarelo), classes alteradas (orange). Resumo no topo: "+49 credores, +R$ 36.3M, 12 reclassificaÃ§Ãµes".

11) TAB "PAGAMENTOS" (visÃ£o consolidada)
GrÃ¡fico principal (Recharts): Stacked area chart mostrando projeÃ§Ã£o de pagamentos por classe ao longo do tempo (eixo X: meses, eixo Y: R$).
Tabela consolidada por perÃ­odo:
AnoClasse IClasse IIClasse IIIClasse IVTotalFCF DisponÃ­velDSCR2025R$ 2.1MR$ 0R$ 0R$ 0.3MR$ 2.4MR$ 5.8M2.4x2026R$ 1.8MR$ 4.2MR$ 3.1MR$ 0.6MR$ 9.7MR$ 12.1M1.2x........................
Card de alerta: Se DSCR < 1.2x em qualquer perÃ­odo, card vermelho: "âš ï¸ Capacidade de pagamento insuficiente em [perÃ­odo] â€” DSCR: 0.9x"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PARTE D â€” IMPORTAÃ‡ÃƒO / EXPORTAÃ‡ÃƒO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

12) IMPORTAÃ‡ÃƒO DE CREDORES
Modal de ImportaÃ§Ã£o (Dialog):
Step 1 â€” Upload:

Drag-and-drop zone para arquivo CSV ou Excel
Templates para download: "Baixar template CSV" / "Baixar template Excel"
O template Excel deve ter: cabeÃ§alhos em portuguÃªs, validaÃ§Ã£o por dropdown nas colunas Classe e Natureza, formataÃ§Ã£o monetÃ¡ria na coluna de valores, exemplos na linha 2

Step 2 â€” Mapeamento:

Tabela mostrando colunas do arquivo â†’ campo do sistema
Auto-detect de colunas comuns (nome, cpf, cnpj, valor, classe)
Selects para mapear colunas nÃ£o reconhecidas
Preview das primeiras 5 linhas

Step 3 â€” ValidaÃ§Ã£o:

Executar validaÃ§Ã£o em todas as linhas
Lista de erros/warnings: "Linha 47: CPF invÃ¡lido", "Linha 123: classe nÃ£o reconhecida"
EstatÃ­sticas: "892 vÃ¡lidos | 15 com warnings | 3 com erros"
OpÃ§Ã£o: "Ignorar linhas com erro" ou "Corrigir antes de importar"

Step 4 â€” ConfirmaÃ§Ã£o:

Resumo: "SerÃ£o importados 892 credores totalizando R$ 445.2M"
Breakdown por classe
BotÃ£o "Importar" com loading

ExportaÃ§Ã£o Excel (ExcelJS)
Gerar arquivo .xlsx com formataÃ§Ã£o profissional:

Aba "Quadro Geral": todos os credores com todas as colunas
Aba "Por Classe": uma seÃ§Ã£o por classe com subtotais
Aba "Por Subclasse": credores agrupados por subclasse
Aba "Resumo": tabela resumo + grÃ¡ficos (ExcelJS suporta chart embedding bÃ¡sico)
FormataÃ§Ã£o: cabeÃ§alhos azul escuro com texto branco, linhas alternadas, valores monetÃ¡rios formatados, bordas finas
FÃ³rmulas de soma nos totais (nÃ£o valores hardcoded)
Filtros automÃ¡ticos em todas as colunas

ExportaÃ§Ã£o PDF (Puppeteer server-side)
RelatÃ³rio PDF tipo "RelatÃ³rio do Administrador Judicial":

Capa com tÃ­tulo, caso, vara, data
Ãndice
Resumo executivo com KPIs e grÃ¡ficos
Quadro geral por classe (tabela completa)
SeÃ§Ã£o de subclasses com justificativas
SeÃ§Ã£o de habilitaÃ§Ãµes e impugnaÃ§Ãµes pendentes
Assinatura do AJ


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PARTE E â€” API ROUTES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

13) API ROUTES (src/app/api/recuperacao-judicial/)
POST   /api/recuperacao-judicial/cases                    â†’ Criar caso de RJ
GET    /api/recuperacao-judicial/cases                    â†’ Listar casos
GET    /api/recuperacao-judicial/cases/[id]               â†’ Detalhes do caso
PUT    /api/recuperacao-judicial/cases/[id]               â†’ Atualizar caso

POST   /api/recuperacao-judicial/cases/[id]/creditors     â†’ Criar credor
GET    /api/recuperacao-judicial/cases/[id]/creditors     â†’ Listar credores (com filtros)
GET    /api/recuperacao-judicial/cases/[id]/creditors/summary â†’ Resumo/dashboard
PUT    /api/recuperacao-judicial/creditors/[id]           â†’ Atualizar credor
DELETE /api/recuperacao-judicial/creditors/[id]           â†’ Remover credor
POST   /api/recuperacao-judicial/cases/[id]/creditors/import â†’ Importar CSV/Excel
GET    /api/recuperacao-judicial/cases/[id]/creditors/export â†’ Exportar Excel/PDF

POST   /api/recuperacao-judicial/cases/[id]/subclasses    â†’ Criar subclasse
GET    /api/recuperacao-judicial/cases/[id]/subclasses    â†’ Listar subclasses
PUT    /api/recuperacao-judicial/subclasses/[id]          â†’ Atualizar subclasse
DELETE /api/recuperacao-judicial/subclasses/[id]          â†’ Remover subclasse
POST   /api/recuperacao-judicial/subclasses/[id]/validate â†’ Validar STJ
POST   /api/recuperacao-judicial/subclasses/[id]/assign   â†’ Atribuir credores
POST   /api/recuperacao-judicial/cases/[id]/cram-down-risk â†’ AnÃ¡lise risco cram down

POST   /api/recuperacao-judicial/cases/[id]/versions      â†’ Criar versÃ£o do quadro
GET    /api/recuperacao-judicial/cases/[id]/versions      â†’ Listar versÃµes
GET    /api/recuperacao-judicial/versions/[id]            â†’ Ver versÃ£o
GET    /api/recuperacao-judicial/versions/compare         â†’ Comparar versÃµes (?v1=X&v2=Y)

POST   /api/recuperacao-judicial/creditors/[id]/challenges â†’ Criar habilitaÃ§Ã£o/impugnaÃ§Ã£o
GET    /api/recuperacao-judicial/creditors/[id]/challenges â†’ Listar
PUT    /api/recuperacao-judicial/challenges/[id]          â†’ Atualizar

POST   /api/recuperacao-judicial/creditors/[id]/documents â†’ Upload documento
GET    /api/recuperacao-judicial/creditors/[id]/documents â†’ Listar documentos

POST   /api/recuperacao-judicial/calculate/payment-schedule â†’ Calcular cronograma
POST   /api/recuperacao-judicial/calculate/npv            â†’ Calcular NPV
POST   /api/recuperacao-judicial/calculate/rj-vs-bankruptcy â†’ Comparar RJ vs falÃªncia
POST   /api/recuperacao-judicial/calculate/tax-impact     â†’ Impacto tributÃ¡rio do desÃ¡gio

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PARTE F â€” SIDEBAR DO DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

14) INTEGRAÃ‡ÃƒO NO SIDEBAR PRINCIPAL
Adicionar seÃ§Ã£o "RecuperaÃ§Ã£o Judicial" no sidebar do dashboard, abaixo das seÃ§Ãµes existentes:
tsx// SeÃ§Ã£o RJ no sidebar
{
  title: "RecuperaÃ§Ã£o Judicial",
  icon: Scale, // lucide-react
  children: [
    { label: "Quadro de Credores", href: "/dashboard/recuperacao-judicial/quadro-credores", icon: Users },
    { label: "AprovaÃ§Ã£o PRJ", href: "/dashboard/recuperacao-judicial/aprovacao-prj", icon: Vote },
    { label: "NegociaÃ§Ãµes", href: "/dashboard/recuperacao-judicial/negociacoes", icon: Handshake },
  ]
}
Badge no item "Quadro de Credores": mostrar nÂº de impugnaÃ§Ãµes pendentes.
Badge no item "NegociaÃ§Ãµes": mostrar nÂº de propostas pendentes de resposta.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PARTE G â€” VERIFICAÃ‡ÃƒO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

15) VERIFICAÃ‡ÃƒO FINAL
ApÃ³s implementaÃ§Ã£o, verificar:

Schema: npx prisma migrate dev executa sem erro
ImportaÃ§Ã£o CSV: criar CSV com 20 credores de teste â†’ importar â†’ validar dados
Subclasses STJ: criar subclasse sem critÃ©rios objetivos â†’ deve exibir erro de validaÃ§Ã£o
Subclasses STJ: criar subclasse com critÃ©rio potestativo â†’ deve alertar
Cram Down Risk: criar 2 subclasses na Classe III com haircuts de 30% e 80% â†’ deve alertar risco Alto
CÃ¡lculos: NPV de R$ 100.000 com haircut 50%, 10 anos, TR+1% a.a., descontado Ã  Selic 14.25% â†’ resultado deve ser ~R$ 5-8k (centavos por real muito baixo)
Tabela: com 500+ credores a tabela deve rolar suavemente (virtualizaÃ§Ã£o)
Scroll: todos os painÃ©is devem seguir COMANDO-SCROLL-GLOBAL.md
Export Excel: gerar Excel â†’ abrir no Excel/Sheets â†’ formataÃ§Ã£o intacta, fÃ³rmulas funcionam
Versioning: criar versÃ£o â†’ editar credores â†’ criar nova versÃ£o â†’ comparar â†’ diff correto