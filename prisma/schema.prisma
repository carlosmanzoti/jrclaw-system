generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================
// ENUMS
// ============================================================

enum UserRole {
  ADMIN
  SOCIO
  ADVOGADO
  ESTAGIARIO
}

enum PersonType {
  CLIENTE
  PARTE_CONTRARIA
  JUIZ
  DESEMBARGADOR
  PERITO
  ADMINISTRADOR_JUDICIAL
  CREDOR
  TESTEMUNHA
  OUTRO
}

enum PersonSubtype {
  PESSOA_FISICA
  PESSOA_JURIDICA
}

enum PersonSegment {
  AGRO
  INDUSTRIA
  COMERCIO
  SERVICOS
  FINANCEIRO
  GOVERNO
  OUTRO
}

enum PersonDocType {
  CNH
  RG
  CPF
  CNPJ_CARD
  CONTRATO_SOCIAL
  ALTERACAO_CONTRATO_SOCIAL
  PROCURACAO
  IMPOSTO_RENDA
  BALANCO
  DRE
  ESCRITURA
  CERTIDAO
  COMPROVANTE_ENDERECO
  DOCUMENTO_FINANCEIRO
  DOCUMENTO_FISCAL
  OUTRO
}

enum CaseType {
  RECUPERACAO_JUDICIAL
  FALENCIA
  EXECUCAO
  COBRANCA
  REESTRUTURACAO_EXTRAJUDICIAL
  AGRONEGOCIO
  TRABALHISTA
  TRIBUTARIO
  SOCIETARIO
  CONTRATUAL
  OUTRO
}

enum CaseStatus {
  ATIVO
  SUSPENSO
  ARQUIVADO
  ENCERRADO
}

enum CasePartyRole {
  AUTOR
  REU
  TERCEIRO_INTERESSADO
  ASSISTENTE
  LITISCONSORTE
  AMICUS_CURIAE
  ADMINISTRADOR_JUDICIAL
  MINISTERIO_PUBLICO
  OUTRO
}

enum CaseTeamRole {
  RESPONSAVEL
  MEMBRO
  CONSULTOR
  ESTAGIARIO
}

enum DeadlineType {
  FATAL
  ORDINARIO
  DILIGENCIA
  AUDIENCIA
  ASSEMBLEIA
}

enum DeadlineStatus {
  PENDENTE
  CUMPRIDO
  PERDIDO
  CANCELADO
}

enum MovementType {
  DESPACHO
  DECISAO
  SENTENCA
  ACORDAO
  PUBLICACAO
  INTIMACAO
  CITACAO
  ATO_ORDINATORIO
  OUTRO
}

enum DocumentType {
  PETICAO_INICIAL
  CONTESTACAO
  REPLICA
  EMBARGOS_DECLARACAO
  AGRAVO_INSTRUMENTO
  APELACAO
  RECURSO_ESPECIAL
  RECURSO_EXTRAORDINARIO
  CONTRARRAZOES
  MEMORIAIS
  PLANO_RJ
  LISTA_CREDORES
  HABILITACAO_CREDITO
  IMPUGNACAO_CREDITO
  RELATORIO_AJ
  PARECER
  MEMORANDO
  CONTRATO
  PROCURACAO
  NOTIFICACAO
  PROPOSTA
  CONTRAPROPOSTA
  RELATORIO_CLIENTE
  PLANILHA
  EMAIL_SALVO
  ALVARA
  CERTIDAO
  ACORDO
  OUTRO
}

enum TemplateArea {
  RECUPERACAO_JUDICIAL
  FALENCIA
  EXECUCAO
  AGRONEGOCIO
  TRABALHISTA
  TRIBUTARIO
  SOCIETARIO
  CONTRATUAL
  BANCARIO
  GERAL
}

enum ProjectCategory {
  NEGOCIACAO_COMERCIAL
  FECHAMENTO_OPERACAO
  RECUPERACAO_CREDITO
  PLANEJAMENTO_TRIBUTARIO
  ALVARA_LIBERACAO
  DUE_DILIGENCE
  REESTRUTURACAO_SOCIETARIA
  CONSULTORIA_PERMANENTE
  COMPLIANCE
  SUCESSAO_PATRIMONIAL
  OPERACAO_CREDITO_RURAL
  OUTRO
}

enum ProjectStatus {
  PLANEJAMENTO
  EM_ANDAMENTO
  AGUARDANDO_CLIENTE
  AGUARDANDO_TERCEIRO
  AGUARDANDO_ORGAO
  PAUSADO
  CONCLUIDO
  CANCELADO
}

enum Priority {
  CRITICA
  ALTA
  MEDIA
  BAIXA
}

enum ProjectPhaseStatus {
  NAO_INICIADA
  EM_ANDAMENTO
  CONCLUIDA
  BLOQUEADA
}

enum ProjectTaskType {
  DOCUMENTO
  REUNIAO
  DILIGENCIA
  ANALISE
  COMUNICACAO
  COBRANCA
  ACOMPANHAMENTO
  PROTOCOLO
  OBTENCAO_CERTIDAO
  OBTENCAO_ALVARA
  LIBERACAO_VALORES
  NEGOCIACAO
  ASSINATURA
  REGISTRO
  PAGAMENTO
  OUTRO
}

enum ProjectTaskStatus {
  BACKLOG
  A_FAZER
  EM_ANDAMENTO
  EM_REVISAO
  AGUARDANDO
  CONCLUIDA
  CANCELADA
}

enum MilestoneStatus {
  PENDENTE
  ALCANCADO
  ATRASADO
  CANCELADO
}

enum MilestoneImpact {
  CRITICO
  ALTO
  MEDIO
  BAIXO
}

enum CalendarEventType {
  REUNIAO
  AUDIENCIA
  SUSTENTACAO_ORAL
  DESPACHO_ORAL
  PESQUISA_JURIDICA
  ANALISE_CASO
  PRAZO_ANTECIPADO
  PRAZO_FATAL
  RETORNO_EMAIL
  ATIVIDADE_GERAL
}

enum CalendarEventStatus {
  AGENDADO
  EM_ANDAMENTO
  CONCLUIDO
  CANCELADO
}

enum ActivityType {
  REUNIAO
  AUDIENCIA
  SUSTENTACAO
  DESPACHO
  PESQUISA
  ANALISE
  PETICAO
  EMAIL
  TELEFONEMA
  NEGOCIACAO
  DILIGENCIA
  TAREFA_PROJETO
  MARCO_ALCANCADO
  OUTRO
}

enum CreditorClass {
  I_TRABALHISTA
  II_GARANTIA_REAL
  III_QUIROGRAFARIO
  IV_ME_EPP
}

enum CreditorStatus {
  PENDENTE
  HABILITADO
  IMPUGNADO
  RETIFICADO
  EXCLUIDO
}

enum NegotiationStatus {
  PREPARACAO
  EM_CURSO
  PROPOSTA_ENVIADA
  CONTRAPROPOSTA
  ACORDO
  IMPASSE
  ENCERRADA
}

enum StakeholderRole {
  CLIENTE
  PARTE
  CREDOR
  ORGAO_PUBLICO
  BANCO
  NOTARIO
  CONTADOR
  OUTRO
}

enum ProjectTeamRole {
  RESPONSAVEL
  MEMBRO
  CONSULTOR
  ESTAGIARIO
}

enum LibraryEntryType {
  JURISPRUDENCIA
  SUMULA
  DOUTRINA
  ARTIGO
  LEGISLACAO
  MODELO_PECA
  PARECER_INTERNO
  PESQUISA
  TESE
  NOTA_TECNICA
  LIVRO
  ENUNCIADO
  CONTRATO_MODELO
  ESTRATEGIA
  CASO_REFERENCIA
  MATERIAL_ESTUDO
  TABELA_REFERENCIA
  OUTRO
}

// ============================================================
// JUDICIAL RECOVERY (RJ) ENUMS
// ============================================================

enum JRStatus {
  PROCESSAMENTO
  VERIFICACAO_CREDITOS
  AGC_PENDENTE
  PLANO_APROVADO
  CUMPRIMENTO
  ENCERRADA
  CONVOLADA_FALENCIA
}

enum CreditClass {
  CLASSE_I_TRABALHISTA
  CLASSE_II_GARANTIA_REAL
  CLASSE_III_QUIROGRAFARIO
  CLASSE_IV_ME_EPP
}

enum CreditNature {
  TRABALHISTA
  ACIDENTARIO
  HIPOTECA
  PENHOR
  ALIENACAO_FIDUCIARIA_IMOVEL
  ALIENACAO_FIDUCIARIA_MOVEL
  CESSAO_FIDUCIARIA_RECEBIVEIS
  ANTICRESE
  QUIROGRAFARIO
  PRIVILEGIO_ESPECIAL
  PRIVILEGIO_GERAL
  SUBORDINADO
  ME_EPP
}

enum GuaranteeType {
  HIPOTECA
  PENHOR
  ALIENACAO_FIDUCIARIA
  CESSAO_FIDUCIARIA
  ANTICRESE
  NONE
}

enum RJCreditStatus {
  HABILITADO
  HABILITACAO_RETARDATARIA
  IMPUGNADO
  DIVERGENCIA
  EXCLUIDO
  EXTRACONCURSAL
}

enum VoteDirection {
  FAVOR
  CONTRA
  ABSTENCAO
  AUSENTE
}

enum IndexationType {
  TR
  IPCA
  IGP_M
  CDI
  SELIC
  INPC
  SEM_CORRECAO
}

enum CreditorSource {
  MANUAL
  IMPORT_CSV
  IMPORT_EXCEL
  IMPORT_PJE
  HABILITACAO
}

enum SubclassValidation {
  RASCUNHO
  PENDENTE_VALIDACAO
  VALIDADA
  REJEITADA
  REQUER_AJUSTE
}

enum CramDownRisk {
  BAIXO
  MEDIO
  ALTO
  CRITICO
}

enum TableVersionType {
  INICIAL
  AJ_VERIFICACAO
  POS_HABILITACOES
  CONSOLIDADO_AGC
  RETIFICACAO
  HOMOLOGADO
}

enum ChallengeType {
  HABILITACAO
  HABILITACAO_RETARDATARIA
  IMPUGNACAO_CREDOR
  IMPUGNACAO_MP
  IMPUGNACAO_DEVEDOR
  DIVERGENCIA
}

enum ChallengeResolution {
  DEFERIDA
  DEFERIDA_PARCIAL
  INDEFERIDA
  DESISTENCIA
  ACORDO
  PENDENTE
}

enum CreditorDocType {
  CONTRATO
  NOTA_FISCAL
  DUPLICATA
  CCB
  CPR
  SENTENCA_TRABALHISTA
  CERTIDAO_CREDITO
  COMPROVANTE_GARANTIA
  HABILITACAO_PETICAO
  IMPUGNACAO_PETICAO
  PROCURACAO
  OUTROS
}

enum InstallmentStatus {
  PENDENTE
  VENCIDO
  PAGO
  PAGO_PARCIAL
  INADIMPLIDO
}

// ============================================================
// MODELS
// ============================================================

model User {
  id              String   @id @default(cuid())
  name            String
  email           String   @unique
  password        String
  role            UserRole @default(ADVOGADO)
  oab_number      String?
  microsoft_tokens Json?
  avatar_url      String?
  active          Boolean  @default(true)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  // Relations
  cases_responsible    Case[]               @relation("CaseResponsible")
  case_teams           CaseTeam[]
  deadlines            Deadline[]
  documents_created    Document[]
  templates_created    Template[]
  activities           Activity[]
  calendar_events      CalendarEvent[]       @relation("EventResponsible")
  calendar_created     CalendarEvent[]       @relation("EventCreator")
  projects_responsible Project[]             @relation("ProjectResponsible")
  project_teams        ProjectTeam[]
  project_tasks        ProjectTask[]
  task_comments        ProjectTaskComment[]
  task_check_done      ProjectTaskCheckItem[] @relation("CheckItemDoneBy")
  project_notes        ProjectNote[]
  persons_created      Person[]              @relation("PersonCreator")
  person_docs_uploaded PersonDocument[]
  financial_releases_created FinancialRelease[] @relation("FinancialReleaseCreator")
  reports_created      ReportSnapshot[]       @relation("ReportCreator")
  chat_messages        ChatMessage[]
  ai_usage_logs        AIUsageLog[]           @relation("AIUsageLogs")
  library_search_logs  LibrarySearchLog[]     @relation("LibrarySearchLogs")
  strat_neg_responsavel StratNegotiation[] @relation("StratNegResponsavel")
  recovery_cases_responsavel CreditRecoveryCase[] @relation("RecoveryResponsavel")
  recovery_investigations    PatrimonialInvestigation[] @relation("InvestigationResponsavel")
  recovery_actions           CollectionAction[] @relation("CollectionActionResponsavel")
  recovery_agreements        RecoveryAgreement[] @relation("AgreementResponsavel")
  recovery_events            RecoveryEvent[] @relation("RecoveryEventResponsavel")

  @@map("users")
}

model Person {
  id              String        @id @default(cuid())
  tipo            PersonType
  subtipo         PersonSubtype
  nome            String
  razao_social    String?
  cpf_cnpj        String?       @unique
  rg              String?
  orgao_emissor   String?
  nacionalidade   String?
  estado_civil    String?
  profissao       String?
  data_nascimento DateTime?

  // Address
  cep          String?
  logradouro   String?
  numero       String?
  complemento  String?
  bairro       String?
  cidade       String?
  estado       String?
  pais         String?  @default("Brasil")

  // Contacts
  telefone_fixo    String?
  celular          String?
  whatsapp         String?
  email            String?
  email_secundario String?

  // Banking (encrypted in practice)
  banco   String?
  agencia String?
  conta   String?
  pix     String?

  segmento    PersonSegment?
  observacoes String?

  // Portal access
  portal_access   Boolean @default(false)
  portal_password String?

  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  created_by_id String?
  created_by    User?    @relation("PersonCreator", fields: [created_by_id], references: [id])

  // Relations
  person_documents     PersonDocument[]
  case_parties         CaseParty[]
  cases_as_client      Case[]              @relation("CaseClient")
  cases_as_judge       Case[]              @relation("CaseJudge")
  creditors            Creditor[]
  negotiations         Negotiation[]       @relation("NegotiationPerson")
  projects_as_client   Project[]           @relation("ProjectClient")
  project_stakeholders ProjectStakeholder[]
  activities           Activity[]
  financial_releases   FinancialRelease[]
  report_snapshots     ReportSnapshot[]
  rj_creditors         RJCreditor[]             @relation("RJCreditorPerson")
  rj_admin_cases       JudicialRecoveryCase[]   @relation("RJAdminJudicial")
  extraconcursal_creditors ExtraconcursalCreditor[] @relation("ExtraconcursalPerson")
  strat_negotiations StratNegotiation[]    @relation("StratNegPerson")
  recovery_cases_debtor      CreditRecoveryCase[] @relation("RecoveryDebtor")
  joint_debtor_entries       JointDebtor[] @relation("JointDebtorPerson")

  @@map("persons")
}

model PersonDocument {
  id           String        @id @default(cuid())
  person_id    String
  person       Person        @relation(fields: [person_id], references: [id], onDelete: Cascade)
  tipo         PersonDocType
  titulo       String
  arquivo_url  String
  data_validade DateTime?
  observacoes  String?
  uploaded_at  DateTime      @default(now())
  uploaded_by_id String?
  uploaded_by  User?         @relation(fields: [uploaded_by_id], references: [id])

  @@map("person_documents")
}

model Case {
  id               String     @id @default(cuid())
  numero_processo  String?    @unique
  tipo             CaseType
  status           CaseStatus @default(ATIVO)
  fase_processual  String?
  vara             String?
  comarca          String?
  tribunal         String?
  uf               String?
  juiz_id          String?
  juiz             Person?    @relation("CaseJudge", fields: [juiz_id], references: [id])
  valor_causa      Decimal?   @db.Decimal(18, 2)
  valor_risco      Decimal?   @db.Decimal(18, 2)

  cliente_id              String
  cliente                 Person  @relation("CaseClient", fields: [cliente_id], references: [id])
  advogado_responsavel_id String
  advogado_responsavel    User    @relation("CaseResponsible", fields: [advogado_responsavel_id], references: [id])

  projeto_id String?
  projeto    Project? @relation(fields: [projeto_id], references: [id])

  tags String[] @default([])

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  partes        CaseParty[]
  equipe        CaseTeam[]
  prazos        Deadline[]
  documentos    Document[]
  movimentacoes CaseMovement[]
  atividades    Activity[]
  credores      Creditor[]
  negociacoes   Negotiation[]
  calendar_events CalendarEvent[]
  library_entries     LibraryEntry[]      @relation("LibraryCases")
  library_refs        LibraryEntry[]      @relation("LibraryCaseRef")
  financial_releases  FinancialRelease[]
  chat_messages       ChatMessage[]       @relation("ChatMessageCase")
  judicialRecoveryCase JudicialRecoveryCase?
  strat_negotiations  StratNegotiation[]    @relation("StratNegCase")
  recovery_cases             CreditRecoveryCase[] @relation("CaseRecovery")

  @@map("cases")
}

model CaseParty {
  id        String        @id @default(cuid())
  case_id   String
  case_     Case          @relation(fields: [case_id], references: [id], onDelete: Cascade)
  person_id String
  person    Person        @relation(fields: [person_id], references: [id])
  role      CasePartyRole

  @@unique([case_id, person_id, role])
  @@map("case_parties")
}

model CaseTeam {
  id      String       @id @default(cuid())
  case_id String
  case_   Case         @relation(fields: [case_id], references: [id], onDelete: Cascade)
  user_id String
  user    User         @relation(fields: [user_id], references: [id])
  role    CaseTeamRole

  @@unique([case_id, user_id])
  @@map("case_teams")
}

model Deadline {
  id             String         @id @default(cuid())
  case_id        String
  case_          Case           @relation(fields: [case_id], references: [id], onDelete: Cascade)
  tipo           DeadlineType
  descricao      String
  data_limite    DateTime
  data_alerta    DateTime[]
  status         DeadlineStatus @default(PENDENTE)
  responsavel_id String
  responsavel    User           @relation(fields: [responsavel_id], references: [id])
  recorrente     Boolean        @default(false)
  origem         String?
  movimento_id   String?
  lembrete_enviado Boolean      @default(false)
  documento_cumprimento_id String?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("deadlines")
}

model CaseMovement {
  id                String       @id @default(cuid())
  case_id           String
  case_             Case         @relation(fields: [case_id], references: [id], onDelete: Cascade)
  data              DateTime
  tipo              MovementType
  descricao         String
  conteudo_integral String?      @db.Text
  fonte             String?
  fonte_url         String?
  prazo_gerado      Boolean      @default(false)
  notificar_cliente Boolean      @default(false)
  lida              Boolean      @default(false)
  created_at        DateTime     @default(now())

  @@map("case_movements")
}

model Document {
  id               String       @id @default(cuid())
  case_id          String?
  case_            Case?        @relation(fields: [case_id], references: [id])
  person_id        String?
  negotiation_id   String?
  negotiation      Negotiation? @relation(fields: [negotiation_id], references: [id])
  project_id       String?
  project          Project?     @relation(fields: [project_id], references: [id])
  task_id          String?
  task             ProjectTask? @relation(fields: [task_id], references: [id])
  tipo             DocumentType
  titulo           String
  arquivo_url      String?
  versao           Int          @default(1)
  gerado_por_ia    Boolean      @default(false)
  template_id      String?
  criado_por_id    String?
  criado_por       User?        @relation(fields: [criado_por_id], references: [id])
  compartilhado_portal Boolean  @default(false)
  tags             String[]     @default([])
  created_at       DateTime     @default(now())
  updated_at       DateTime     @updatedAt

  @@map("documents")
}

model Template {
  id              String       @id @default(cuid())
  nome            String
  tipo_documento  DocumentType
  area            TemplateArea
  conteudo        String       @db.Text
  variaveis       String[]     @default([])
  prompt_ia       String?      @db.Text
  estrutura_topicos String?    @db.Text
  ativo           Boolean      @default(true)
  created_by_id   String?
  created_by      User?        @relation(fields: [created_by_id], references: [id])
  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt

  @@map("templates")
}

model Creditor {
  id                 String        @id @default(cuid())
  case_id            String
  case_              Case          @relation(fields: [case_id], references: [id], onDelete: Cascade)
  person_id          String
  person             Person        @relation(fields: [person_id], references: [id])
  classe             CreditorClass
  valor_original     Decimal       @db.Decimal(18, 2)
  valor_atualizado   Decimal?      @db.Decimal(18, 2)
  valor_sujeito_plano Decimal?     @db.Decimal(18, 2)
  garantias          String?
  status_credito     CreditorStatus @default(PENDENTE)
  voto               String?
  created_at         DateTime      @default(now())
  updated_at         DateTime      @updatedAt

  @@map("creditors")
}

model Negotiation {
  id                String            @id @default(cuid())
  case_id           String?
  case_             Case?             @relation(fields: [case_id], references: [id])
  project_id        String?
  project           Project?          @relation(fields: [project_id], references: [id])
  creditor_id       String?
  person_id         String?
  person            Person?           @relation("NegotiationPerson", fields: [person_id], references: [id])
  status            NegotiationStatus @default(PREPARACAO)
  timeline_eventos  Json?
  propostas         Json?
  contrapropostas   Json?
  valor_pretendido  Decimal?          @db.Decimal(18, 2)
  valor_proposto    Decimal?          @db.Decimal(18, 2)
  valor_acordado    Decimal?          @db.Decimal(18, 2)
  analise_financeira Json?
  created_at        DateTime          @default(now())
  updated_at        DateTime          @updatedAt

  documents Document[]

  @@map("negotiations")
}

model CalendarEvent {
  id            String              @id @default(cuid())
  case_id       String?
  case_         Case?               @relation(fields: [case_id], references: [id])
  project_id    String?
  project       Project?            @relation(fields: [project_id], references: [id])
  task_id       String?
  task          ProjectTask?        @relation(fields: [task_id], references: [id])
  tipo_evento   CalendarEventType
  titulo        String
  descricao     String?             @db.Text
  data_inicio   DateTime
  data_fim      DateTime?
  dia_inteiro   Boolean             @default(false)
  local         String?
  link_virtual  String?
  campos_especificos Json?
  status        CalendarEventStatus @default(AGENDADO)
  responsavel_id String?
  responsavel   User?               @relation("EventResponsible", fields: [responsavel_id], references: [id])
  participantes_internos String[]   @default([])
  participantes_externos String[]   @default([])
  lembrete_minutos Int?
  recorrencia   Json?
  sincronizado_outlook Boolean      @default(false)
  outlook_event_id     String?
  cor           String?
  created_at    DateTime            @default(now())
  updated_at    DateTime            @updatedAt
  created_by_id String?
  created_by    User?               @relation("EventCreator", fields: [created_by_id], references: [id])

  activities Activity[]

  @@map("calendar_events")
}

model Activity {
  id                String        @id @default(cuid())
  case_id           String?
  case_             Case?         @relation(fields: [case_id], references: [id])
  project_id        String?
  project           Project?      @relation(fields: [project_id], references: [id])
  task_id           String?
  task              ProjectTask?  @relation(fields: [task_id], references: [id])
  calendar_event_id String?
  calendar_event    CalendarEvent? @relation(fields: [calendar_event_id], references: [id])
  person_id         String?
  person            Person?       @relation(fields: [person_id], references: [id])
  user_id           String
  user              User          @relation(fields: [user_id], references: [id])
  tipo              ActivityType
  subtipo           String?
  descricao         String        @db.Text
  data              DateTime
  duracao_minutos   Int?
  resultado         String?       @db.Text
  visivel_portal    Boolean       @default(false)
  faturavel         Boolean       @default(true)
  valor_hora        Decimal?      @db.Decimal(10, 2)
  include_in_report Boolean       @default(true)
  report_priority   Int           @default(0)
  communication_type String?
  recipients        String[]      @default([])
  financial_impact  Decimal?      @db.Decimal(15, 2)
  financial_type    String?
  created_at        DateTime      @default(now())
  updated_at        DateTime      @updatedAt

  @@index([case_id])
  @@index([project_id])
  @@index([person_id])
  @@index([tipo])
  @@index([created_at(sort: Desc)])
  @@map("activities")
}

model FinancialRelease {
  id               String   @id @default(cuid())
  tipo             String   // ALVARA, RPV, PRECATORIO
  numero_referencia String
  case_id          String?
  case_            Case?    @relation(fields: [case_id], references: [id])
  person_id        String?
  person           Person?  @relation(fields: [person_id], references: [id])
  valor            Decimal  @db.Decimal(15, 2)
  status           String   @default("PENDENTE") // PENDENTE, EXPEDIDO, LIBERADO, BLOQUEADO, CANCELADO
  data_prevista    DateTime? @db.Date
  data_liberacao   DateTime? @db.Date
  observacoes      String?  @db.Text
  activity_id      String?
  created_by_id    String?
  created_by       User?    @relation("FinancialReleaseCreator", fields: [created_by_id], references: [id])
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  @@index([person_id])
  @@index([case_id])
  @@index([status])
  @@map("financial_releases")
}

model ReportSnapshot {
  id              String   @id @default(cuid())
  person_id       String
  person          Person   @relation(fields: [person_id], references: [id], onDelete: Cascade)
  period_start    DateTime @db.Date
  period_end      DateTime @db.Date
  executive_summary String? @db.Text
  next_steps      String?  @db.Text
  kpis_data       Json?
  report_data     Json?
  pdf_path        String?
  shared_with_client Boolean @default(false)
  shared_at       DateTime?
  created_by_id   String?
  created_by      User?    @relation("ReportCreator", fields: [created_by_id], references: [id])
  created_at      DateTime @default(now())

  @@index([person_id])
  @@index([period_start, period_end])
  @@map("report_snapshots")
}

model LibraryEntry {
  id              String           @id @default(cuid())
  tipo            LibraryEntryType
  titulo          String
  resumo          String?          @db.Text
  conteudo        String?          @db.Text
  fonte           String?
  url_fonte       String?
  area            TemplateArea?
  tags            String[]         @default([])
  arquivo_url     String?
  relevancia      Int?             @default(0)
  favorito        Boolean          @default(false)
  metadata        Json?
  arquivo_tipo    String?
  arquivo_tamanho Int?
  case_id         String?
  case_           Case?            @relation("LibraryCaseRef", fields: [case_id], references: [id])

  utilizado_em_casos    Case[]    @relation("LibraryCases")
  utilizado_em_projetos Project[] @relation("LibraryProjects")

  created_at    DateTime @default(now())
  updated_at    DateTime @default(now()) @updatedAt
  created_by_id String?

  @@index([tipo])
  @@index([area])
  @@index([case_id])
  @@map("library_entries")
}

// ============================================================
// PROJECT MODULE MODELS
// ============================================================

model Project {
  id          String          @id @default(cuid())
  titulo      String
  codigo      String          @unique
  cliente_id  String
  cliente     Person          @relation("ProjectClient", fields: [cliente_id], references: [id])
  categoria   ProjectCategory
  descricao   String?         @db.Text
  valor_envolvido  Decimal?   @db.Decimal(18, 2)
  valor_honorarios Decimal?   @db.Decimal(18, 2)
  status      ProjectStatus   @default(PLANEJAMENTO)
  prioridade  Priority        @default(MEDIA)
  data_inicio DateTime?
  data_prevista_conclusao DateTime?
  data_conclusao_real     DateTime?
  advogado_responsavel_id String
  advogado_responsavel    User    @relation("ProjectResponsible", fields: [advogado_responsavel_id], references: [id])
  visivel_portal Boolean     @default(false)
  tags         String[]      @default([])
  created_at   DateTime      @default(now())
  updated_at   DateTime      @updatedAt
  created_by_id String?

  // Relations
  equipe          ProjectTeam[]
  stakeholders    ProjectStakeholder[]
  processos       Case[]
  etapas          ProjectPhase[]
  tarefas         ProjectTask[]
  marcos          ProjectMilestone[]
  documentos      Document[]
  atividades      Activity[]
  anotacoes       ProjectNote[]
  despesas        ProjectExpense[]
  negociacoes     Negotiation[]
  calendar_events CalendarEvent[]
  library_entries LibraryEntry[] @relation("LibraryProjects")
  chat_messages   ChatMessage[]  @relation("ChatMessageProject")

  @@map("projects")
}

model ProjectTeam {
  id         String          @id @default(cuid())
  project_id String
  project    Project         @relation(fields: [project_id], references: [id], onDelete: Cascade)
  user_id    String
  user       User            @relation(fields: [user_id], references: [id])
  role       ProjectTeamRole

  @@unique([project_id, user_id])
  @@map("project_teams")
}

model ProjectStakeholder {
  id         String          @id @default(cuid())
  project_id String
  project    Project         @relation(fields: [project_id], references: [id], onDelete: Cascade)
  person_id  String
  person     Person          @relation(fields: [person_id], references: [id])
  role       StakeholderRole

  @@unique([project_id, person_id, role])
  @@map("project_stakeholders")
}

model ProjectPhase {
  id                    String             @id @default(cuid())
  project_id            String
  project               Project            @relation(fields: [project_id], references: [id], onDelete: Cascade)
  titulo                String
  descricao             String?            @db.Text
  ordem                 Int
  status                ProjectPhaseStatus @default(NAO_INICIADA)
  data_inicio_prevista  DateTime?
  data_fim_prevista     DateTime?
  data_inicio_real      DateTime?
  data_fim_real         DateTime?
  percentual_conclusao  Int                @default(0)
  dependencia_fase_id   String?
  dependencia_fase      ProjectPhase?      @relation("PhaseDependency", fields: [dependencia_fase_id], references: [id])
  fases_dependentes     ProjectPhase[]     @relation("PhaseDependency")
  cor                   String?

  tarefas ProjectTask[]

  @@map("project_phases")
}

model ProjectTask {
  id          String            @id @default(cuid())
  project_id  String
  project     Project           @relation(fields: [project_id], references: [id], onDelete: Cascade)
  phase_id    String?
  phase       ProjectPhase?     @relation(fields: [phase_id], references: [id])
  case_id     String?
  titulo      String
  descricao   String?           @db.Text
  tipo        ProjectTaskType   @default(OUTRO)
  status      ProjectTaskStatus @default(BACKLOG)
  prioridade  Priority          @default(MEDIA)
  responsavel_id String?
  responsavel User?             @relation(fields: [responsavel_id], references: [id])
  data_limite DateTime?
  data_alerta DateTime?
  data_conclusao DateTime?
  estimativa_horas Decimal?     @db.Decimal(6, 2)
  horas_gastas     Decimal?     @db.Decimal(6, 2)
  campos_especificos Json?
  dependencia_tarefa_id String?
  dependencia_tarefa    ProjectTask?  @relation("TaskDependency", fields: [dependencia_tarefa_id], references: [id])
  tarefas_dependentes   ProjectTask[] @relation("TaskDependency")
  notificar_cliente Boolean       @default(false)
  created_at  DateTime          @default(now())
  updated_at  DateTime          @updatedAt

  // Relations
  checklist       ProjectTaskCheckItem[]
  comentarios     ProjectTaskComment[]
  documentos      Document[]
  calendar_events CalendarEvent[]
  activities      Activity[]

  @@map("project_tasks")
}

model ProjectTaskCheckItem {
  id             String    @id @default(cuid())
  task_id        String
  task           ProjectTask @relation(fields: [task_id], references: [id], onDelete: Cascade)
  descricao      String
  concluido      Boolean   @default(false)
  concluido_por_id String?
  concluido_por  User?     @relation("CheckItemDoneBy", fields: [concluido_por_id], references: [id])
  concluido_em   DateTime?
  ordem          Int       @default(0)

  @@map("project_task_check_items")
}

model ProjectTaskComment {
  id         String      @id @default(cuid())
  task_id    String
  task       ProjectTask @relation(fields: [task_id], references: [id], onDelete: Cascade)
  user_id    String
  user       User        @relation(fields: [user_id], references: [id])
  conteudo   String      @db.Text
  created_at DateTime    @default(now())

  @@map("project_task_comments")
}

model ProjectMilestone {
  id               String          @id @default(cuid())
  project_id       String
  project          Project         @relation(fields: [project_id], references: [id], onDelete: Cascade)
  titulo           String
  descricao        String?         @db.Text
  data_prevista    DateTime?
  data_alcancada   DateTime?
  status           MilestoneStatus @default(PENDENTE)
  impacto          MilestoneImpact @default(MEDIO)
  notificar_cliente Boolean        @default(false)

  @@map("project_milestones")
}

model ProjectNote {
  id         String   @id @default(cuid())
  project_id String
  project    Project  @relation(fields: [project_id], references: [id], onDelete: Cascade)
  user_id    String
  user       User     @relation(fields: [user_id], references: [id])
  conteudo   String   @db.Text
  fixada     Boolean  @default(false)
  created_at DateTime @default(now())

  @@map("project_notes")
}

model Holiday {
  id   String   @id @default(cuid())
  data DateTime @db.Date
  nome String
  tipo String   // NACIONAL, ESTADUAL, MUNICIPAL
  uf   String?  // null for national, state code for state holidays

  @@unique([data, nome])
  @@map("holidays")
}

model ProjectExpense {
  id              String   @id @default(cuid())
  project_id      String
  project         Project  @relation(fields: [project_id], references: [id], onDelete: Cascade)
  descricao       String
  valor           Decimal  @db.Decimal(18, 2)
  data            DateTime
  categoria       String   // CERTIDAO, REGISTRO, CUSTAS, VIAGEM, PERICIA, OUTRO
  comprovante_url String?
  created_by_id   String?
  created_at      DateTime @default(now())

  @@map("project_expenses")
}

model ProjectTemplate {
  id           String          @id @default(cuid())
  titulo       String
  categoria    ProjectCategory
  descricao    String?         @db.Text
  fases_padrao Json?
  marcos_padrao Json?
  ativo        Boolean         @default(true)
  created_at   DateTime        @default(now())

  @@map("project_templates")
}

// ============================================================
// AI / CONFECÇÃO MODULE MODELS
// ============================================================

model ChatMessage {
  id        String   @id @default(cuid())
  sessionId String
  role      String   // 'user' | 'assistant' | 'system'
  content   String   @db.Text
  metadata  Json?

  caseId    String?
  case_     Case?    @relation("ChatMessageCase", fields: [caseId], references: [id])
  projectId String?
  project   Project? @relation("ChatMessageProject", fields: [projectId], references: [id])
  negotiationId String?
  negotiation   StratNegotiation? @relation("NegChatMessages", fields: [negotiationId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@index([sessionId])
  @@index([caseId])
  @@index([negotiationId])
  @@index([userId])
  @@map("chat_messages")
}

model AIUsageLog {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation("AIUsageLogs", fields: [userId], references: [id])
  actionType String   // 'chat' | 'generate' | 'review'
  docType    String?
  tokensIn   Int      @default(0)
  tokensOut  Int      @default(0)
  model         String
  durationMs    Int      @default(0)
  costEstimated Decimal  @default(0) @db.Decimal(10, 6)
  caseId        String?
  projectId     String?
  negotiationId String?
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@map("ai_usage_logs")
}

model LibrarySearchLog {
  id                    String   @id @default(cuid())
  user_id               String
  user                  User     @relation("LibrarySearchLogs", fields: [user_id], references: [id])
  query                 String   @db.Text
  results_count         Int
  entries_used          String[] @default([])
  document_generated_id String?
  context               String   // CHAT | DOCUMENTO | REVISAO | MANUAL
  created_at            DateTime @default(now())

  @@index([user_id])
  @@index([created_at])
  @@map("library_search_logs")
}

// ============================================================
// JUDICIAL RECOVERY (RJ) MODULE MODELS
// ============================================================

model JudicialRecoveryCase {
  id                    String    @id @default(cuid())
  case_id               String    @unique
  case_                 Case      @relation(fields: [case_id], references: [id], onDelete: Cascade)

  // RJ-specific data
  status_rj             JRStatus  @default(PROCESSAMENTO)
  data_pedido           DateTime?
  data_deferimento      DateTime?
  data_agc              DateTime?
  data_aprovacao_plano  DateTime?
  data_homologacao      DateTime?
  data_encerramento     DateTime?

  // Administrador Judicial
  administrador_judicial_id String?
  administrador_judicial    Person?  @relation("RJAdminJudicial", fields: [administrador_judicial_id], references: [id])

  // Totals (cached, recalculated)
  total_credores        Int       @default(0)
  total_credito         BigInt    @default(0)
  total_classe_i        BigInt    @default(0)
  total_classe_ii       BigInt    @default(0)
  total_classe_iii      BigInt    @default(0)
  total_classe_iv       BigInt    @default(0)

  // Plan info
  plano_versao          Int       @default(0)
  plano_aprovado        Boolean   @default(false)

  observacoes           String?   @db.Text

  created_at            DateTime  @default(now())
  updated_at            DateTime  @updatedAt

  // Relations
  credores              RJCreditor[]
  subclasses            CreditorSubclass[]
  versoes               CreditorTableVersion[]
  impugnacoes           CreditorChallenge[]
  voting_scenarios      VotingScenario[]
  financial_projections FinancialProjection[]
  negotiations          RJNegotiation[]
  extraconcursais       ExtraconcursalCreditor[]
  strat_negotiations  StratNegotiation[]

  @@map("judicial_recovery_cases")
}

model RJCreditor {
  id                    String          @id @default(cuid())
  jrc_id                String
  jrc                   JudicialRecoveryCase @relation(fields: [jrc_id], references: [id], onDelete: Cascade)

  // Identification
  nome                  String
  cpf_cnpj              String?
  pessoa_fisica         Boolean         @default(false)

  // Optional link to Person
  person_id             String?
  person                Person?         @relation("RJCreditorPerson", fields: [person_id], references: [id])

  // Classification
  classe                CreditClass
  natureza              CreditNature
  status                RJCreditStatus  @default(HABILITADO)
  fonte                 CreditorSource  @default(MANUAL)

  // Values (all stored as BigInt centavos for precision)
  valor_original        BigInt          @default(0)
  valor_atualizado      BigInt          @default(0)
  valor_garantia        BigInt          @default(0)
  valor_quirografario   BigInt          @default(0)
  valor_trabalhista_150sm BigInt        @default(0)
  valor_trabalhista_excedente BigInt    @default(0)

  // Guarantee details
  tipo_garantia         GuaranteeType   @default(NONE)
  descricao_garantia    String?         @db.Text
  matricula_imovel      String?
  valor_avaliacao_garantia BigInt       @default(0)

  // Payment terms from plan
  desagio_percentual    Float?
  carencia_meses        Int?
  parcelas              Int?
  indexador             IndexationType?
  juros_percentual      Float?

  // Voting
  voto                  VoteDirection?
  presente_agc          Boolean         @default(false)

  // Subclass
  subclass_id           String?
  subclass              CreditorSubclass? @relation(fields: [subclass_id], references: [id])

  // Metadata
  observacoes           String?         @db.Text
  ordem                 Int             @default(0)

  created_at            DateTime        @default(now())
  updated_at            DateTime        @updatedAt

  // Relations
  documentos            CreditorDocument[]
  impugnacoes           CreditorChallenge[]
  parcelas_pgto         PaymentInstallment[]
  negotiation_creditors NegotiationCreditor[]
  strat_negotiations  StratNegotiation[]

  @@index([jrc_id])
  @@index([classe])
  @@index([status])
  @@index([subclass_id])
  @@map("rj_creditors")
}

model CreditorSubclass {
  id                    String              @id @default(cuid())
  jrc_id                String
  jrc                   JudicialRecoveryCase @relation(fields: [jrc_id], references: [id], onDelete: Cascade)

  nome                  String
  descricao             String?             @db.Text
  classe_base           CreditClass

  // STJ REsp 1.634.844/SP validation
  criterios_objetivos   Json?
  justificativa_interesse_homogeneo String? @db.Text
  protecao_direitos     String?             @db.Text

  // Payment conditions for this subclass
  desagio_percentual    Float?
  carencia_meses        Int?
  parcelas              Int?
  indexador             IndexationType?
  juros_percentual      Float?

  // Validation status
  validacao             SubclassValidation  @default(RASCUNHO)
  validacao_notas       String?             @db.Text
  risco_cram_down       CramDownRisk?

  // Stats (cached)
  total_credores        Int                 @default(0)
  total_valor           BigInt              @default(0)

  ordem                 Int                 @default(0)
  cor                   String?

  created_at            DateTime            @default(now())
  updated_at            DateTime            @updatedAt

  // Relations
  credores              RJCreditor[]

  @@index([jrc_id])
  @@index([classe_base])
  @@map("creditor_subclasses")
}

model CreditorTableVersion {
  id                    String              @id @default(cuid())
  jrc_id                String
  jrc                   JudicialRecoveryCase @relation(fields: [jrc_id], references: [id], onDelete: Cascade)

  versao                Int
  tipo                  TableVersionType
  titulo                String
  descricao             String?             @db.Text

  // Snapshot data
  snapshot_data         Json
  summary_data          Json?

  // Metadata
  publicada             Boolean             @default(false)
  data_publicacao       DateTime?

  created_at            DateTime            @default(now())
  created_by_id         String?

  @@index([jrc_id])
  @@map("creditor_table_versions")
}

model CreditorChallenge {
  id                    String              @id @default(cuid())
  jrc_id                String
  jrc                   JudicialRecoveryCase @relation(fields: [jrc_id], references: [id], onDelete: Cascade)

  creditor_id           String?
  creditor              RJCreditor?         @relation(fields: [creditor_id], references: [id])

  tipo                  ChallengeType
  requerente_nome       String
  requerente_cpf_cnpj   String?

  // Values
  valor_pretendido      BigInt              @default(0)
  classe_pretendida     CreditClass?

  // Resolution
  resolucao             ChallengeResolution @default(PENDENTE)
  valor_reconhecido     BigInt?
  classe_reconhecida    CreditClass?

  // Process info
  numero_processo       String?
  data_protocolo        DateTime?
  data_resolucao        DateTime?
  fundamentacao         String?             @db.Text
  decisao               String?             @db.Text

  created_at            DateTime            @default(now())
  updated_at            DateTime            @updatedAt

  @@index([jrc_id])
  @@index([creditor_id])
  @@map("creditor_challenges")
}

model CreditorDocument {
  id                    String              @id @default(cuid())
  creditor_id           String
  creditor              RJCreditor          @relation(fields: [creditor_id], references: [id], onDelete: Cascade)

  tipo                  CreditorDocType
  titulo                String
  arquivo_url           String?
  observacoes           String?

  uploaded_at           DateTime            @default(now())

  @@index([creditor_id])
  @@map("creditor_documents")
}

model PaymentInstallment {
  id                    String              @id @default(cuid())
  creditor_id           String
  creditor              RJCreditor          @relation(fields: [creditor_id], references: [id], onDelete: Cascade)

  numero                Int
  data_vencimento       DateTime
  valor_principal       BigInt              @default(0)
  valor_juros           BigInt              @default(0)
  valor_correcao        BigInt              @default(0)
  valor_total           BigInt              @default(0)
  valor_pago            BigInt              @default(0)

  status                InstallmentStatus   @default(PENDENTE)
  data_pagamento        DateTime?

  created_at            DateTime            @default(now())

  @@index([creditor_id])
  @@map("payment_installments")
}

// ============================================================
// PRJ APPROVAL MODULE MODELS
// ============================================================

enum ScenarioType {
  BASE
  OTIMISTA
  PESSIMISTA
  CRAM_DOWN
  CUSTOM
}

enum ProjectionStatus {
  RASCUNHO
  EM_ANALISE
  APROVADO
  REJEITADO
}

model VotingScenario {
  id                    String              @id @default(cuid())
  jrc_id                String
  jrc                   JudicialRecoveryCase @relation(fields: [jrc_id], references: [id], onDelete: Cascade)

  nome                  String
  tipo                  ScenarioType        @default(BASE)
  descricao             String?             @db.Text

  // Scenario data: overrides per creditor { creditor_id: { voto, presente_agc } }
  overrides             Json?

  // Computed results (cached)
  resultado             Json?
  aprovado              Boolean?
  cram_down_viavel      Boolean?

  ativo                 Boolean             @default(true)

  created_at            DateTime            @default(now())
  updated_at            DateTime            @updatedAt
  created_by_id         String?

  @@index([jrc_id])
  @@map("voting_scenarios")
}

model FinancialProjection {
  id                    String              @id @default(cuid())
  jrc_id                String
  jrc                   JudicialRecoveryCase @relation(fields: [jrc_id], references: [id], onDelete: Cascade)

  nome                  String
  tipo                  ScenarioType        @default(BASE)
  status                ProjectionStatus    @default(RASCUNHO)

  // Input parameters
  anos_projecao         Int                 @default(5)
  receita_ano_base      BigInt              @default(0)
  taxa_crescimento      Float               @default(0)    // % annual
  margem_ebitda         Float               @default(0)    // %
  capex_percentual      Float               @default(0)    // % of revenue
  capital_giro_pct      Float               @default(0)    // % of revenue
  taxa_desconto         Float               @default(12)   // % annual (WACC)
  aliquota_ir           Float               @default(34)   // IRPJ + CSLL

  // Stress test parameters
  stress_receita        Float?              // % variation
  stress_margem         Float?              // % variation
  stress_juros          Float?              // % variation

  // Computed results (cached as JSON)
  resultado_dre         Json?
  resultado_fluxo_caixa Json?
  resultado_dscr        Json?
  resultado_sensibilidade Json?

  observacoes           String?             @db.Text

  created_at            DateTime            @default(now())
  updated_at            DateTime            @updatedAt
  created_by_id         String?

  @@index([jrc_id])
  @@map("financial_projections")
}

// ============================================================
// NEGOTIATION MODULE — Enums
// ============================================================

enum NegotiationPhase {
  MAPEAMENTO
  CONTATO_INICIAL
  PROPOSTA_ENVIADA
  CONTRAPROPOSTA
  MEDIACAO
  ACORDO_VERBAL
  FORMALIZACAO
  HOMOLOGACAO
  CONCLUIDA
  IMPASSE
}

enum NegotiationPriority {
  CRITICA
  ALTA
  MEDIA
  BAIXA
}

enum CreditorNegotiationStatus {
  NAO_CONTATADO
  EM_CONTATO
  PROPOSTA_RECEBIDA
  CONTRAPROPOSTA_ENVIADA
  EM_MEDIACAO
  ACORDO_PARCIAL
  ACORDO_TOTAL
  RECUSOU
  PARCEIRO
  DESISTIU
}

enum NegActivityType {
  CONTATO_TELEFONICO
  EMAIL_ENVIADO
  EMAIL_RECEBIDO
  REUNIAO_PRESENCIAL
  REUNIAO_VIRTUAL
  PROPOSTA_ENVIADA
  CONTRAPROPOSTA_RECEBIDA
  ACORDO_VERBAL
  ACORDO_FORMALIZADO
  DOCUMENTO_ENVIADO
  DOCUMENTO_RECEBIDO
  MEDIACAO_SESSAO
  OBSERVACAO
}

enum NegTemplateType {
  PROPOSTA_INICIAL
  CONTRAPROPOSTA
  CONVITE_PARCEIRO
  CONVITE_MEDIACAO
  TERMO_ACORDO
  NOTIFICACAO
  LEMBRETE
}

enum CommunicationChannel {
  EMAIL
  WHATSAPP
  TELEFONE
  CARTA
  REUNIAO_PRESENCIAL
  REUNIAO_VIRTUAL
  SISTEMA
}

// ============================================================
// NEGOTIATION MODULE — Models
// ============================================================

model RJNegotiation {
  id                    String              @id @default(cuid())
  jrc_id                String
  jrc                   JudicialRecoveryCase @relation(fields: [jrc_id], references: [id], onDelete: Cascade)

  // Identification
  titulo                String
  descricao             String?             @db.Text
  fase                  NegotiationPhase    @default(MAPEAMENTO)
  prioridade            NegotiationPriority @default(MEDIA)

  // Dates
  data_inicio           DateTime            @default(now())
  data_limite           DateTime?
  data_conclusao        DateTime?

  // Proposal values
  valor_total_original  BigInt              @default(0)
  valor_proposta_atual  BigInt              @default(0)
  desagio_proposto      Float?              // % discount
  carencia_proposta     Int?                // months
  parcelas_propostas    Int?
  juros_proposto        Float?              // % annual

  // Counters (cached)
  total_credores        Int                 @default(0)
  credores_acordados    Int                 @default(0)
  valor_acordado        BigInt              @default(0)

  // Partner program
  programa_parceiro     Boolean             @default(false)
  beneficio_parceiro    String?             @db.Text

  // Mediation
  mediacao_ativa        Boolean             @default(false)
  mediador_nome         String?
  mediador_contato      String?
  proxima_sessao        DateTime?

  observacoes           String?             @db.Text

  created_at            DateTime            @default(now())
  updated_at            DateTime            @updatedAt
  created_by_id         String?

  // Relations
  credores              NegotiationCreditor[]
  atividades            NegotiationActivity[]

  @@index([jrc_id])
  @@index([fase])
  @@map("rj_negotiations")
}

model NegotiationCreditor {
  id                    String                    @id @default(cuid())
  negotiation_id        String
  negotiation           RJNegotiation             @relation(fields: [negotiation_id], references: [id], onDelete: Cascade)

  creditor_id           String
  creditor              RJCreditor                @relation(fields: [creditor_id], references: [id], onDelete: Cascade)

  // Status in this negotiation
  status                CreditorNegotiationStatus @default(NAO_CONTATADO)
  is_parceiro           Boolean                   @default(false)

  // Individual proposal
  valor_original        BigInt                    @default(0)
  valor_proposto        BigInt                    @default(0)
  valor_contraproposta  BigInt?
  valor_acordado        BigInt?
  desagio_individual    Float?
  carencia_individual   Int?
  parcelas_individual   Int?
  juros_individual      Float?

  // Contact info
  ultimo_contato        DateTime?
  proximo_contato       DateTime?
  canal_preferido       CommunicationChannel?
  contato_nome          String?
  contato_email         String?
  contato_telefone      String?

  observacoes           String?                   @db.Text

  created_at            DateTime                  @default(now())
  updated_at            DateTime                  @updatedAt

  @@unique([negotiation_id, creditor_id])
  @@index([negotiation_id])
  @@index([creditor_id])
  @@index([status])
  @@map("negotiation_creditors")
}

model NegotiationActivity {
  id                    String              @id @default(cuid())
  negotiation_id        String
  negotiation           RJNegotiation       @relation(fields: [negotiation_id], references: [id], onDelete: Cascade)

  tipo                  NegActivityType
  canal                 CommunicationChannel?
  descricao             String              @db.Text
  resultado             String?             @db.Text

  // Optional link to specific creditor
  creditor_id           String?
  creditor_nome         String?

  // Attachments (JSON array of { nome, url })
  anexos                Json?

  data_atividade        DateTime            @default(now())
  created_by_id         String?

  created_at            DateTime            @default(now())

  @@index([negotiation_id])
  @@index([data_atividade])
  @@map("negotiation_activities")
}

model NegotiationTemplate {
  id                    String              @id @default(cuid())
  tipo                  NegTemplateType
  titulo                String
  assunto               String?
  conteudo              String              @db.Text
  variaveis             Json?               // available template variables
  canal                 CommunicationChannel?
  ativo                 Boolean             @default(true)

  created_at            DateTime            @default(now())
  updated_at            DateTime            @updatedAt
  created_by_id         String?

  @@map("negotiation_templates")
}

// ===== IMPORTAÇÃO INTELIGENTE =====

enum ImportEntityType {
  PERSON
  CASE
  DEADLINE
  CASE_MOVEMENT
  RJ_CREDITOR
}

enum ImportStatus {
  PENDENTE
  PROCESSANDO
  CONCLUIDO
  CONCLUIDO_PARCIAL
  ERRO
  REVERTIDO
}

model ImportTemplate {
  id              String           @id @default(cuid())
  nome            String
  descricao       String?
  entity_type     ImportEntityType
  field_mapping   Json             // { sourceField: targetField }
  ai_prompt_hint  String?          @db.Text
  ativo           Boolean          @default(true)

  created_at      DateTime         @default(now())
  updated_at      DateTime         @updatedAt
  created_by_id   String?

  import_logs     ImportLog[]

  @@map("import_templates")
}

model ImportLog {
  id              String           @id @default(cuid())
  entity_type     ImportEntityType
  status          ImportStatus     @default(PENDENTE)
  arquivo_nome    String
  arquivo_tipo    String
  total_linhas    Int              @default(0)
  importados      Int              @default(0)
  erros           Int              @default(0)
  ignorados       Int              @default(0)
  detalhes        Json?            // { errors: [], warnings: [], created_ids: [] }
  ai_analysis     Json?
  template_id     String?
  template        ImportTemplate?  @relation(fields: [template_id], references: [id])
  revertido       Boolean          @default(false)

  created_at      DateTime         @default(now())
  created_by_id   String?

  @@index([entity_type])
  @@index([created_at])
  @@map("import_logs")
}

// ===== CREDORES EXTRACONCURSAIS (Art. 49, §3º) =====

enum ExtraconcursalGuaranteeType {
  ALIENACAO_FIDUCIARIA_IMOVEL
  ALIENACAO_FIDUCIARIA_MOVEL
  CESSAO_FIDUCIARIA_RECEBIVEIS
  CESSAO_FIDUCIARIA_DIREITOS_CREDITORIOS
  HIPOTECA
  PENHOR_AGRICOLA
  PENHOR_MERCANTIL
  RESERVA_DOMINIO
  ARRENDAMENTO_MERCANTIL
  CESSAO_FIDUCIARIA_TITULOS
  OUTRO
}

enum BemSituacao {
  EM_POSSE_DEVEDOR
  EM_POSSE_CREDOR
  BUSCA_APREENSAO
  CONSOLIDADO
  LEILAO_AGENDADO
  VENDIDO
  PERECIDO
}

enum ExtraconcursalNegStatus {
  NAO_INICIADA
  EM_NEGOCIACAO
  PROPOSTA_ENVIADA
  CONTRAPROPOSTA
  ACORDO
  EXECUCAO_GARANTIA
  BUSCA_APREENSAO_JUDICIAL
}

enum RiskLevel {
  BAIXO
  MEDIO
  ALTO
  CRITICO
}

enum ImpactLevel {
  NENHUM
  BAIXO
  MEDIO
  ALTO
  CRITICO
}

enum ExtraconcursalEventType {
  CONTATO_INICIAL
  PROPOSTA
  CONTRAPROPOSTA
  REUNIAO
  EMAIL
  TELEFONEMA
  ACORDO
  IMPASSE
  NOTIFICACAO
  BUSCA_APREENSAO
  DECISAO_JUDICIAL
}

model ExtraconcursalCreditor {
  id                        String                    @id @default(cuid())
  jrc_id                    String
  jrc                       JudicialRecoveryCase      @relation(fields: [jrc_id], references: [id], onDelete: Cascade)

  // Optional link to Person
  person_id                 String?
  person                    Person?                   @relation("ExtraconcursalPerson", fields: [person_id], references: [id])

  // Creditor identification
  nome                      String
  cpf_cnpj                  String?

  // Credit values (BigInt centavos)
  valor_total               BigInt                    @default(0)
  valor_garantia            BigInt                    @default(0)
  saldo_devedor             BigInt                    @default(0)

  // Guarantee (art. 49, §3º)
  tipo_garantia             ExtraconcursalGuaranteeType
  descricao_garantia        String                    @db.Text
  matricula_registro        String?
  avaliacao_data            DateTime?
  avaliacao_valor           BigInt                    @default(0)
  avaliacao_responsavel     String?

  // Situação do Bem
  situacao_bem              BemSituacao               @default(EM_POSSE_DEVEDOR)
  localizacao_bem           String?

  // Essencialidade (art. 49, §3º parte final)
  essencial_atividade       Boolean                   @default(false)
  justificativa_essencialidade String?                @db.Text

  // Stay period (art. 6º, §§ 4º e 5º)
  data_deferimento_rj       DateTime?
  prazo_suspensao_fim       DateTime?
  suspensao_ativa           Boolean                   @default(true)

  // Negociação
  status_negociacao         ExtraconcursalNegStatus   @default(NAO_INICIADA)
  rodada_atual              Int                       @default(1)

  // Valores de negociação (BigInt centavos)
  valor_proposto_devedor    BigInt?
  valor_pedido_credor       BigInt?
  valor_acordado            BigInt?
  condicoes_acordo          String?                   @db.Text

  // Risco
  risco_perda_bem           RiskLevel                 @default(MEDIO)
  impacto_operacional       ImpactLevel               @default(MEDIO)

  // Datas
  data_vencimento_original  DateTime?
  data_notificacao_credor   DateTime?

  observacoes               String?                   @db.Text
  created_at                DateTime                  @default(now())
  updated_at                DateTime                  @updatedAt

  // Relations
  eventos                   ExtraconcursalNegotiationEvent[]

  @@index([jrc_id])
  @@index([tipo_garantia])
  @@index([status_negociacao])
  @@map("extraconcursal_creditors")
}

model ExtraconcursalNegotiationEvent {
  id                        String                    @id @default(cuid())
  extraconcursal_creditor_id String
  creditor                  ExtraconcursalCreditor    @relation(fields: [extraconcursal_creditor_id], references: [id], onDelete: Cascade)

  rodada                    Int                       @default(1)
  data                      DateTime                  @default(now())
  tipo                      ExtraconcursalEventType
  descricao                 String                    @db.Text
  valor_proposto            BigInt?
  responsavel_id            String?
  documento_id              String?

  created_at                DateTime                  @default(now())

  @@index([extraconcursal_creditor_id])
  @@map("extraconcursal_negotiation_events")
}

// ============================================================
// SUPER MÓDULO DE NEGOCIAÇÃO ESTRATÉGICA
// Harvard, Voss, Camp, Karrass, Game Theory
// ============================================================

enum StratNegType {
  INDIVIDUAL
  COLETIVA_CLASSE
  COLETIVA_COMITE
  EXTRAJUDICIAL
}

enum StratNegPhase {
  PREPARACAO
  ENGAJAMENTO
  BARGANHA
  COMPROMISSO
  ENCERRADA
}

enum StratNegStatus {
  NAO_INICIADA
  EM_ANDAMENTO
  PROPOSTA_ENVIADA
  CONTRAPROPOSTA
  IMPASSE
  ACORDO
  FRACASSADA
}

enum StratNegPriority {
  CRITICA
  ALTA
  MEDIA
  BAIXA
}

enum TKIProfile {
  COMPETITIVO
  COLABORATIVO
  COMPROMISSO
  EVITATIVO
  ACOMODATIVO
}

enum VossNegotiatorType {
  ANALISTA
  ACOMODADOR
  ASSERTIVO
}

enum GameType {
  SOMA_ZERO
  SOMA_POSITIVA
  DILEMA_PRISIONEIRO
}

enum GameEquilibrium {
  REESTRUTURACAO
  LIQUIDACAO
  HOLDOUT
}

enum GameCoalition {
  FAVORAVEL
  NEUTRO
  OPOSICAO
  LIDER_OPOSICAO
}

enum RoundStatus {
  ABERTA
  ENCERRADA_ACORDO
  ENCERRADA_IMPASSE
  ENCERRADA_ADIADA
}

enum StratEventType {
  REUNIAO
  TELEFONEMA
  EMAIL
  PROPOSTA
  CONTRAPROPOSTA
  ACORDO
  IMPASSE
  NOTIFICACAO
  DECISAO_JUDICIAL
  ASSEMBLEIA
  MEDIACAO
  ANALISE_IA
}

enum EventChannel {
  PRESENCIAL
  VIDEO
  TELEFONE
  EMAIL_CANAL
  WHATSAPP
  CARTA
  OFICIO
}

enum Sentiment {
  POSITIVO
  NEUTRO
  NEGATIVO
  HOSTIL
}

enum ProposalOrigin {
  DEVEDOR
  CREDOR
  MEDIADOR
}

enum ProposalStatus {
  RASCUNHO
  ENVIADA
  RECEBIDA
  ACEITA
  REJEITADA
  CONTRAPROPOSTA_STATUS
}

enum ConcessionDirection {
  DADA
  RECEBIDA
}

// ========== STRATEGIC NEGOTIATION ==========

model StratNegotiation {
  id                    String            @id @default(cuid())
  case_id               String?
  jrc_id                String?
  creditor_id           String?
  person_id             String?

  titulo                String
  codigo                String            @unique
  tipo                  StratNegType      @default(INDIVIDUAL)
  fase                  StratNegPhase     @default(PREPARACAO)
  status                StratNegStatus    @default(NAO_INICIADA)
  prioridade            StratNegPriority  @default(MEDIA)

  valor_credito         BigInt            @default(0)
  valor_meta_acordo     BigInt?
  valor_proposta_atual  BigInt?
  valor_pedido_credor   BigInt?
  valor_acordado        BigInt?
  haircut_percentual    Float?

  interesses_devedor    Json?
  interesses_credor     Json?
  batna_devedor         Json?
  batna_credor          Json?
  zopa_min              BigInt?
  zopa_max              BigInt?
  opcoes_criativas      Json?
  criterios_legitimidade Json?

  tki_perfil_credor     TKIProfile?
  tki_assertividade     Int?
  tki_cooperatividade   Int?
  tki_estrategia_recomendada String?

  voss_empatia_tatica   Json?
  voss_acusation_audit  Json?
  voss_calibrated_questions Json?
  voss_black_swans      Json?
  voss_tipo_negociador  VossNegotiatorType?

  camp_missao           String?           @db.Text
  camp_budget_tempo     Int?
  camp_budget_energia   Int?
  camp_budget_dinheiro  Int?
  camp_budget_emocao    Int?
  camp_decisores        Json?

  karrass_poder_score   Json?

  game_tipo_jogo        GameType?
  game_equilibrio       GameEquilibrium?
  game_shapley_value    Float?
  game_poder_voto       Float?
  game_risco_holdout    RiskLevel?
  game_coalicao         GameCoalition?

  data_inicio           DateTime?
  data_limite           DateTime?
  data_acordo           DateTime?
  data_proxima_acao     DateTime?
  proxima_acao          String?

  responsavel_id        String?
  observacoes           String?           @db.Text

  // AI-generated fields
  health_score          Int?
  health_score_details  Json?
  probability_acordo    Float?
  haircut_estimado_min  Float?
  haircut_estimado_max  Float?
  tempo_estimado_dias   Int?
  ai_proxima_acao       String?           @db.Text
  ai_insights           Json?
  ai_playbook           Json?
  ai_last_analysis      DateTime?

  created_at            DateTime          @default(now())
  updated_at            DateTime          @updatedAt

  case_                 Case?             @relation("StratNegCase", fields: [case_id], references: [id])
  jrc                   JudicialRecoveryCase? @relation(fields: [jrc_id], references: [id])
  rj_creditor           RJCreditor?       @relation(fields: [creditor_id], references: [id])
  person                Person?           @relation("StratNegPerson", fields: [person_id], references: [id])
  responsavel           User?             @relation("StratNegResponsavel", fields: [responsavel_id], references: [id])

  eventos               StratNegEvent[]
  rodadas               StratNegRound[]
  concessoes            StratNegConcession[]
  propostas             StratNegProposal[]
  one_sheets            StratNegOneSheet[]
  ai_insights_list      NegAIInsight[]
  chat_messages         ChatMessage[]     @relation("NegChatMessages")

  @@index([case_id])
  @@index([jrc_id])
  @@index([fase])
  @@index([status])
  @@map("strat_negotiations")
}

// ========== NEGOTIATION ROUND ==========

model StratNegRound {
  id                    String       @id @default(cuid())
  negotiation_id        String
  numero                Int
  titulo                String?
  status                RoundStatus  @default(ABERTA)
  data_inicio           DateTime
  data_fim              DateTime?

  valor_proposto_devedor BigInt?
  valor_pedido_credor    BigInt?
  resultado              String?     @db.Text

  ackerman_target       BigInt?
  ackerman_seq          Json?
  ackerman_passo        Int?

  observacoes           String?      @db.Text
  created_at            DateTime     @default(now())

  negotiation           StratNegotiation @relation(fields: [negotiation_id], references: [id], onDelete: Cascade)
  eventos               StratNegEvent[]

  @@index([negotiation_id])
  @@map("strat_neg_rounds")
}

// ========== NEGOTIATION EVENT ==========

model StratNegEvent {
  id                String          @id @default(cuid())
  negotiation_id    String
  round_id          String?

  data              DateTime
  tipo              StratEventType
  canal             EventChannel?

  descricao         String          @db.Text
  participantes     Json?
  valor_mencionado  BigInt?

  tecnicas_usadas   Json?
  sentimento        Sentiment?
  insights          String?         @db.Text

  documento_id      String?
  responsavel_id    String?
  created_at        DateTime        @default(now())

  negotiation       StratNegotiation @relation(fields: [negotiation_id], references: [id], onDelete: Cascade)
  round             StratNegRound?  @relation(fields: [round_id], references: [id])

  @@index([negotiation_id])
  @@index([round_id])
  @@map("strat_neg_events")
}

// ========== PROPOSAL ==========

model StratNegProposal {
  id                    String         @id @default(cuid())
  negotiation_id        String
  tipo                  ProposalOrigin
  numero                Int
  data                  DateTime

  valor_principal       BigInt
  haircut_pct           Float?
  taxa_juros            Float?
  carencia_meses        Int?
  prazo_pagamento_meses Int?
  parcelas              Int?

  debt_equity_swap      Boolean        @default(false)
  equity_pct            Float?
  warrants              Boolean        @default(false)
  pik_toggle            Boolean        @default(false)
  contingent_value      Boolean        @default(false)
  condicoes_especiais   String?        @db.Text

  npv_devedor           BigInt?
  npv_credor            BigInt?
  taxa_desconto         Float?
  recovery_rate         Float?

  status                ProposalStatus @default(RASCUNHO)
  justificativa         String?        @db.Text
  documento_id          String?

  created_at            DateTime       @default(now())

  negotiation           StratNegotiation @relation(fields: [negotiation_id], references: [id], onDelete: Cascade)

  @@index([negotiation_id])
  @@map("strat_neg_proposals")
}

// ========== CONCESSION (Karrass) ==========

model StratNegConcession {
  id                String              @id @default(cuid())
  negotiation_id    String
  data              DateTime
  direcao           ConcessionDirection
  descricao         String              @db.Text
  valor_impacto     BigInt?
  justificativa     String              @db.Text
  contrapartida     String?             @db.Text

  created_at        DateTime            @default(now())

  negotiation       StratNegotiation    @relation(fields: [negotiation_id], references: [id], onDelete: Cascade)

  @@index([negotiation_id])
  @@map("strat_neg_concessions")
}

// ========== ONE-SHEET (Voss) ==========

model StratNegOneSheet {
  id                   String           @id @default(cuid())
  negotiation_id       String

  objetivo_especifico  String           @db.Text
  resumo_situacao      String           @db.Text
  labels_preparados    Json
  accusation_audit     Json
  calibrated_questions Json
  ofertas_nao_monetarias Json?
  black_swans_investigar Json?

  reuniao_data         DateTime?
  reuniao_local        String?
  preparado_por        String?

  created_at           DateTime         @default(now())

  negotiation          StratNegotiation @relation(fields: [negotiation_id], references: [id], onDelete: Cascade)

  @@index([negotiation_id])
  @@map("strat_neg_one_sheets")
}

// ========== NEGOTIATION AI INSIGHT ==========

model NegAIInsight {
  id              String           @id @default(cuid())
  negotiation_id  String?
  tipo            String           // OPORTUNIDADE, RISCO, SUGESTAO, ANALISE, ALERTA, CROSS_NEG, BRIEFING, DEBRIEFING, PRECEDENTE
  titulo          String
  descricao       String           @db.Text
  detalhes        Json?
  acao_sugerida   String?          @db.Text
  framework       String?          // HARVARD, VOSS, TKI, CAMP, KARRASS, GAME_THEORY
  prioridade      String?          // CRITICA, ALTA, MEDIA, BAIXA
  lido            Boolean          @default(false)
  aplicado        Boolean          @default(false)
  expires_at      DateTime?

  created_at      DateTime         @default(now())

  negotiation     StratNegotiation? @relation(fields: [negotiation_id], references: [id], onDelete: Cascade)

  @@index([negotiation_id])
  @@index([tipo])
  @@index([created_at])
  @@map("neg_ai_insights")
}

// ============================================================
// MÓDULO DE RECUPERAÇÃO DE CRÉDITO
// ============================================================

model CreditRecoveryCase {
  id                    String   @id @default(cuid())
  case_id               String?
  person_id             String?

  codigo                String   @unique
  titulo                String
  tipo                  String   // CUMPRIMENTO_SENTENCA, EXECUCAO_TITULO_EXTRAJUDICIAL, EXECUCAO_FISCAL, MONITORIA, BUSCA_APREENSAO, COBRANCA_EXTRAJUDICIAL
  fase                  String   // INVESTIGACAO, PRE_JUDICIAL, EXECUCAO, PENHORA, EXPROPRIACAO, ACORDO, ENCERRADO
  status                String   // ATIVO, SUSPENSO, ACORDO_PARCIAL, ACORDO_TOTAL, PRESCRITO, FRUSTRADO, ENCERRADO_SATISFEITO, ENCERRADO_INSATISFEITO
  prioridade            String   // CRITICA, ALTA, MEDIA, BAIXA

  valor_original        Float
  valor_atualizado      Float?
  valor_honorarios      Float?
  valor_custas          Float?
  valor_total_execucao  Float?
  valor_recuperado      Float?
  valor_bloqueado       Float?
  valor_penhorado       Float?
  percentual_recuperado Float?

  titulo_tipo           String?  // SENTENCA, CHEQUE, NOTA_PROMISSORIA, DUPLICATA, ESCRITURA_PUBLICA, CONTRATO, CDA, CCB, CPR, DEBENTURE
  titulo_numero         String?
  titulo_data_vencimento DateTime?
  titulo_data_prescricao DateTime?

  devedor_nome          String?
  devedor_cpf_cnpj      String?
  devedor_tipo          String?  // PF, PJ
  devedor_endereco      String?
  devedor_telefone      String?
  devedor_email         String?
  devedor_atividade     String?

  score_recuperacao     Int?
  score_fatores         Json?
  risco_prescricao      String?
  risco_insolvencia     String?
  estrategia_ia         String?  @db.Text

  data_constituicao     DateTime?
  data_vencimento       DateTime?
  data_distribuicao     DateTime?
  data_citacao          DateTime?
  data_penhora          DateTime?
  data_acordo           DateTime?
  data_encerramento     DateTime?
  data_proxima_acao     DateTime?
  proxima_acao          String?

  responsavel_id        String?
  observacoes           String?  @db.Text

  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  case_                 Case?    @relation("CaseRecovery", fields: [case_id], references: [id])
  person                Person?  @relation("RecoveryDebtor", fields: [person_id], references: [id])
  responsavel           User?    @relation("RecoveryResponsavel", fields: [responsavel_id], references: [id])
  investigacoes         PatrimonialInvestigation[]
  bens                  AssetFound[]
  acoes_cobranca        CollectionAction[]
  penhoras              Penhora[]
  acordos               RecoveryAgreement[]
  incidentes_desconsidera DesconsideracaoIncident[]
  monitoramentos        DebtorMonitoring[]
  eventos               RecoveryEvent[]
  devedores_solidarios  JointDebtor[]

  @@index([case_id])
  @@index([person_id])
  @@index([fase])
  @@index([status])
  @@map("credit_recovery_cases")
}

model PatrimonialInvestigation {
  id                    String   @id @default(cuid())
  recovery_case_id      String

  codigo                String   @unique
  tipo                  String   // COMPLETA, COMPLEMENTAR, ATUALIZACAO, URGENTE
  status                String   // SOLICITADA, EM_ANDAMENTO, CONCLUIDA, CANCELADA
  fase                  String   // PLANEJAMENTO, BUSCA_PUBLICA, BUSCA_JUDICIAL, BUSCA_PRIVADA, OSINT, ANALISE, RELATORIO

  investigar_imoveis    Boolean  @default(true)
  investigar_veiculos   Boolean  @default(true)
  investigar_contas     Boolean  @default(true)
  investigar_empresas   Boolean  @default(true)
  investigar_socios     Boolean  @default(true)
  investigar_grupo_eco  Boolean  @default(true)
  investigar_crypto     Boolean  @default(false)
  investigar_exterior   Boolean  @default(false)
  investigar_osint      Boolean  @default(false)

  total_bens_encontrados Int?
  valor_total_estimado  Float?
  valor_penhoravel_estimado Float?
  patrimonio_visivel    Float?
  patrimonio_oculto_est Float?

  red_flags             Json?
  indicio_fraude        Boolean  @default(false)
  indicio_ocultacao     Boolean  @default(false)
  indicio_grupo_eco     Boolean  @default(false)

  data_solicitacao      DateTime
  data_inicio           DateTime?
  data_conclusao        DateTime?
  prazo_estimado        DateTime?

  responsavel_id        String?
  relatorio_doc_id      String?
  observacoes           String?  @db.Text

  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  recovery_case         CreditRecoveryCase @relation(fields: [recovery_case_id], references: [id], onDelete: Cascade)
  responsavel           User?    @relation("InvestigationResponsavel", fields: [responsavel_id], references: [id])
  buscas                AssetSearch[]
  bens                  AssetFound[]

  @@index([recovery_case_id])
  @@map("patrimonial_investigations")
}

model AssetSearch {
  id                    String   @id @default(cuid())
  investigation_id      String
  recovery_case_id      String?

  sistema               String   // SISBAJUD, RENAJUD, INFOJUD, SNIPER, CNIB, CRI, JUNTA_COMERCIAL, DETRAN, RECEITA_FEDERAL, SERASA, BOA_VISTA, NEOWAY, CNIS_INSS, TSE, ANAC, TRIB_MARITIMO, CCS_BACEN, CENSEC, OSINT_SOCIAL, OSINT_GOOGLE, CRIPTOJUD
  tipo_consulta         String   // INFORMACAO, BLOQUEIO, DESBLOQUEIO, TRANSFERENCIA, RESTRICAO, PENHORA_REGISTRO, TEIMOSINHA

  cpf_cnpj_consultado   String
  nome_consultado       String?
  data_consulta         DateTime
  data_resposta         DateTime?

  status                String   // SOLICITADA, PENDENTE, RESPONDIDA, SEM_RESULTADO, ERRO, PARCIAL
  resultado_resumo      String?  @db.Text
  resultado_detalhado   Json?
  valor_encontrado      Float?
  valor_bloqueado       Float?
  qtd_resultados        Int?

  numero_processo       String?
  numero_ordem_judicial String?
  juizo                 String?

  teimosinha_ativa      Boolean  @default(false)
  teimosinha_dias       Int?
  teimosinha_inicio     DateTime?
  teimosinha_fim        DateTime?
  teimosinha_reiteracoes Int?

  observacoes           String?  @db.Text
  created_at            DateTime @default(now())

  investigation         PatrimonialInvestigation @relation(fields: [investigation_id], references: [id], onDelete: Cascade)

  @@index([investigation_id])
  @@index([sistema])
  @@map("asset_searches")
}

model AssetFound {
  id                    String   @id @default(cuid())
  recovery_case_id      String
  investigation_id      String?

  tipo                  String   // IMOVEL_URBANO, IMOVEL_RURAL, VEICULO, CONTA_BANCARIA, APLICACAO_FINANCEIRA, PARTICIPACAO_SOCIETARIA, CREDITO_JUDICIAL, MARCA_PATENTE, AERONAVE, EMBARCACAO, MAQUINARIO, SEMOVENTE, CRIPTOATIVO, DIREITO_CREDITORIO, PRECATORIO, OUTROS
  subtipo               String?

  descricao             String
  identificador         String?
  localizacao           String?

  valor_estimado        Float?
  valor_avaliacao       Float?
  valor_mercado         Float?
  valor_liquidacao      Float?

  status                String   // LOCALIZADO, VERIFICANDO, CONFIRMADO, PENHORADO, BLOQUEADO, INDISPONIVEL, ARREMATADO, ADJUDICADO, LIBERADO, BEM_FAMILIA, IMPENHORAVEL, GRAVADO, ALIENADO
  penhoravel            Boolean  @default(true)
  motivo_impenhoravel   String?

  titular_nome          String?
  titular_cpf_cnpj      String?
  titular_relacao       String?  // DEVEDOR, CONJUGE, SOCIO, EMPRESA, LARANJA, TERCEIRO

  onus                  Json?
  possui_onus           Boolean  @default(false)

  data_localizacao      DateTime
  data_penhora          DateTime?
  data_avaliacao        DateTime?
  data_expropriacao     DateTime?

  fonte                 String?
  documento_id          String?
  observacoes           String?  @db.Text

  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  recovery_case         CreditRecoveryCase @relation(fields: [recovery_case_id], references: [id], onDelete: Cascade)
  investigation         PatrimonialInvestigation? @relation(fields: [investigation_id], references: [id])
  penhora               Penhora?

  @@index([recovery_case_id])
  @@index([tipo])
  @@map("assets_found")
}

model CollectionAction {
  id                    String   @id @default(cuid())
  recovery_case_id      String

  tipo                  String   // NOTIFICACAO_EXTRAJUDICIAL, PROTESTO, NEGATIVACAO, MEDIACAO, PETICAO_INICIAL, CITACAO, PENHORA_ONLINE, ARRESTO, SEQUESTRO, AVALIACAO, LEILAO, ADJUDICACAO, IDPJ, ACAO_PAULIANA, FRAUDE_EXECUCAO, HABILITACAO_CREDITO, RECURSO, EMBARGOS, IMPUGNACAO, ACORDO, CUMPRIMENTO_ACORDO, PARCELAMENTO_916
  categoria             String   // EXTRAJUDICIAL, JUDICIAL_CONHECIMENTO, JUDICIAL_EXECUCAO, CAUTELAR, INCIDENTAL, RECURSAL, ACORDO

  descricao             String   @db.Text
  data_acao             DateTime
  data_prazo            DateTime?
  data_resultado        DateTime?

  status                String   // PLANEJADA, EM_EXECUCAO, AGUARDANDO_RESPOSTA, DEFERIDA, INDEFERIDA, CUMPRIDA, FRUSTRADA, CANCELADA
  resultado             String?  @db.Text
  valor_envolvido       Float?
  valor_obtido          Float?

  protesto_cartorio     String?
  protesto_protocolo    String?
  protesto_data_intimacao DateTime?
  protesto_data_lavratura DateTime?
  protesto_pago         Boolean?

  negativacao_bureau    String?
  negativacao_protocolo String?
  negativacao_data_inclusao DateTime?
  negativacao_data_exclusao DateTime?

  leilao_leiloeiro      String?
  leilao_data_1praca    DateTime?
  leilao_data_2praca    DateTime?
  leilao_valor_minimo   Float?
  leilao_valor_arrematacao Float?
  leilao_arrematante    String?
  leilao_comissao       Float?

  documento_id          String?
  responsavel_id        String?
  observacoes           String?  @db.Text

  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  recovery_case         CreditRecoveryCase @relation(fields: [recovery_case_id], references: [id], onDelete: Cascade)
  responsavel           User?    @relation("CollectionActionResponsavel", fields: [responsavel_id], references: [id])

  @@index([recovery_case_id])
  @@index([tipo])
  @@map("collection_actions")
}

model Penhora {
  id                    String   @id @default(cuid())
  recovery_case_id      String
  asset_id              String?  @unique

  tipo                  String   // ONLINE_SISBAJUD, IMOVEL, VEICULO, FATURAMENTO, ROSTO_AUTOS, ACOES, RECEBIVEIS, SEMOVENTES, CRIPTOATIVOS
  status                String   // SOLICITADA, EFETIVADA, PARCIAL, IMPUGNADA, MANTIDA, REDUZIDA, SUBSTITUIDA, CANCELADA, CONVERTIDA_RENDA, LIBERADA

  valor_solicitado      Float?
  valor_efetivado       Float?
  valor_excesso         Float?

  data_solicitacao      DateTime
  data_efetivacao       DateTime?
  data_intimacao_devedor DateTime?
  data_impugnacao       DateTime?
  data_decisao_impugnacao DateTime?

  auto_penhora_numero   String?
  depositario_nome      String?
  depositario_cpf       String?

  avaliacao_valor       Float?
  avaliacao_data        DateTime?
  avaliacao_por         String?

  numero_processo       String?
  observacoes           String?  @db.Text

  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  recovery_case         CreditRecoveryCase @relation(fields: [recovery_case_id], references: [id], onDelete: Cascade)
  asset                 AssetFound? @relation(fields: [asset_id], references: [id])

  @@index([recovery_case_id])
  @@map("penhoras")
}

model RecoveryAgreement {
  id                    String   @id @default(cuid())
  recovery_case_id      String

  tipo                  String   // PAGAMENTO_INTEGRAL, PARCELAMENTO, DACAO_PAGAMENTO, DESCONTO, NOVACAO, TRANSACAO
  status                String   // PROPOSTA, NEGOCIANDO, FORMALIZADO, EM_CUMPRIMENTO, CUMPRIDO, DESCUMPRIDO, RESCINDIDO

  valor_divida_original Float
  valor_acordo          Float
  desconto_percentual   Float?
  entrada               Float?
  parcelas              Int?
  valor_parcela         Float?
  taxa_juros_mensal     Float?
  dia_vencimento        Int?

  dacao_bem_descricao   String?
  dacao_bem_valor       Float?

  parcelas_pagas        Int?     @default(0)
  valor_pago_total      Float?   @default(0)
  parcelas_atraso       Int?     @default(0)
  data_ultima_parcela   DateTime?
  proxima_parcela       DateTime?

  data_proposta         DateTime
  data_formalizacao     DateTime?
  data_inicio_pagamento DateTime?
  data_ultima_cobranca  DateTime?

  clausulas_especiais   String?  @db.Text
  documento_id          String?
  responsavel_id        String?

  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  recovery_case         CreditRecoveryCase @relation(fields: [recovery_case_id], references: [id], onDelete: Cascade)
  responsavel           User?    @relation("AgreementResponsavel", fields: [responsavel_id], references: [id])
  parcelas_detalhes     AgreementInstallment[]

  @@index([recovery_case_id])
  @@map("recovery_agreements")
}

model AgreementInstallment {
  id                    String   @id @default(cuid())
  agreement_id          String

  numero                Int
  valor                 Float
  data_vencimento       DateTime
  data_pagamento        DateTime?
  valor_pago            Float?
  status                String   // PENDENTE, PAGA, ATRASADA, PAGA_COM_ATRASO, RENEGOCIADA
  dias_atraso           Int?
  multa_atraso          Float?
  comprovante_id        String?

  created_at            DateTime @default(now())
  agreement             RecoveryAgreement @relation(fields: [agreement_id], references: [id], onDelete: Cascade)

  @@index([agreement_id])
  @@map("agreement_installments")
}

model DesconsideracaoIncident {
  id                    String   @id @default(cuid())
  recovery_case_id      String

  tipo                  String   // DIRETA, INVERSA, EXTENSAO_GRUPO_ECONOMICO
  teoria                String   // MAIOR_CC50, MENOR_CDC28, TRABALHISTA_CLT2, AMBIENTAL
  status                String   // ANALISE_VIABILIDADE, PREPARANDO, PETICIONADO, CITADO, RESPONDIDO, INSTRUINDO, DEFERIDO, INDEFERIDO, RECURSO

  fundamento_legal      String
  hipotese              String   // DESVIO_FINALIDADE, CONFUSAO_PATRIMONIAL, OBSTACULO_CDC, GRUPO_ECONOMICO

  evidencias            Json?
  confusao_patrimonial  Json?
  desvio_finalidade     Json?

  alvos                 Json?

  valor_alcancado       Float?
  decisao_resumo        String?  @db.Text
  data_decisao          DateTime?
  recurso               String?

  data_peticao          DateTime?
  data_citacao_alvos    DateTime?
  data_resposta         DateTime?
  prazo_resposta        DateTime?

  documento_peticao_id  String?
  numero_incidente      String?

  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  recovery_case         CreditRecoveryCase @relation(fields: [recovery_case_id], references: [id], onDelete: Cascade)

  @@index([recovery_case_id])
  @@map("desconsideracao_incidents")
}

model JointDebtor {
  id                    String   @id @default(cuid())
  recovery_case_id      String
  person_id             String?

  nome                  String
  cpf_cnpj              String?
  tipo_responsabilidade String   // DEVEDOR_PRINCIPAL, AVALISTA, FIADOR, SOCIO, ADMINISTRADOR, GRUPO_ECONOMICO, SUCESSOR, CONJUGE
  fundamentacao         String?  @db.Text

  patrimonio_estimado   Float?
  status                String   // IDENTIFICADO, NOTIFICADO, CITADO, EXECUTANDO, ACORDO, INSOLVENTE

  created_at            DateTime @default(now())

  recovery_case         CreditRecoveryCase @relation(fields: [recovery_case_id], references: [id], onDelete: Cascade)
  person                Person?  @relation("JointDebtorPerson", fields: [person_id], references: [id])

  @@index([recovery_case_id])
  @@map("joint_debtors")
}

model DebtorMonitoring {
  id                    String   @id @default(cuid())
  recovery_case_id      String

  tipo                  String   // PROCESSO_JUDICIAL, DIARIO_OFICIAL, CREDITO_BUREAU, PATRIMONIO, SOCIETARIO, REDES_SOCIAIS, CERTIDAO_PROTESTO
  fonte                 String   // DATAJUD, JUDIT, ESCAVADOR, SERASA, NEOWAY, ARISP, CENPROT, MANUAL

  ativo                 Boolean  @default(true)
  frequencia            String   // TEMPO_REAL, DIARIO, SEMANAL, MENSAL

  ultima_verificacao    DateTime?
  ultimo_resultado      Json?
  alertas_pendentes     Int?     @default(0)

  configuracao          Json?
  webhook_url           String?

  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  recovery_case         CreditRecoveryCase @relation(fields: [recovery_case_id], references: [id], onDelete: Cascade)
  alertas               MonitoringAlert[]

  @@index([recovery_case_id])
  @@map("debtor_monitorings")
}

model MonitoringAlert {
  id                    String   @id @default(cuid())
  monitoring_id         String

  tipo                  String   // NOVO_BEM, BEM_ALIENADO, NOVO_PROCESSO, FALENCIA, RECUPERACAO_JUDICIAL, MUDANCA_SOCIETARIA, NOVO_EMPREGO, SCORE_ALTERADO, PROTESTO_PAGO, PUBLICACAO_DO, ESTILO_VIDA
  severidade            String   // CRITICA, ALTA, MEDIA, BAIXA, INFO

  titulo                String
  descricao             String   @db.Text
  dados                 Json?

  lido                  Boolean  @default(false)
  acao_tomada           String?  @db.Text
  data_acao             DateTime?

  created_at            DateTime @default(now())

  monitoring            DebtorMonitoring @relation(fields: [monitoring_id], references: [id], onDelete: Cascade)

  @@index([monitoring_id])
  @@map("monitoring_alerts")
}

model RecoveryEvent {
  id                    String   @id @default(cuid())
  recovery_case_id      String

  data                  DateTime
  tipo                  String   // NOTA, REUNIAO, TELEFONEMA, EMAIL, WHATSAPP, DESPACHO, DECISAO, SENTENCA, PETICAO, AUDIENCIA, DILIGENCIA, PUBLICACAO, ALERTA_IA, MUDANCA_FASE

  descricao             String   @db.Text
  valor_mencionado      Float?
  responsavel_id        String?
  documento_id          String?

  analise_ia            String?  @db.Text
  sentimento            String?  // POSITIVO, NEUTRO, NEGATIVO
  acao_recomendada      String?  @db.Text

  created_at            DateTime @default(now())

  recovery_case         CreditRecoveryCase @relation(fields: [recovery_case_id], references: [id], onDelete: Cascade)
  responsavel           User?    @relation("RecoveryEventResponsavel", fields: [responsavel_id], references: [id])

  @@index([recovery_case_id])
  @@map("recovery_events")
}
