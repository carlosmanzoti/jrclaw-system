generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================
// ENUMS
// ============================================================

enum UserRole {
  ADMIN
  SOCIO
  ADVOGADO
  ESTAGIARIO
}

enum PersonType {
  CLIENTE
  PARTE_CONTRARIA
  JUIZ
  DESEMBARGADOR
  PERITO
  ADMINISTRADOR_JUDICIAL
  CREDOR
  TESTEMUNHA
  OUTRO
}

enum PersonSubtype {
  PESSOA_FISICA
  PESSOA_JURIDICA
}

enum PersonSegment {
  AGRO
  INDUSTRIA
  COMERCIO
  SERVICOS
  FINANCEIRO
  GOVERNO
  OUTRO
}

enum PersonDocType {
  CNH
  RG
  CPF
  CNPJ_CARD
  CONTRATO_SOCIAL
  ALTERACAO_CONTRATO_SOCIAL
  PROCURACAO
  IMPOSTO_RENDA
  BALANCO
  DRE
  ESCRITURA
  CERTIDAO
  COMPROVANTE_ENDERECO
  DOCUMENTO_FINANCEIRO
  DOCUMENTO_FISCAL
  OUTRO
}

enum CaseType {
  RECUPERACAO_JUDICIAL
  FALENCIA
  EXECUCAO
  COBRANCA
  REESTRUTURACAO_EXTRAJUDICIAL
  AGRONEGOCIO
  TRABALHISTA
  TRIBUTARIO
  SOCIETARIO
  CONTRATUAL
  OUTRO
}

enum CaseStatus {
  ATIVO
  SUSPENSO
  ARQUIVADO
  ENCERRADO
}

enum CasePartyRole {
  AUTOR
  REU
  TERCEIRO_INTERESSADO
  ASSISTENTE
  LITISCONSORTE
  AMICUS_CURIAE
  ADMINISTRADOR_JUDICIAL
  MINISTERIO_PUBLICO
  OUTRO
}

enum CaseTeamRole {
  RESPONSAVEL
  MEMBRO
  CONSULTOR
  ESTAGIARIO
}

enum DeadlineType {
  // PRAZOS DE DEFESA E RESPOSTA
  CONTESTACAO
  RECONVENCAO
  REPLICA
  IMPUGNACAO_VALOR_CAUSA
  IMPUGNACAO_JUSTICA_GRATUITA
  IMPUGNACAO_CUMPRIMENTO
  EXCECAO_PRE_EXECUTIVIDADE
  EMBARGOS_EXECUCAO
  EMBARGOS_TERCEIRO
  EMBARGOS_DECLARACAO
  MANIFESTACAO
  ESPECIFICACAO_PROVAS

  // PRAZOS RECURSAIS
  APELACAO
  CONTRARRAZOES_APELACAO
  AGRAVO_INSTRUMENTO
  CONTRARRAZOES_AGRAVO
  AGRAVO_INTERNO
  RECURSO_ORDINARIO
  RECURSO_ESPECIAL
  CONTRARRAZOES_RESP
  RECURSO_EXTRAORDINARIO
  CONTRARRAZOES_RE
  EMBARGOS_DIVERGENCIA
  RECURSO_REVISTA
  RECURSO_ORDINARIO_TRABALHISTA
  AGRAVO_PETICAO
  RECLAMACAO

  // PRAZOS FATAIS E PEREMPTÓRIOS
  PRAZO_FATAL
  ACAO_RESCISORIA
  MANDADO_SEGURANCA
  HABEAS_CORPUS

  // AUDIÊNCIAS E SESSÕES
  AUDIENCIA_CONCILIACAO
  AUDIENCIA_INSTRUCAO
  AUDIENCIA_SANEAMENTO
  SUSTENTACAO_ORAL
  ASSEMBLEIA_CREDORES
  MEDIACAO
  DEPOIMENTO_PESSOAL

  // RECUPERAÇÃO JUDICIAL (Lei 11.101/2005)
  RJ_STAY_PERIOD
  RJ_APRESENTACAO_PLANO
  RJ_OBJECAO_PLANO
  RJ_HABILITACAO_CREDITO
  RJ_IMPUGNACAO_CREDITO
  RJ_DIVERGENCIA_CREDITO
  RJ_PRESTACAO_CONTAS_AJ
  RJ_CUMPRIMENTO_PLANO

  // EXECUÇÃO E CUMPRIMENTO
  PAGAMENTO_VOLUNTARIO
  PENHORA
  ADJUDICACAO
  DEPOSITO_JUDICIAL
  PRESTACAO_CONTAS
  LEILAO
  HASTA_PUBLICA

  // ADMINISTRATIVO E DILIGÊNCIAS
  DILIGENCIA
  PROTOCOLO
  JUNTADA_DOCUMENTO
  JUNTADA_PROCURACAO
  SUBSTABELECIMENTO
  CARGA_AUTOS
  PERICIA
  LAUDO_PERICIAL
  QUESITOS
  CUMPRIMENTO_DECISAO
  EMENDA_INICIAL
  COMPLEMENTACAO_CUSTAS

  // EXTRAJUDICIAIS E CONTRATUAIS
  NOTIFICACAO_EXTRAJUDICIAL
  VENCIMENTO_CONTRATO
  PRAZO_REGULATORIO
  PRAZO_ADMINISTRATIVO

  // TRIBUTÁRIOS
  IMPUGNACAO_AUTO_INFRACAO
  RECURSO_ADMINISTRATIVO_FISCAL
  PARCELAMENTO

  // TAREFAS INTERNAS
  TAREFA_INTERNA
  FOLLOW_UP
  REUNIAO_INTERNA
  RETORNO_CLIENTE
  RETORNO_EMAIL

  OUTRO
}

enum DeadlineCategory {
  DEFESA_RESPOSTA
  RECURSAL
  FATAL_PEREMPTORIO
  AUDIENCIA_SESSAO
  RECUPERACAO_JUDICIAL
  EXECUCAO_CUMPRIMENTO
  ADMINISTRATIVO_DILIGENCIA
  EXTRAJUDICIAL_CONTRATUAL
  TRIBUTARIO
  TAREFA_INTERNA
  OUTRO
}

enum CountingType {
  DIAS_UTEIS
  DIAS_CORRIDOS
  HORAS
  SEM_PRAZO
}

enum PieceType {
  // Decisões judiciais
  SENTENCA
  SENTENCA_CONDENATORIA
  SENTENCA_TERMINATIVA
  DECISAO_INTERLOCUTORIA
  DESPACHO
  ACORDAO
  DECISAO_MONOCRATICA

  // Citações e intimações
  CITACAO
  INTIMACAO_GENERICA
  INTIMACAO_SENTENCA
  INTIMACAO_DECISAO
  INTIMACAO_ACORDAO
  INTIMACAO_DESPACHO
  INTIMACAO_PERICIA
  INTIMACAO_CUMPRIMENTO
  INTIMACAO_PENHORA

  // Peças da parte contrária
  CONTESTACAO_RECEBIDA
  RECONVENCAO_RECEBIDA
  APELACAO_RECEBIDA
  AGRAVO_RECEBIDO
  RESP_RECEBIDO
  RE_RECEBIDO
  IMPUGNACAO_RECEBIDA
  EMBARGOS_EXEC_RECEBIDOS

  // Atos processuais
  AUDIENCIA_DESIGNADA
  PERICIA_DESIGNADA
  LEILAO_DESIGNADO

  // RJ
  RJ_DEFERIMENTO
  RJ_PUBLICACAO_EDITAL
  RJ_PUBLICACAO_QUADRO
  RJ_PLANO_APRESENTADO
  RJ_AGC_DESIGNADA

  // Mandado de segurança
  MS_ATO_COATOR

  // Genéricos
  PUBLICACAO_DJE
  MOVIMENTACAO_GENERICA
}

enum PartyRole {
  AUTOR
  REU
  AMBOS
  TERCEIRO
  CLIENTE
}

enum DeadlineStartMethod {
  PUBLICACAO_DJE
  INTIMACAO_PESSOAL
  INTIMACAO_ELETRONICA
  INTIMACAO_CORREIO
  INTIMACAO_EDITAL
  COMPARECIMENTO_ESPONTANEO
  AUDIENCIA
  CARGA_AUTOS
  DATA_FIXA
  MANUAL
}

enum DeadlineOrigin {
  MANUAL
  EMAIL
  PROCESSO
  MONITORAMENTO
  IMPORTACAO
  MOVIMENTACAO
  IA
}

enum DeadlineStatus {
  PENDENTE
  CUMPRIDO
  PERDIDO
  CANCELADO
}

enum MovementType {
  DESPACHO
  DECISAO
  SENTENCA
  ACORDAO
  PUBLICACAO
  INTIMACAO
  CITACAO
  ATO_ORDINATORIO
  OUTRO
}

enum DocumentType {
  PETICAO_INICIAL
  CONTESTACAO
  REPLICA
  EMBARGOS_DECLARACAO
  AGRAVO_INSTRUMENTO
  APELACAO
  RECURSO_ESPECIAL
  RECURSO_EXTRAORDINARIO
  CONTRARRAZOES
  MEMORIAIS
  PLANO_RJ
  LISTA_CREDORES
  HABILITACAO_CREDITO
  IMPUGNACAO_CREDITO
  RELATORIO_AJ
  PARECER
  MEMORANDO
  CONTRATO
  PROCURACAO
  NOTIFICACAO
  PROPOSTA
  CONTRAPROPOSTA
  RELATORIO_CLIENTE
  PLANILHA
  EMAIL_SALVO
  ALVARA
  CERTIDAO
  ACORDO
  OUTRO
}

enum TemplateArea {
  RECUPERACAO_JUDICIAL
  FALENCIA
  EXECUCAO
  AGRONEGOCIO
  TRABALHISTA
  TRIBUTARIO
  SOCIETARIO
  CONTRATUAL
  BANCARIO
  GERAL
}

enum ProjectCategory {
  NEGOCIACAO_COMERCIAL
  FECHAMENTO_OPERACAO
  RECUPERACAO_CREDITO
  PLANEJAMENTO_TRIBUTARIO
  ALVARA_LIBERACAO
  DUE_DILIGENCE
  REESTRUTURACAO_SOCIETARIA
  CONSULTORIA_PERMANENTE
  COMPLIANCE
  SUCESSAO_PATRIMONIAL
  OPERACAO_CREDITO_RURAL
  OUTRO
}

enum ProjectStatus {
  PLANEJAMENTO
  EM_ANDAMENTO
  AGUARDANDO_CLIENTE
  AGUARDANDO_TERCEIRO
  AGUARDANDO_ORGAO
  PAUSADO
  CONCLUIDO
  CANCELADO
}

enum Priority {
  CRITICA
  ALTA
  MEDIA
  BAIXA
}

enum ProjectPhaseStatus {
  NAO_INICIADA
  EM_ANDAMENTO
  CONCLUIDA
  BLOQUEADA
}

enum ProjectTaskType {
  DOCUMENTO
  REUNIAO
  DILIGENCIA
  ANALISE
  COMUNICACAO
  COBRANCA
  ACOMPANHAMENTO
  PROTOCOLO
  OBTENCAO_CERTIDAO
  OBTENCAO_ALVARA
  LIBERACAO_VALORES
  NEGOCIACAO
  ASSINATURA
  REGISTRO
  PAGAMENTO
  OUTRO
}

enum ProjectTaskStatus {
  BACKLOG
  A_FAZER
  EM_ANDAMENTO
  EM_REVISAO
  AGUARDANDO
  CONCLUIDA
  CANCELADA
}

enum MilestoneStatus {
  PENDENTE
  ALCANCADO
  ATRASADO
  CANCELADO
}

enum MilestoneImpact {
  CRITICO
  ALTO
  MEDIO
  BAIXO
}

enum CalendarEventType {
  REUNIAO
  AUDIENCIA
  SUSTENTACAO_ORAL
  DESPACHO_ORAL
  PESQUISA_JURIDICA
  ANALISE_CASO
  PRAZO_ANTECIPADO
  PRAZO_FATAL
  RETORNO_EMAIL
  ATIVIDADE_GERAL
}

enum CalendarEventStatus {
  AGENDADO
  EM_ANDAMENTO
  CONCLUIDO
  CANCELADO
}

enum ActivityType {
  REUNIAO
  AUDIENCIA
  SUSTENTACAO
  DESPACHO
  PESQUISA
  ANALISE
  PETICAO
  EMAIL
  TELEFONEMA
  NEGOCIACAO
  DILIGENCIA
  TAREFA_PROJETO
  MARCO_ALCANCADO
  OUTRO
}

enum CreditorClass {
  I_TRABALHISTA
  II_GARANTIA_REAL
  III_QUIROGRAFARIO
  IV_ME_EPP
}

enum CreditorStatus {
  PENDENTE
  HABILITADO
  IMPUGNADO
  RETIFICADO
  EXCLUIDO
}

enum NegotiationStatus {
  PREPARACAO
  EM_CURSO
  PROPOSTA_ENVIADA
  CONTRAPROPOSTA
  ACORDO
  IMPASSE
  ENCERRADA
}

enum StakeholderRole {
  CLIENTE
  PARTE
  CREDOR
  ORGAO_PUBLICO
  BANCO
  NOTARIO
  CONTADOR
  OUTRO
}

enum ProjectTeamRole {
  RESPONSAVEL
  MEMBRO
  CONSULTOR
  ESTAGIARIO
}

enum LibraryEntryType {
  JURISPRUDENCIA
  SUMULA
  DOUTRINA
  ARTIGO
  LEGISLACAO
  MODELO_PECA
  PARECER_INTERNO
  PESQUISA
  TESE
  NOTA_TECNICA
  LIVRO
  ENUNCIADO
  CONTRATO_MODELO
  ESTRATEGIA
  CASO_REFERENCIA
  MATERIAL_ESTUDO
  TABELA_REFERENCIA
  OUTRO
}

// ============================================================
// JUDICIAL RECOVERY (RJ) ENUMS
// ============================================================

enum JRStatus {
  PROCESSAMENTO
  VERIFICACAO_CREDITOS
  AGC_PENDENTE
  PLANO_APROVADO
  CUMPRIMENTO
  ENCERRADA
  CONVOLADA_FALENCIA
}

enum CreditClass {
  CLASSE_I_TRABALHISTA
  CLASSE_II_GARANTIA_REAL
  CLASSE_III_QUIROGRAFARIO
  CLASSE_IV_ME_EPP
}

enum CreditNature {
  TRABALHISTA
  ACIDENTARIO
  HIPOTECA
  PENHOR
  PENHOR_RURAL
  ALIENACAO_FIDUCIARIA_IMOVEL
  ALIENACAO_FIDUCIARIA_MOVEL
  CESSAO_FIDUCIARIA_RECEBIVEIS
  ANTICRESE
  WARRANT
  QUIROGRAFARIO
  PRIVILEGIO_ESPECIAL
  PRIVILEGIO_GERAL
  SUBORDINADO
  ME_EPP
  A_DEFINIR
}

enum GuaranteeType {
  HIPOTECA
  PENHOR
  ALIENACAO_FIDUCIARIA
  CESSAO_FIDUCIARIA
  ANTICRESE
  NONE
}

enum RJCreditStatus {
  HABILITADO
  HABILITACAO_RETARDATARIA
  IMPUGNADO
  DIVERGENCIA
  EXCLUIDO
  EXTRACONCURSAL
}

enum VoteDirection {
  FAVOR
  CONTRA
  ABSTENCAO
  AUSENTE
}

enum IndexationType {
  TR
  IPCA
  IGP_M
  CDI
  SELIC
  INPC
  SEM_CORRECAO
}

enum CreditorSource {
  MANUAL
  IMPORT_CSV
  IMPORT_EXCEL
  IMPORT_PJE
  HABILITACAO
}

enum SubclassValidation {
  RASCUNHO
  PENDENTE_VALIDACAO
  VALIDADA
  REJEITADA
  REQUER_AJUSTE
}

enum CramDownRisk {
  BAIXO
  MEDIO
  ALTO
  CRITICO
}

enum TableVersionType {
  INICIAL
  AJ_VERIFICACAO
  POS_HABILITACOES
  CONSOLIDADO_AGC
  RETIFICACAO
  HOMOLOGADO
}

enum ChallengeType {
  HABILITACAO
  HABILITACAO_RETARDATARIA
  IMPUGNACAO_CREDOR
  IMPUGNACAO_MP
  IMPUGNACAO_DEVEDOR
  DIVERGENCIA
}

enum ChallengeResolution {
  DEFERIDA
  DEFERIDA_PARCIAL
  INDEFERIDA
  DESISTENCIA
  ACORDO
  PENDENTE
}

enum CreditorDocType {
  CONTRATO
  NOTA_FISCAL
  DUPLICATA
  CCB
  CPR
  SENTENCA_TRABALHISTA
  CERTIDAO_CREDITO
  COMPROVANTE_GARANTIA
  HABILITACAO_PETICAO
  IMPUGNACAO_PETICAO
  PROCURACAO
  OUTROS
}

enum InstallmentStatus {
  PENDENTE
  VENCIDO
  PAGO
  PAGO_PARCIAL
  INADIMPLIDO
}

// ============================================================
// EMAIL ACTIVITY ENUMS
// ============================================================

enum EmailActivityType {
  PRAZO
  AUDIENCIA
  REUNIAO
  DESPACHO
  DILIGENCIA
  PETICAO
  RECURSO
  PROVIDENCIA
  OUTRO
}

enum EmailActivityStatus {
  PENDENTE
  EM_ANDAMENTO
  CONCLUIDO
  CANCELADO
}

enum DeadlineCountType {
  DIAS_UTEIS
  DIAS_CORRIDOS
}

enum ReminderChannel {
  SISTEMA
  EMAIL
  WHATSAPP
}

// ============================================================
// MODELS
// ============================================================

model User {
  id              String   @id @default(cuid())
  name            String
  email           String   @unique
  password        String
  role            UserRole @default(ADVOGADO)
  oab_number      String?
  microsoft_tokens Json?
  avatar_url      String?
  active          Boolean  @default(true)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  // Relations
  cases_responsible    Case[]               @relation("CaseResponsible")
  case_teams           CaseTeam[]
  deadlines            Deadline[]
  documents_created    Document[]
  templates_created    Template[]
  activities           Activity[]
  calendar_events      CalendarEvent[]       @relation("EventResponsible")
  calendar_created     CalendarEvent[]       @relation("EventCreator")
  projects_responsible Project[]             @relation("ProjectResponsible")
  project_teams        ProjectTeam[]
  project_tasks        ProjectTask[]
  task_comments        ProjectTaskComment[]
  task_check_done      ProjectTaskCheckItem[] @relation("CheckItemDoneBy")
  project_notes        ProjectNote[]
  persons_created      Person[]              @relation("PersonCreator")
  person_docs_uploaded PersonDocument[]
  financial_releases_created FinancialRelease[] @relation("FinancialReleaseCreator")
  reports_created      ReportSnapshot[]       @relation("ReportCreator")
  chat_messages        ChatMessage[]
  ai_usage_logs        AIUsageLog[]           @relation("AIUsageLogs")
  library_search_logs  LibrarySearchLog[]     @relation("LibrarySearchLogs")
  strat_neg_responsavel StratNegotiation[] @relation("StratNegResponsavel")
  recovery_cases_responsavel CreditRecoveryCase[] @relation("RecoveryResponsavel")
  recovery_investigations    PatrimonialInvestigation[] @relation("InvestigationResponsavel")
  recovery_actions           CollectionAction[] @relation("CollectionActionResponsavel")
  recovery_agreements        RecoveryAgreement[] @relation("AgreementResponsavel")
  recovery_events            RecoveryEvent[] @relation("RecoveryEventResponsavel")
  deadline_responsavel       DeadlineNew[] @relation("deadline_responsavel")
  deadline_backup            DeadlineNew[] @relation("deadline_backup")
  microsoft_account          MicrosoftAccount?
  email_links                EmailLink[]
  email_activities_responsible EmailActivity[] @relation("ActivityResponsible")
  email_activities_created     EmailActivity[] @relation("ActivityCreator")
  crj_negotiations_assigned    CRJNegotiation[] @relation("CRJNegAssignee")
  crj_events                   CRJNegotiationEvent[] @relation("CRJEventUser")
  requestedInvestigations      Investigation[] @relation("InvestigationRequester")
  assignedInvestigations       Investigation[] @relation("InvestigationAssignee")
  investigationQueries         InvestigationQuery[] @relation("InvestigationQueryExecutor")
  investigationReports         InvestigationReport[] @relation("InvestigationReportGenerator")
  teamMember               TeamMember?

  @@map("users")
}

model Person {
  id              String        @id @default(cuid())
  tipo            PersonType
  subtipo         PersonSubtype
  nome            String
  razao_social    String?
  cpf_cnpj        String?       @unique
  rg              String?
  orgao_emissor   String?
  nacionalidade   String?
  estado_civil    String?
  profissao       String?
  data_nascimento DateTime?

  // Address
  cep          String?
  logradouro   String?
  numero       String?
  complemento  String?
  bairro       String?
  cidade       String?
  estado       String?
  pais         String?  @default("Brasil")

  // Contacts
  telefone_fixo    String?
  celular          String?
  whatsapp         String?
  email            String?
  email_secundario String?

  // Banking (encrypted in practice)
  banco   String?
  agencia String?
  conta   String?
  pix     String?

  segmento    PersonSegment?
  observacoes String?

  // Portal access
  portal_access   Boolean @default(false)
  portal_password String?

  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  created_by_id String?
  created_by    User?    @relation("PersonCreator", fields: [created_by_id], references: [id])

  // Relations
  person_documents     PersonDocument[]
  case_parties         CaseParty[]
  cases_as_client      Case[]              @relation("CaseClient")
  cases_as_judge       Case[]              @relation("CaseJudge")
  creditors            Creditor[]
  negotiations         Negotiation[]       @relation("NegotiationPerson")
  projects_as_client   Project[]           @relation("ProjectClient")
  project_stakeholders ProjectStakeholder[]
  activities           Activity[]
  financial_releases   FinancialRelease[]
  report_snapshots     ReportSnapshot[]
  rj_creditors         RJCreditor[]             @relation("RJCreditorPerson")
  rj_admin_cases       JudicialRecoveryCase[]   @relation("RJAdminJudicial")
  extraconcursal_creditors ExtraconcursalCreditor[] @relation("ExtraconcursalPerson")
  strat_negotiations StratNegotiation[]    @relation("StratNegPerson")
  recovery_cases_debtor      CreditRecoveryCase[] @relation("RecoveryDebtor")
  joint_debtor_entries       JointDebtor[] @relation("JointDebtorPerson")
  process_parties            ProcessParty[]
  whatsapp_conversations     WhatsAppConversation[]
  portal_messages            PortalMessage[]
  deadlines                  Deadline[]       @relation("ClientDeadlines")
  relatedPersons             ClientRelatedPerson[] @relation("ClientRelatedPersons")
  linkedAsRelated            ClientRelatedPerson[] @relation("LinkedRelatedPerson")

  // Patrimony relations
  ruralProperties            ClientRuralProperty[]           @relation("ClientRuralProperties")
  agriculturalProductions    ClientAgriculturalProduction[]   @relation("ClientProductions")
  urbanProperties            ClientUrbanProperty[]            @relation("ClientUrbanProperties")
  vehicles                   ClientVehicle[]                  @relation("ClientVehicles")
  corporateParticipations    ClientCorporateParticipation[]   @relation("ClientParticipations")
  financialData              ClientFinancialData[]            @relation("ClientFinancials")
  operationalData            ClientOperationalData[]          @relation("ClientOperational")

  @@map("persons")
}

model PersonDocument {
  id           String        @id @default(cuid())
  person_id    String
  person       Person        @relation(fields: [person_id], references: [id], onDelete: Cascade)
  tipo         PersonDocType
  titulo       String
  arquivo_url  String
  data_validade DateTime?
  observacoes  String?
  uploaded_at  DateTime      @default(now())
  uploaded_by_id String?
  uploaded_by  User?         @relation(fields: [uploaded_by_id], references: [id])

  @@map("person_documents")
}

model Case {
  id               String     @id @default(cuid())
  numero_processo  String?    @unique
  tipo             CaseType
  status           CaseStatus @default(ATIVO)
  fase_processual  String?
  vara             String?
  comarca          String?
  tribunal         String?
  uf               String?
  juiz_id          String?
  juiz             Person?    @relation("CaseJudge", fields: [juiz_id], references: [id])
  valor_causa      Decimal?   @db.Decimal(18, 2)
  valor_risco      Decimal?   @db.Decimal(18, 2)

  cliente_id              String
  cliente                 Person  @relation("CaseClient", fields: [cliente_id], references: [id])
  advogado_responsavel_id String
  advogado_responsavel    User    @relation("CaseResponsible", fields: [advogado_responsavel_id], references: [id])

  projeto_id String?
  projeto    Project? @relation(fields: [projeto_id], references: [id])

  tags String[] @default([])

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  partes        CaseParty[]
  equipe        CaseTeam[]
  prazos        Deadline[]
  documentos    Document[]
  movimentacoes CaseMovement[]
  atividades    Activity[]
  credores      Creditor[]
  negociacoes   Negotiation[]
  calendar_events CalendarEvent[]
  library_entries     LibraryEntry[]      @relation("LibraryCases")
  library_refs        LibraryEntry[]      @relation("LibraryCaseRef")
  financial_releases  FinancialRelease[]
  fees                Fee[]
  expenses            Expense[]
  chat_messages       ChatMessage[]       @relation("ChatMessageCase")
  judicialRecoveryCase JudicialRecoveryCase?
  strat_negotiations  StratNegotiation[]    @relation("StratNegCase")
  recovery_cases             CreditRecoveryCase[] @relation("CaseRecovery")
  deadlines_new              DeadlineNew[]
  process_parties            ProcessParty[]
  email_links                EmailLink[]
  email_activities           EmailActivity[]
  whatsapp_conversations     WhatsAppConversation[]
  investigations             Investigation[] @relation("InvestigationCase")
  courtId                    String?
  court                      Court?          @relation("CourtCases", fields: [courtId], references: [id])
  caseJudges                 CaseJudge[]
  caseAdministrators         CaseAdministrator[]

  @@map("cases")
}

model CaseParty {
  id        String        @id @default(cuid())
  case_id   String
  case_     Case          @relation(fields: [case_id], references: [id], onDelete: Cascade)
  person_id String
  person    Person        @relation(fields: [person_id], references: [id])
  role      CasePartyRole

  @@unique([case_id, person_id, role])
  @@map("case_parties")
}

model CaseTeam {
  id      String       @id @default(cuid())
  case_id String
  case_   Case         @relation(fields: [case_id], references: [id], onDelete: Cascade)
  user_id String
  user    User         @relation(fields: [user_id], references: [id])
  role    CaseTeamRole

  @@unique([case_id, user_id])
  @@map("case_teams")
}

model Deadline {
  id             String         @id @default(cuid())

  // Vinculação obrigatória (nullable no Prisma, obrigatório no Zod/frontend)
  clientId       String?
  client         Person?        @relation("ClientDeadlines", fields: [clientId], references: [id])
  case_id        String?
  case_          Case?          @relation(fields: [case_id], references: [id], onDelete: Cascade)
  projectId      String?

  // Tipo e metadados
  tipo           DeadlineType
  descricao      String?        @db.Text

  // Título automático
  title          String?
  autoTitle      Boolean        @default(true)

  // Origem da peça que gerou o prazo
  triggerPieceType   PieceType?
  triggerPieceDesc   String?
  triggerDocumentId  String?
  triggerDocument    Document?      @relation("DeadlineTriggerDocument", fields: [triggerDocumentId], references: [id])
  triggerMovementId  String?
  triggerMovement    CaseMovement?  @relation("DeadlineTriggerMovement", fields: [triggerMovementId], references: [id])

  // Início da contagem do prazo
  startMethod           DeadlineStartMethod @default(MANUAL)
  startDate             DateTime?
  disponibilizacaoDate  DateTime?
  publicacaoDate        DateTime?
  intimacaoDate         DateTime?
  cienciaDate           DateTime?

  // Dados do cálculo
  calculatedDays    Int?
  countingType      CountingType?
  isDoubled         Boolean        @default(false)
  doubleReason      String?
  originalDays      Int?

  // Datas calculadas
  dueDate           DateTime?
  internalDueDate   DateTime?
  manualDueDate     DateTime?       // Data que o advogado quer cumprir (antes do fatal)
  fatalDueDate      DateTime?       // Data fatal calculada pelo sistema (referência)
  calculationLog    Json?

  // Campos legados (mantidos para compatibilidade)
  data_limite    DateTime?
  data_alerta    DateTime[]
  status         DeadlineStatus @default(PENDENTE)
  responsavel_id String?
  responsavel    User?          @relation(fields: [responsavel_id], references: [id])
  recorrente     Boolean        @default(false)
  origem         DeadlineOrigin @default(MANUAL)
  movimento_id   String?
  lembrete_enviado Boolean      @default(false)
  documento_cumprimento_id String?

  // Contexto
  isPublicEntity    Boolean    @default(false)
  isDefensoria      Boolean    @default(false)
  isMP              Boolean    @default(false)
  isElectronic      Boolean    @default(true)

  // Prioridade
  priority          String?    // CRITICA, URGENTE, ALTA, MEDIA, BAIXA

  // Notificações
  notifyClientEmail    Boolean @default(false)
  notifyClientWhatsapp Boolean @default(false)
  reminderBefore       String? // "1d", "2d", "3d", "1w"

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  email_activity EmailActivity? @relation("DeadlineFromEmail")

  @@index([clientId])
  @@index([clientId, status])
  @@index([clientId, dueDate])
  @@index([case_id, clientId])
  @@index([triggerPieceType])
  @@index([dueDate])
  @@index([status])
  @@index([status, dueDate])
  @@map("deadlines")
}

model CaseMovement {
  id                String       @id @default(cuid())
  case_id           String
  case_             Case         @relation(fields: [case_id], references: [id], onDelete: Cascade)
  data              DateTime
  tipo              MovementType
  descricao         String
  conteudo_integral String?      @db.Text
  fonte             String?
  fonte_url         String?
  prazo_gerado      Boolean      @default(false)
  notificar_cliente Boolean      @default(false)
  lida              Boolean      @default(false)
  created_at        DateTime     @default(now())

  generatedDeadlines Deadline[]  @relation("DeadlineTriggerMovement")

  @@map("case_movements")
}

model Document {
  id               String       @id @default(cuid())
  case_id          String?
  case_            Case?        @relation(fields: [case_id], references: [id])
  person_id        String?
  negotiation_id   String?
  negotiation      Negotiation? @relation(fields: [negotiation_id], references: [id])
  project_id       String?
  project          Project?     @relation(fields: [project_id], references: [id])
  task_id          String?
  task             ProjectTask? @relation(fields: [task_id], references: [id])
  tipo             DocumentType
  titulo           String
  arquivo_url      String?
  versao           Int          @default(1)
  gerado_por_ia    Boolean      @default(false)
  template_id      String?
  criado_por_id    String?
  criado_por       User?        @relation(fields: [criado_por_id], references: [id])
  compartilhado_portal Boolean  @default(false)
  tags             String[]     @default([])
  onedrive_item_id   String?
  onedrive_web_url   String?
  created_at       DateTime     @default(now())
  updated_at       DateTime     @updatedAt

  generatedDeadlines Deadline[] @relation("DeadlineTriggerDocument")

  @@map("documents")
}

model Template {
  id              String       @id @default(cuid())
  nome            String
  tipo_documento  DocumentType
  area            TemplateArea
  conteudo        String       @db.Text
  variaveis       String[]     @default([])
  prompt_ia       String?      @db.Text
  estrutura_topicos String?    @db.Text
  ativo           Boolean      @default(true)
  created_by_id   String?
  created_by      User?        @relation(fields: [created_by_id], references: [id])
  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt

  @@map("templates")
}

model Creditor {
  id                 String        @id @default(cuid())
  case_id            String
  case_              Case          @relation(fields: [case_id], references: [id], onDelete: Cascade)
  person_id          String
  person             Person        @relation(fields: [person_id], references: [id])
  classe             CreditorClass
  valor_original     Decimal       @db.Decimal(18, 2)
  valor_atualizado   Decimal?      @db.Decimal(18, 2)
  valor_sujeito_plano Decimal?     @db.Decimal(18, 2)
  garantias          String?
  status_credito     CreditorStatus @default(PENDENTE)
  voto               String?
  created_at         DateTime      @default(now())
  updated_at         DateTime      @updatedAt

  @@map("creditors")
}

model Negotiation {
  id                String            @id @default(cuid())
  case_id           String?
  case_             Case?             @relation(fields: [case_id], references: [id])
  project_id        String?
  project           Project?          @relation(fields: [project_id], references: [id])
  creditor_id       String?
  person_id         String?
  person            Person?           @relation("NegotiationPerson", fields: [person_id], references: [id])
  status            NegotiationStatus @default(PREPARACAO)
  timeline_eventos  Json?
  propostas         Json?
  contrapropostas   Json?
  valor_pretendido  Decimal?          @db.Decimal(18, 2)
  valor_proposto    Decimal?          @db.Decimal(18, 2)
  valor_acordado    Decimal?          @db.Decimal(18, 2)
  analise_financeira Json?
  created_at        DateTime          @default(now())
  updated_at        DateTime          @updatedAt

  documents Document[]

  @@map("negotiations")
}

model CalendarEvent {
  id            String              @id @default(cuid())
  case_id       String?
  case_         Case?               @relation(fields: [case_id], references: [id])
  project_id    String?
  project       Project?            @relation(fields: [project_id], references: [id])
  task_id       String?
  task          ProjectTask?        @relation(fields: [task_id], references: [id])
  tipo_evento   CalendarEventType
  titulo        String
  descricao     String?             @db.Text
  data_inicio   DateTime
  data_fim      DateTime?
  dia_inteiro   Boolean             @default(false)
  local         String?
  link_virtual  String?
  campos_especificos Json?
  status        CalendarEventStatus @default(AGENDADO)
  responsavel_id String?
  responsavel   User?               @relation("EventResponsible", fields: [responsavel_id], references: [id])
  participantes_internos String[]   @default([])
  participantes_externos String[]   @default([])
  lembrete_minutos Int?
  recorrencia   Json?
  sincronizado_outlook Boolean      @default(false)
  outlook_event_id     String?      @unique
  outlook_last_sync    DateTime?
  outlook_sync_error   String?
  last_modified_source String?
  sync_status          String?      @default("SYNCED")
  sync_conflict_data   Json?
  cor           String?
  created_at    DateTime            @default(now())
  updated_at    DateTime            @updatedAt
  created_by_id String?
  created_by    User?               @relation("EventCreator", fields: [created_by_id], references: [id])

  activities Activity[]
  email_activity EmailActivity? @relation("CalendarEventFromEmail")

  @@map("calendar_events")
}

model Activity {
  id                String        @id @default(cuid())
  case_id           String?
  case_             Case?         @relation(fields: [case_id], references: [id])
  project_id        String?
  project           Project?      @relation(fields: [project_id], references: [id])
  task_id           String?
  task              ProjectTask?  @relation(fields: [task_id], references: [id])
  calendar_event_id String?
  calendar_event    CalendarEvent? @relation(fields: [calendar_event_id], references: [id])
  person_id         String?
  person            Person?       @relation(fields: [person_id], references: [id])
  user_id           String
  user              User          @relation(fields: [user_id], references: [id])
  tipo              ActivityType
  subtipo           String?
  descricao         String        @db.Text
  data              DateTime
  duracao_minutos   Int?
  resultado         String?       @db.Text
  visivel_portal    Boolean       @default(false)
  faturavel         Boolean       @default(true)
  valor_hora        Decimal?      @db.Decimal(10, 2)
  include_in_report Boolean       @default(true)
  report_priority   Int           @default(0)
  communication_type String?
  recipients        String[]      @default([])
  financial_impact  Decimal?      @db.Decimal(15, 2)
  financial_type    String?
  created_at        DateTime      @default(now())
  updated_at        DateTime      @updatedAt

  @@index([case_id])
  @@index([project_id])
  @@index([person_id])
  @@index([tipo])
  @@index([created_at(sort: Desc)])
  @@map("activities")
}

// ============================================================
// FEES (honorários)
// ============================================================

model Fee {
  id            String    @id @default(cuid())
  case_id       String?
  case_         Case?     @relation(fields: [case_id], references: [id])
  project_id    String?
  project       Project?  @relation(fields: [project_id], references: [id])
  person_id     String?   // client

  tipo          String    // FIXO | EXITO | MENSAL | POR_ATO | AD_EXITUM_RJ
  descricao     String
  valor         Decimal   @db.Decimal(15, 2)
  moeda         String    @default("BRL")

  // Installments
  parcelas      Int       @default(1)
  parcela_atual Int?
  parent_fee_id String?   // if this is an installment child

  // Recurrence
  recorrente    Boolean   @default(false)
  recorrencia   String?   // MENSAL, TRIMESTRAL, SEMESTRAL, ANUAL

  data_vencimento DateTime  @db.Date
  data_pagamento  DateTime? @db.Date
  status          String    @default("PENDENTE") // PENDENTE | PAGO | ATRASADO | CANCELADO

  observacoes   String?   @db.Text
  created_by_id String?
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  @@index([case_id])
  @@index([project_id])
  @@index([status])
  @@map("fees")
}

// ============================================================
// EXPENSES (despesas)
// ============================================================

model Expense {
  id            String    @id @default(cuid())
  case_id       String?
  case_         Case?     @relation(fields: [case_id], references: [id])
  project_id    String?
  project       Project?  @relation(fields: [project_id], references: [id])

  categoria     String    // CUSTAS | HONORARIOS_PERITO | CERTIDOES | DILIGENCIA | VIAGEM | REGISTRO | CORREIOS | COPIA | PUBLICACAO | OUTRO
  descricao     String
  valor         Decimal   @db.Decimal(15, 2)
  data          DateTime  @db.Date

  reembolsavel  Boolean   @default(false)
  reembolsado   Boolean   @default(false)
  data_reembolso DateTime? @db.Date

  comprovante_url String?
  observacoes     String?  @db.Text

  created_by_id String?
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  @@index([case_id])
  @@index([project_id])
  @@map("expenses")
}

model FinancialRelease {
  id               String   @id @default(cuid())
  tipo             String   // ALVARA, RPV, PRECATORIO
  numero_referencia String
  case_id          String?
  case_            Case?    @relation(fields: [case_id], references: [id])
  person_id        String?
  person           Person?  @relation(fields: [person_id], references: [id])
  valor            Decimal  @db.Decimal(15, 2)
  status           String   @default("PENDENTE") // PENDENTE, EXPEDIDO, LIBERADO, BLOQUEADO, CANCELADO
  data_prevista    DateTime? @db.Date
  data_liberacao   DateTime? @db.Date
  observacoes      String?  @db.Text
  activity_id      String?
  created_by_id    String?
  created_by       User?    @relation("FinancialReleaseCreator", fields: [created_by_id], references: [id])
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  @@index([person_id])
  @@index([case_id])
  @@index([status])
  @@map("financial_releases")
}

model ReportSnapshot {
  id              String   @id @default(cuid())
  person_id       String
  person          Person   @relation(fields: [person_id], references: [id], onDelete: Cascade)
  period_start    DateTime @db.Date
  period_end      DateTime @db.Date
  executive_summary String? @db.Text
  next_steps      String?  @db.Text
  kpis_data       Json?
  report_data     Json?
  pdf_path        String?
  shared_with_client Boolean @default(false)
  shared_at       DateTime?
  created_by_id   String?
  created_by      User?    @relation("ReportCreator", fields: [created_by_id], references: [id])
  created_at      DateTime @default(now())

  @@index([person_id])
  @@index([period_start, period_end])
  @@map("report_snapshots")
}

model LibraryEntry {
  id              String           @id @default(cuid())
  tipo            LibraryEntryType
  titulo          String
  resumo          String?          @db.Text
  conteudo        String?          @db.Text
  fonte           String?
  url_fonte       String?
  area            TemplateArea?
  tags            String[]         @default([])
  arquivo_url     String?
  relevancia      Int?             @default(0)
  favorito        Boolean          @default(false)
  metadata        Json?
  arquivo_tipo    String?
  arquivo_tamanho Int?
  case_id         String?
  case_           Case?            @relation("LibraryCaseRef", fields: [case_id], references: [id])

  utilizado_em_casos    Case[]    @relation("LibraryCases")
  utilizado_em_projetos Project[] @relation("LibraryProjects")

  created_at    DateTime @default(now())
  updated_at    DateTime @default(now()) @updatedAt
  created_by_id String?

  @@index([tipo])
  @@index([area])
  @@index([case_id])
  @@map("library_entries")
}

// ============================================================
// PROJECT MODULE MODELS
// ============================================================

model Project {
  id          String          @id @default(cuid())
  titulo      String
  codigo      String          @unique
  cliente_id  String
  cliente     Person          @relation("ProjectClient", fields: [cliente_id], references: [id])
  categoria   ProjectCategory
  descricao   String?         @db.Text
  valor_envolvido  Decimal?   @db.Decimal(18, 2)
  valor_honorarios Decimal?   @db.Decimal(18, 2)
  status      ProjectStatus   @default(PLANEJAMENTO)
  prioridade  Priority        @default(MEDIA)
  data_inicio DateTime?
  data_prevista_conclusao DateTime?
  data_conclusao_real     DateTime?
  advogado_responsavel_id String
  advogado_responsavel    User    @relation("ProjectResponsible", fields: [advogado_responsavel_id], references: [id])
  visivel_portal Boolean     @default(false)
  tags         String[]      @default([])
  created_at   DateTime      @default(now())
  updated_at   DateTime      @updatedAt
  created_by_id String?

  // Relations
  equipe          ProjectTeam[]
  stakeholders    ProjectStakeholder[]
  processos       Case[]
  etapas          ProjectPhase[]
  tarefas         ProjectTask[]
  marcos          ProjectMilestone[]
  documentos      Document[]
  atividades      Activity[]
  anotacoes       ProjectNote[]
  despesas        ProjectExpense[]
  negociacoes     Negotiation[]
  calendar_events CalendarEvent[]
  library_entries LibraryEntry[] @relation("LibraryProjects")
  chat_messages   ChatMessage[]  @relation("ChatMessageProject")
  fees            Fee[]
  expenses        Expense[]
  email_links     EmailLink[]
  email_activities EmailActivity[]
  whatsapp_conversations WhatsAppConversation[]
  investigations         Investigation[] @relation("InvestigationProject")

  @@map("projects")
}

model ProjectTeam {
  id         String          @id @default(cuid())
  project_id String
  project    Project         @relation(fields: [project_id], references: [id], onDelete: Cascade)
  user_id    String
  user       User            @relation(fields: [user_id], references: [id])
  role       ProjectTeamRole

  @@unique([project_id, user_id])
  @@map("project_teams")
}

model ProjectStakeholder {
  id         String          @id @default(cuid())
  project_id String
  project    Project         @relation(fields: [project_id], references: [id], onDelete: Cascade)
  person_id  String
  person     Person          @relation(fields: [person_id], references: [id])
  role       StakeholderRole

  @@unique([project_id, person_id, role])
  @@map("project_stakeholders")
}

model ProjectPhase {
  id                    String             @id @default(cuid())
  project_id            String
  project               Project            @relation(fields: [project_id], references: [id], onDelete: Cascade)
  titulo                String
  descricao             String?            @db.Text
  ordem                 Int
  status                ProjectPhaseStatus @default(NAO_INICIADA)
  data_inicio_prevista  DateTime?
  data_fim_prevista     DateTime?
  data_inicio_real      DateTime?
  data_fim_real         DateTime?
  percentual_conclusao  Int                @default(0)
  dependencia_fase_id   String?
  dependencia_fase      ProjectPhase?      @relation("PhaseDependency", fields: [dependencia_fase_id], references: [id])
  fases_dependentes     ProjectPhase[]     @relation("PhaseDependency")
  cor                   String?

  tarefas ProjectTask[]

  @@map("project_phases")
}

model ProjectTask {
  id          String            @id @default(cuid())
  project_id  String
  project     Project           @relation(fields: [project_id], references: [id], onDelete: Cascade)
  phase_id    String?
  phase       ProjectPhase?     @relation(fields: [phase_id], references: [id])
  case_id     String?
  titulo      String
  descricao   String?           @db.Text
  tipo        ProjectTaskType   @default(OUTRO)
  status      ProjectTaskStatus @default(BACKLOG)
  prioridade  Priority          @default(MEDIA)
  responsavel_id String?
  responsavel User?             @relation(fields: [responsavel_id], references: [id])
  data_limite DateTime?
  data_alerta DateTime?
  data_conclusao DateTime?
  estimativa_horas Decimal?     @db.Decimal(6, 2)
  horas_gastas     Decimal?     @db.Decimal(6, 2)
  campos_especificos Json?
  dependencia_tarefa_id String?
  dependencia_tarefa    ProjectTask?  @relation("TaskDependency", fields: [dependencia_tarefa_id], references: [id])
  tarefas_dependentes   ProjectTask[] @relation("TaskDependency")
  notificar_cliente Boolean       @default(false)
  created_at  DateTime          @default(now())
  updated_at  DateTime          @updatedAt

  // Relations
  checklist       ProjectTaskCheckItem[]
  comentarios     ProjectTaskComment[]
  documentos      Document[]
  calendar_events CalendarEvent[]
  activities      Activity[]

  @@map("project_tasks")
}

model ProjectTaskCheckItem {
  id             String    @id @default(cuid())
  task_id        String
  task           ProjectTask @relation(fields: [task_id], references: [id], onDelete: Cascade)
  descricao      String
  concluido      Boolean   @default(false)
  concluido_por_id String?
  concluido_por  User?     @relation("CheckItemDoneBy", fields: [concluido_por_id], references: [id])
  concluido_em   DateTime?
  ordem          Int       @default(0)

  @@map("project_task_check_items")
}

model ProjectTaskComment {
  id         String      @id @default(cuid())
  task_id    String
  task       ProjectTask @relation(fields: [task_id], references: [id], onDelete: Cascade)
  user_id    String
  user       User        @relation(fields: [user_id], references: [id])
  conteudo   String      @db.Text
  created_at DateTime    @default(now())

  @@map("project_task_comments")
}

model ProjectMilestone {
  id               String          @id @default(cuid())
  project_id       String
  project          Project         @relation(fields: [project_id], references: [id], onDelete: Cascade)
  titulo           String
  descricao        String?         @db.Text
  data_prevista    DateTime?
  data_alcancada   DateTime?
  status           MilestoneStatus @default(PENDENTE)
  impacto          MilestoneImpact @default(MEDIO)
  notificar_cliente Boolean        @default(false)

  @@map("project_milestones")
}

model ProjectNote {
  id         String   @id @default(cuid())
  project_id String
  project    Project  @relation(fields: [project_id], references: [id], onDelete: Cascade)
  user_id    String
  user       User     @relation(fields: [user_id], references: [id])
  conteudo   String   @db.Text
  fixada     Boolean  @default(false)
  created_at DateTime @default(now())

  @@map("project_notes")
}

model Holiday {
  id   String   @id @default(cuid())
  data DateTime @db.Date
  nome String
  tipo String   // NACIONAL, ESTADUAL, MUNICIPAL
  uf   String?  // null for national, state code for state holidays

  @@unique([data, nome])
  @@map("holidays")
}

model ProjectExpense {
  id              String   @id @default(cuid())
  project_id      String
  project         Project  @relation(fields: [project_id], references: [id], onDelete: Cascade)
  descricao       String
  valor           Decimal  @db.Decimal(18, 2)
  data            DateTime
  categoria       String   // CERTIDAO, REGISTRO, CUSTAS, VIAGEM, PERICIA, OUTRO
  comprovante_url String?
  created_by_id   String?
  created_at      DateTime @default(now())

  @@map("project_expenses")
}

model ProjectTemplate {
  id           String          @id @default(cuid())
  titulo       String
  categoria    ProjectCategory
  descricao    String?         @db.Text
  fases_padrao Json?
  marcos_padrao Json?
  ativo        Boolean         @default(true)
  created_at   DateTime        @default(now())

  @@map("project_templates")
}

// ============================================================
// AI / CONFECÇÃO MODULE MODELS
// ============================================================

model ChatMessage {
  id        String   @id @default(cuid())
  sessionId String
  role      String   // 'user' | 'assistant' | 'system'
  content   String   @db.Text
  metadata  Json?

  caseId    String?
  case_     Case?    @relation("ChatMessageCase", fields: [caseId], references: [id])
  projectId String?
  project   Project? @relation("ChatMessageProject", fields: [projectId], references: [id])
  negotiationId String?
  negotiation   StratNegotiation? @relation("NegChatMessages", fields: [negotiationId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@index([sessionId])
  @@index([caseId])
  @@index([negotiationId])
  @@index([userId])
  @@map("chat_messages")
}

model AIUsageLog {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation("AIUsageLogs", fields: [userId], references: [id])
  actionType String   // 'chat' | 'generate' | 'review'
  docType    String?
  tokensIn   Int      @default(0)
  tokensOut  Int      @default(0)
  model         String
  durationMs    Int      @default(0)
  costEstimated Decimal  @default(0) @db.Decimal(10, 6)
  caseId        String?
  projectId     String?
  negotiationId String?
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@map("ai_usage_logs")
}

model LibrarySearchLog {
  id                    String   @id @default(cuid())
  user_id               String
  user                  User     @relation("LibrarySearchLogs", fields: [user_id], references: [id])
  query                 String   @db.Text
  results_count         Int
  entries_used          String[] @default([])
  document_generated_id String?
  context               String   // CHAT | DOCUMENTO | REVISAO | MANUAL
  created_at            DateTime @default(now())

  @@index([user_id])
  @@index([created_at])
  @@map("library_search_logs")
}

// ============================================================
// JUDICIAL RECOVERY (RJ) MODULE MODELS
// ============================================================

model JudicialRecoveryCase {
  id                    String    @id @default(cuid())
  case_id               String    @unique
  case_                 Case      @relation(fields: [case_id], references: [id], onDelete: Cascade)

  // RJ-specific data
  status_rj             JRStatus  @default(PROCESSAMENTO)
  data_pedido           DateTime?
  data_deferimento      DateTime?
  data_agc              DateTime?
  data_aprovacao_plano  DateTime?
  data_homologacao      DateTime?
  data_encerramento     DateTime?

  // Administrador Judicial
  administrador_judicial_id String?
  administrador_judicial    Person?  @relation("RJAdminJudicial", fields: [administrador_judicial_id], references: [id])

  // Totals (cached, recalculated)
  total_credores        Int       @default(0)
  total_credito         BigInt    @default(0)
  total_classe_i        BigInt    @default(0)
  total_classe_ii       BigInt    @default(0)
  total_classe_iii      BigInt    @default(0)
  total_classe_iv       BigInt    @default(0)

  // Plan info
  plano_versao          Int       @default(0)
  plano_aprovado        Boolean   @default(false)

  observacoes           String?   @db.Text

  created_at            DateTime  @default(now())
  updated_at            DateTime  @updatedAt

  // Relations
  credores              RJCreditor[]
  subclasses            CreditorSubclass[]
  versoes               CreditorTableVersion[]
  impugnacoes           CreditorChallenge[]
  voting_scenarios      VotingScenario[]
  financial_projections FinancialProjection[]
  negotiations          RJNegotiation[]
  extraconcursais       ExtraconcursalCreditor[]
  strat_negotiations    StratNegotiation[]
  crj_negotiations      CRJNegotiation[]

  @@map("judicial_recovery_cases")
}

model RJCreditor {
  id                    String          @id @default(cuid())
  jrc_id                String
  jrc                   JudicialRecoveryCase @relation(fields: [jrc_id], references: [id], onDelete: Cascade)

  // Identification
  nome                  String
  cpf_cnpj              String?
  pessoa_fisica         Boolean         @default(false)

  // Optional link to Person
  person_id             String?
  person                Person?         @relation("RJCreditorPerson", fields: [person_id], references: [id])

  // Classification
  classe                CreditClass
  natureza              CreditNature
  status                RJCreditStatus  @default(HABILITADO)
  fonte                 CreditorSource  @default(MANUAL)

  // Values (all stored as BigInt centavos for precision)
  valor_original        BigInt          @default(0)
  valor_atualizado      BigInt          @default(0)
  valor_garantia        BigInt          @default(0)
  valor_quirografario   BigInt          @default(0)
  valor_trabalhista_150sm BigInt        @default(0)
  valor_trabalhista_excedente BigInt    @default(0)

  // Guarantee details
  tipo_garantia         GuaranteeType   @default(NONE)
  descricao_garantia    String?         @db.Text
  matricula_imovel      String?
  valor_avaliacao_garantia BigInt       @default(0)

  // Payment terms from plan
  desagio_percentual    Float?
  carencia_meses        Int?
  parcelas              Int?
  indexador             IndexationType?
  juros_percentual      Float?

  // Voting
  voto                  VoteDirection?
  presente_agc          Boolean         @default(false)

  // Subclass
  subclass_id           String?
  subclass              CreditorSubclass? @relation(fields: [subclass_id], references: [id])

  // Metadata
  observacoes           String?         @db.Text
  ordem                 Int             @default(0)

  created_at            DateTime        @default(now())
  updated_at            DateTime        @updatedAt

  // Relations
  documentos            CreditorDocument[]
  impugnacoes           CreditorChallenge[]
  parcelas_pgto         PaymentInstallment[]
  negotiation_creditors NegotiationCreditor[]
  strat_negotiations    StratNegotiation[]
  crj_negotiations      CRJNegotiation[]

  @@index([jrc_id])
  @@index([classe])
  @@index([status])
  @@index([subclass_id])
  @@map("rj_creditors")
}

model CreditorSubclass {
  id                    String              @id @default(cuid())
  jrc_id                String
  jrc                   JudicialRecoveryCase @relation(fields: [jrc_id], references: [id], onDelete: Cascade)

  nome                  String
  descricao             String?             @db.Text
  classe_base           CreditClass

  // STJ REsp 1.634.844/SP validation
  criterios_objetivos   Json?
  justificativa_interesse_homogeneo String? @db.Text
  protecao_direitos     String?             @db.Text

  // Payment conditions for this subclass
  desagio_percentual    Float?
  carencia_meses        Int?
  parcelas              Int?
  indexador             IndexationType?
  juros_percentual      Float?

  // Validation status
  validacao             SubclassValidation  @default(RASCUNHO)
  validacao_notas       String?             @db.Text
  risco_cram_down       CramDownRisk?

  // Stats (cached)
  total_credores        Int                 @default(0)
  total_valor           BigInt              @default(0)

  ordem                 Int                 @default(0)
  cor                   String?

  created_at            DateTime            @default(now())
  updated_at            DateTime            @updatedAt

  // Relations
  credores              RJCreditor[]

  @@index([jrc_id])
  @@index([classe_base])
  @@map("creditor_subclasses")
}

model CreditorTableVersion {
  id                    String              @id @default(cuid())
  jrc_id                String
  jrc                   JudicialRecoveryCase @relation(fields: [jrc_id], references: [id], onDelete: Cascade)

  versao                Int
  tipo                  TableVersionType
  titulo                String
  descricao             String?             @db.Text

  // Snapshot data
  snapshot_data         Json
  summary_data          Json?

  // Metadata
  publicada             Boolean             @default(false)
  data_publicacao       DateTime?

  created_at            DateTime            @default(now())
  created_by_id         String?

  @@index([jrc_id])
  @@map("creditor_table_versions")
}

model CreditorChallenge {
  id                    String              @id @default(cuid())
  jrc_id                String
  jrc                   JudicialRecoveryCase @relation(fields: [jrc_id], references: [id], onDelete: Cascade)

  creditor_id           String?
  creditor              RJCreditor?         @relation(fields: [creditor_id], references: [id])

  tipo                  ChallengeType
  requerente_nome       String
  requerente_cpf_cnpj   String?

  // Values
  valor_pretendido      BigInt              @default(0)
  classe_pretendida     CreditClass?

  // Resolution
  resolucao             ChallengeResolution @default(PENDENTE)
  valor_reconhecido     BigInt?
  classe_reconhecida    CreditClass?

  // Process info
  numero_processo       String?
  data_protocolo        DateTime?
  data_resolucao        DateTime?
  fundamentacao         String?             @db.Text
  decisao               String?             @db.Text

  created_at            DateTime            @default(now())
  updated_at            DateTime            @updatedAt

  @@index([jrc_id])
  @@index([creditor_id])
  @@map("creditor_challenges")
}

model CreditorDocument {
  id                    String              @id @default(cuid())
  creditor_id           String
  creditor              RJCreditor          @relation(fields: [creditor_id], references: [id], onDelete: Cascade)

  tipo                  CreditorDocType
  titulo                String
  arquivo_url           String?
  observacoes           String?

  uploaded_at           DateTime            @default(now())

  @@index([creditor_id])
  @@map("creditor_documents")
}

model PaymentInstallment {
  id                    String              @id @default(cuid())
  creditor_id           String
  creditor              RJCreditor          @relation(fields: [creditor_id], references: [id], onDelete: Cascade)

  numero                Int
  data_vencimento       DateTime
  valor_principal       BigInt              @default(0)
  valor_juros           BigInt              @default(0)
  valor_correcao        BigInt              @default(0)
  valor_total           BigInt              @default(0)
  valor_pago            BigInt              @default(0)

  status                InstallmentStatus   @default(PENDENTE)
  data_pagamento        DateTime?

  created_at            DateTime            @default(now())

  @@index([creditor_id])
  @@map("payment_installments")
}

// ============================================================
// PRJ APPROVAL MODULE MODELS
// ============================================================

enum ScenarioType {
  BASE
  OTIMISTA
  PESSIMISTA
  CRAM_DOWN
  CUSTOM
}

enum ProjectionStatus {
  RASCUNHO
  EM_ANALISE
  APROVADO
  REJEITADO
}

model VotingScenario {
  id                    String              @id @default(cuid())
  jrc_id                String
  jrc                   JudicialRecoveryCase @relation(fields: [jrc_id], references: [id], onDelete: Cascade)

  nome                  String
  tipo                  ScenarioType        @default(BASE)
  descricao             String?             @db.Text

  // Scenario data: overrides per creditor { creditor_id: { voto, presente_agc } }
  overrides             Json?

  // Computed results (cached)
  resultado             Json?
  aprovado              Boolean?
  cram_down_viavel      Boolean?

  ativo                 Boolean             @default(true)

  created_at            DateTime            @default(now())
  updated_at            DateTime            @updatedAt
  created_by_id         String?

  @@index([jrc_id])
  @@map("voting_scenarios")
}

model FinancialProjection {
  id                    String              @id @default(cuid())
  jrc_id                String
  jrc                   JudicialRecoveryCase @relation(fields: [jrc_id], references: [id], onDelete: Cascade)

  nome                  String
  tipo                  ScenarioType        @default(BASE)
  status                ProjectionStatus    @default(RASCUNHO)

  // Input parameters
  anos_projecao         Int                 @default(5)
  receita_ano_base      BigInt              @default(0)
  taxa_crescimento      Float               @default(0)    // % annual
  margem_ebitda         Float               @default(0)    // %
  capex_percentual      Float               @default(0)    // % of revenue
  capital_giro_pct      Float               @default(0)    // % of revenue
  taxa_desconto         Float               @default(12)   // % annual (WACC)
  aliquota_ir           Float               @default(34)   // IRPJ + CSLL

  // Stress test parameters
  stress_receita        Float?              // % variation
  stress_margem         Float?              // % variation
  stress_juros          Float?              // % variation

  // Computed results (cached as JSON)
  resultado_dre         Json?
  resultado_fluxo_caixa Json?
  resultado_dscr        Json?
  resultado_sensibilidade Json?

  observacoes           String?             @db.Text

  created_at            DateTime            @default(now())
  updated_at            DateTime            @updatedAt
  created_by_id         String?

  @@index([jrc_id])
  @@map("financial_projections")
}

// ============================================================
// NEGOTIATION MODULE — Enums
// ============================================================

enum NegotiationPhase {
  MAPEAMENTO
  CONTATO_INICIAL
  PROPOSTA_ENVIADA
  CONTRAPROPOSTA
  MEDIACAO
  ACORDO_VERBAL
  FORMALIZACAO
  HOMOLOGACAO
  CONCLUIDA
  IMPASSE
}

enum NegotiationPriority {
  CRITICA
  ALTA
  MEDIA
  BAIXA
}

enum CreditorNegotiationStatus {
  NAO_CONTATADO
  EM_CONTATO
  PROPOSTA_RECEBIDA
  CONTRAPROPOSTA_ENVIADA
  EM_MEDIACAO
  ACORDO_PARCIAL
  ACORDO_TOTAL
  RECUSOU
  PARCEIRO
  DESISTIU
}

enum NegActivityType {
  CONTATO_TELEFONICO
  EMAIL_ENVIADO
  EMAIL_RECEBIDO
  REUNIAO_PRESENCIAL
  REUNIAO_VIRTUAL
  PROPOSTA_ENVIADA
  CONTRAPROPOSTA_RECEBIDA
  ACORDO_VERBAL
  ACORDO_FORMALIZADO
  DOCUMENTO_ENVIADO
  DOCUMENTO_RECEBIDO
  MEDIACAO_SESSAO
  OBSERVACAO
}

enum NegTemplateType {
  PROPOSTA_INICIAL
  CONTRAPROPOSTA
  CONVITE_PARCEIRO
  CONVITE_MEDIACAO
  TERMO_ACORDO
  NOTIFICACAO
  LEMBRETE
}

enum CommunicationChannel {
  EMAIL
  WHATSAPP
  TELEFONE
  CARTA
  REUNIAO_PRESENCIAL
  REUNIAO_VIRTUAL
  SISTEMA
}

// ============================================================
// NEGOTIATION MODULE — Models
// ============================================================

model RJNegotiation {
  id                    String              @id @default(cuid())
  jrc_id                String
  jrc                   JudicialRecoveryCase @relation(fields: [jrc_id], references: [id], onDelete: Cascade)

  // Identification
  titulo                String
  descricao             String?             @db.Text
  fase                  NegotiationPhase    @default(MAPEAMENTO)
  prioridade            NegotiationPriority @default(MEDIA)

  // Dates
  data_inicio           DateTime            @default(now())
  data_limite           DateTime?
  data_conclusao        DateTime?

  // Proposal values
  valor_total_original  BigInt              @default(0)
  valor_proposta_atual  BigInt              @default(0)
  desagio_proposto      Float?              // % discount
  carencia_proposta     Int?                // months
  parcelas_propostas    Int?
  juros_proposto        Float?              // % annual

  // Counters (cached)
  total_credores        Int                 @default(0)
  credores_acordados    Int                 @default(0)
  valor_acordado        BigInt              @default(0)

  // Partner program
  programa_parceiro     Boolean             @default(false)
  beneficio_parceiro    String?             @db.Text

  // Mediation
  mediacao_ativa        Boolean             @default(false)
  mediador_nome         String?
  mediador_contato      String?
  proxima_sessao        DateTime?

  observacoes           String?             @db.Text

  created_at            DateTime            @default(now())
  updated_at            DateTime            @updatedAt
  created_by_id         String?

  // Relations
  credores              NegotiationCreditor[]
  atividades            NegotiationActivity[]
  crj_links             CRJCollectiveRoundLink[]

  @@index([jrc_id])
  @@index([fase])
  @@map("rj_negotiations")
}

model NegotiationCreditor {
  id                    String                    @id @default(cuid())
  negotiation_id        String
  negotiation           RJNegotiation             @relation(fields: [negotiation_id], references: [id], onDelete: Cascade)

  creditor_id           String
  creditor              RJCreditor                @relation(fields: [creditor_id], references: [id], onDelete: Cascade)

  // Status in this negotiation
  status                CreditorNegotiationStatus @default(NAO_CONTATADO)
  is_parceiro           Boolean                   @default(false)

  // Individual proposal
  valor_original        BigInt                    @default(0)
  valor_proposto        BigInt                    @default(0)
  valor_contraproposta  BigInt?
  valor_acordado        BigInt?
  desagio_individual    Float?
  carencia_individual   Int?
  parcelas_individual   Int?
  juros_individual      Float?

  // Contact info
  ultimo_contato        DateTime?
  proximo_contato       DateTime?
  canal_preferido       CommunicationChannel?
  contato_nome          String?
  contato_email         String?
  contato_telefone      String?

  observacoes           String?                   @db.Text

  created_at            DateTime                  @default(now())
  updated_at            DateTime                  @updatedAt

  @@unique([negotiation_id, creditor_id])
  @@index([negotiation_id])
  @@index([creditor_id])
  @@index([status])
  @@map("negotiation_creditors")
}

model NegotiationActivity {
  id                    String              @id @default(cuid())
  negotiation_id        String
  negotiation           RJNegotiation       @relation(fields: [negotiation_id], references: [id], onDelete: Cascade)

  tipo                  NegActivityType
  canal                 CommunicationChannel?
  descricao             String              @db.Text
  resultado             String?             @db.Text

  // Optional link to specific creditor
  creditor_id           String?
  creditor_nome         String?

  // Attachments (JSON array of { nome, url })
  anexos                Json?

  data_atividade        DateTime            @default(now())
  created_by_id         String?

  created_at            DateTime            @default(now())

  @@index([negotiation_id])
  @@index([data_atividade])
  @@map("negotiation_activities")
}

model NegotiationTemplate {
  id                    String              @id @default(cuid())
  tipo                  NegTemplateType
  titulo                String
  assunto               String?
  conteudo              String              @db.Text
  variaveis             Json?               // available template variables
  canal                 CommunicationChannel?
  ativo                 Boolean             @default(true)

  created_at            DateTime            @default(now())
  updated_at            DateTime            @updatedAt
  created_by_id         String?

  @@map("negotiation_templates")
}

// ===== IMPORTAÇÃO INTELIGENTE =====

enum ImportEntityType {
  PERSON
  CASE
  DEADLINE
  CASE_MOVEMENT
  RJ_CREDITOR
}

enum ImportStatus {
  PENDENTE
  PROCESSANDO
  CONCLUIDO
  CONCLUIDO_PARCIAL
  ERRO
  REVERTIDO
}

model ImportTemplate {
  id              String           @id @default(cuid())
  nome            String
  descricao       String?
  entity_type     ImportEntityType
  field_mapping   Json             // { sourceField: targetField }
  ai_prompt_hint  String?          @db.Text
  ativo           Boolean          @default(true)

  created_at      DateTime         @default(now())
  updated_at      DateTime         @updatedAt
  created_by_id   String?

  import_logs     ImportLog[]

  @@map("import_templates")
}

model ImportLog {
  id              String           @id @default(cuid())
  entity_type     ImportEntityType
  status          ImportStatus     @default(PENDENTE)
  arquivo_nome    String
  arquivo_tipo    String
  total_linhas    Int              @default(0)
  importados      Int              @default(0)
  erros           Int              @default(0)
  ignorados       Int              @default(0)
  detalhes        Json?            // { errors: [], warnings: [], created_ids: [] }
  ai_analysis     Json?
  template_id     String?
  template        ImportTemplate?  @relation(fields: [template_id], references: [id])
  revertido       Boolean          @default(false)

  created_at      DateTime         @default(now())
  created_by_id   String?

  @@index([entity_type])
  @@index([created_at])
  @@map("import_logs")
}

// ===== CREDORES EXTRACONCURSAIS (Art. 49, §3º) =====

enum ExtraconcursalGuaranteeType {
  ALIENACAO_FIDUCIARIA_IMOVEL
  ALIENACAO_FIDUCIARIA_MOVEL
  CESSAO_FIDUCIARIA_RECEBIVEIS
  CESSAO_FIDUCIARIA_DIREITOS_CREDITORIOS
  HIPOTECA
  PENHOR_AGRICOLA
  PENHOR_MERCANTIL
  RESERVA_DOMINIO
  ARRENDAMENTO_MERCANTIL
  CESSAO_FIDUCIARIA_TITULOS
  OUTRO
}

enum BemSituacao {
  EM_POSSE_DEVEDOR
  EM_POSSE_CREDOR
  BUSCA_APREENSAO
  CONSOLIDADO
  LEILAO_AGENDADO
  VENDIDO
  PERECIDO
}

enum ExtraconcursalNegStatus {
  NAO_INICIADA
  EM_NEGOCIACAO
  PROPOSTA_ENVIADA
  CONTRAPROPOSTA
  ACORDO
  EXECUCAO_GARANTIA
  BUSCA_APREENSAO_JUDICIAL
}

enum RiskLevel {
  BAIXO
  MEDIO
  ALTO
  CRITICO
}

enum ImpactLevel {
  NENHUM
  BAIXO
  MEDIO
  ALTO
  CRITICO
}

enum ExtraconcursalEventType {
  CONTATO_INICIAL
  PROPOSTA
  CONTRAPROPOSTA
  REUNIAO
  EMAIL
  TELEFONEMA
  ACORDO
  IMPASSE
  NOTIFICACAO
  BUSCA_APREENSAO
  DECISAO_JUDICIAL
}

model ExtraconcursalCreditor {
  id                        String                    @id @default(cuid())
  jrc_id                    String
  jrc                       JudicialRecoveryCase      @relation(fields: [jrc_id], references: [id], onDelete: Cascade)

  // Optional link to Person
  person_id                 String?
  person                    Person?                   @relation("ExtraconcursalPerson", fields: [person_id], references: [id])

  // Creditor identification
  nome                      String
  cpf_cnpj                  String?

  // Credit values (BigInt centavos)
  valor_total               BigInt                    @default(0)
  valor_garantia            BigInt                    @default(0)
  saldo_devedor             BigInt                    @default(0)

  // Guarantee (art. 49, §3º)
  tipo_garantia             ExtraconcursalGuaranteeType
  descricao_garantia        String                    @db.Text
  matricula_registro        String?
  avaliacao_data            DateTime?
  avaliacao_valor           BigInt                    @default(0)
  avaliacao_responsavel     String?

  // Situação do Bem
  situacao_bem              BemSituacao               @default(EM_POSSE_DEVEDOR)
  localizacao_bem           String?

  // Essencialidade (art. 49, §3º parte final)
  essencial_atividade       Boolean                   @default(false)
  justificativa_essencialidade String?                @db.Text

  // Stay period (art. 6º, §§ 4º e 5º)
  data_deferimento_rj       DateTime?
  prazo_suspensao_fim       DateTime?
  suspensao_ativa           Boolean                   @default(true)

  // Negociação
  status_negociacao         ExtraconcursalNegStatus   @default(NAO_INICIADA)
  rodada_atual              Int                       @default(1)

  // Valores de negociação (BigInt centavos)
  valor_proposto_devedor    BigInt?
  valor_pedido_credor       BigInt?
  valor_acordado            BigInt?
  condicoes_acordo          String?                   @db.Text

  // Risco
  risco_perda_bem           RiskLevel                 @default(MEDIO)
  impacto_operacional       ImpactLevel               @default(MEDIO)

  // Datas
  data_vencimento_original  DateTime?
  data_notificacao_credor   DateTime?

  observacoes               String?                   @db.Text
  created_at                DateTime                  @default(now())
  updated_at                DateTime                  @updatedAt

  // Relations
  eventos                   ExtraconcursalNegotiationEvent[]

  @@index([jrc_id])
  @@index([tipo_garantia])
  @@index([status_negociacao])
  @@map("extraconcursal_creditors")
}

model ExtraconcursalNegotiationEvent {
  id                        String                    @id @default(cuid())
  extraconcursal_creditor_id String
  creditor                  ExtraconcursalCreditor    @relation(fields: [extraconcursal_creditor_id], references: [id], onDelete: Cascade)

  rodada                    Int                       @default(1)
  data                      DateTime                  @default(now())
  tipo                      ExtraconcursalEventType
  descricao                 String                    @db.Text
  valor_proposto            BigInt?
  responsavel_id            String?
  documento_id              String?

  created_at                DateTime                  @default(now())

  @@index([extraconcursal_creditor_id])
  @@map("extraconcursal_negotiation_events")
}

// ============================================================
// SUPER MÓDULO DE NEGOCIAÇÃO ESTRATÉGICA
// Harvard, Voss, Camp, Karrass, Game Theory
// ============================================================

enum StratNegType {
  INDIVIDUAL
  COLETIVA_CLASSE
  COLETIVA_COMITE
  EXTRAJUDICIAL
}

enum StratNegPhase {
  PREPARACAO
  ENGAJAMENTO
  BARGANHA
  COMPROMISSO
  ENCERRADA
}

enum StratNegStatus {
  NAO_INICIADA
  EM_ANDAMENTO
  PROPOSTA_ENVIADA
  CONTRAPROPOSTA
  IMPASSE
  ACORDO
  FRACASSADA
}

enum StratNegPriority {
  CRITICA
  ALTA
  MEDIA
  BAIXA
}

enum TKIProfile {
  COMPETITIVO
  COLABORATIVO
  COMPROMISSO
  EVITATIVO
  ACOMODATIVO
}

enum VossNegotiatorType {
  ANALISTA
  ACOMODADOR
  ASSERTIVO
}

enum GameType {
  SOMA_ZERO
  SOMA_POSITIVA
  DILEMA_PRISIONEIRO
}

enum GameEquilibrium {
  REESTRUTURACAO
  LIQUIDACAO
  HOLDOUT
}

enum GameCoalition {
  FAVORAVEL
  NEUTRO
  OPOSICAO
  LIDER_OPOSICAO
}

enum RoundStatus {
  ABERTA
  ENCERRADA_ACORDO
  ENCERRADA_IMPASSE
  ENCERRADA_ADIADA
}

enum StratEventType {
  REUNIAO
  TELEFONEMA
  EMAIL
  PROPOSTA
  CONTRAPROPOSTA
  ACORDO
  IMPASSE
  NOTIFICACAO
  DECISAO_JUDICIAL
  ASSEMBLEIA
  MEDIACAO
  ANALISE_IA
}

enum EventChannel {
  PRESENCIAL
  VIDEO
  TELEFONE
  EMAIL_CANAL
  WHATSAPP
  CARTA
  OFICIO
}

enum Sentiment {
  POSITIVO
  NEUTRO
  NEGATIVO
  HOSTIL
}

enum ProposalOrigin {
  DEVEDOR
  CREDOR
  MEDIADOR
}

enum ProposalStatus {
  RASCUNHO
  ENVIADA
  RECEBIDA
  ACEITA
  REJEITADA
  CONTRAPROPOSTA_STATUS
}

enum ConcessionDirection {
  DADA
  RECEBIDA
}

// ========== STRATEGIC NEGOTIATION ==========

model StratNegotiation {
  id                    String            @id @default(cuid())
  case_id               String?
  jrc_id                String?
  creditor_id           String?
  person_id             String?

  titulo                String
  codigo                String            @unique
  tipo                  StratNegType      @default(INDIVIDUAL)
  fase                  StratNegPhase     @default(PREPARACAO)
  status                StratNegStatus    @default(NAO_INICIADA)
  prioridade            StratNegPriority  @default(MEDIA)

  valor_credito         BigInt            @default(0)
  valor_meta_acordo     BigInt?
  valor_proposta_atual  BigInt?
  valor_pedido_credor   BigInt?
  valor_acordado        BigInt?
  haircut_percentual    Float?

  interesses_devedor    Json?
  interesses_credor     Json?
  batna_devedor         Json?
  batna_credor          Json?
  zopa_min              BigInt?
  zopa_max              BigInt?
  opcoes_criativas      Json?
  criterios_legitimidade Json?

  tki_perfil_credor     TKIProfile?
  tki_assertividade     Int?
  tki_cooperatividade   Int?
  tki_estrategia_recomendada String?

  voss_empatia_tatica   Json?
  voss_acusation_audit  Json?
  voss_calibrated_questions Json?
  voss_black_swans      Json?
  voss_tipo_negociador  VossNegotiatorType?

  camp_missao           String?           @db.Text
  camp_budget_tempo     Int?
  camp_budget_energia   Int?
  camp_budget_dinheiro  Int?
  camp_budget_emocao    Int?
  camp_decisores        Json?

  karrass_poder_score   Json?

  game_tipo_jogo        GameType?
  game_equilibrio       GameEquilibrium?
  game_shapley_value    Float?
  game_poder_voto       Float?
  game_risco_holdout    RiskLevel?
  game_coalicao         GameCoalition?

  data_inicio           DateTime?
  data_limite           DateTime?
  data_acordo           DateTime?
  data_proxima_acao     DateTime?
  proxima_acao          String?

  responsavel_id        String?
  observacoes           String?           @db.Text

  // AI-generated fields
  health_score          Int?
  health_score_details  Json?
  probability_acordo    Float?
  haircut_estimado_min  Float?
  haircut_estimado_max  Float?
  tempo_estimado_dias   Int?
  ai_proxima_acao       String?           @db.Text
  ai_insights           Json?
  ai_playbook           Json?
  ai_last_analysis      DateTime?

  created_at            DateTime          @default(now())
  updated_at            DateTime          @updatedAt

  case_                 Case?             @relation("StratNegCase", fields: [case_id], references: [id])
  jrc                   JudicialRecoveryCase? @relation(fields: [jrc_id], references: [id])
  rj_creditor           RJCreditor?       @relation(fields: [creditor_id], references: [id])
  person                Person?           @relation("StratNegPerson", fields: [person_id], references: [id])
  responsavel           User?             @relation("StratNegResponsavel", fields: [responsavel_id], references: [id])

  eventos               StratNegEvent[]
  rodadas               StratNegRound[]
  concessoes            StratNegConcession[]
  propostas             StratNegProposal[]
  one_sheets            StratNegOneSheet[]
  ai_insights_list      NegAIInsight[]
  chat_messages         ChatMessage[]     @relation("NegChatMessages")

  @@index([case_id])
  @@index([jrc_id])
  @@index([fase])
  @@index([status])
  @@map("strat_negotiations")
}

// ========== NEGOTIATION ROUND ==========

model StratNegRound {
  id                    String       @id @default(cuid())
  negotiation_id        String
  numero                Int
  titulo                String?
  status                RoundStatus  @default(ABERTA)
  data_inicio           DateTime
  data_fim              DateTime?

  valor_proposto_devedor BigInt?
  valor_pedido_credor    BigInt?
  resultado              String?     @db.Text

  ackerman_target       BigInt?
  ackerman_seq          Json?
  ackerman_passo        Int?

  observacoes           String?      @db.Text
  created_at            DateTime     @default(now())

  negotiation           StratNegotiation @relation(fields: [negotiation_id], references: [id], onDelete: Cascade)
  eventos               StratNegEvent[]

  @@index([negotiation_id])
  @@map("strat_neg_rounds")
}

// ========== NEGOTIATION EVENT ==========

model StratNegEvent {
  id                String          @id @default(cuid())
  negotiation_id    String
  round_id          String?

  data              DateTime
  tipo              StratEventType
  canal             EventChannel?

  descricao         String          @db.Text
  participantes     Json?
  valor_mencionado  BigInt?

  tecnicas_usadas   Json?
  sentimento        Sentiment?
  insights          String?         @db.Text

  documento_id      String?
  responsavel_id    String?
  created_at        DateTime        @default(now())

  negotiation       StratNegotiation @relation(fields: [negotiation_id], references: [id], onDelete: Cascade)
  round             StratNegRound?  @relation(fields: [round_id], references: [id])

  @@index([negotiation_id])
  @@index([round_id])
  @@map("strat_neg_events")
}

// ========== PROPOSAL ==========

model StratNegProposal {
  id                    String         @id @default(cuid())
  negotiation_id        String
  tipo                  ProposalOrigin
  numero                Int
  data                  DateTime

  valor_principal       BigInt
  haircut_pct           Float?
  taxa_juros            Float?
  carencia_meses        Int?
  prazo_pagamento_meses Int?
  parcelas              Int?

  debt_equity_swap      Boolean        @default(false)
  equity_pct            Float?
  warrants              Boolean        @default(false)
  pik_toggle            Boolean        @default(false)
  contingent_value      Boolean        @default(false)
  condicoes_especiais   String?        @db.Text

  npv_devedor           BigInt?
  npv_credor            BigInt?
  taxa_desconto         Float?
  recovery_rate         Float?

  status                ProposalStatus @default(RASCUNHO)
  justificativa         String?        @db.Text
  documento_id          String?

  created_at            DateTime       @default(now())

  negotiation           StratNegotiation @relation(fields: [negotiation_id], references: [id], onDelete: Cascade)

  @@index([negotiation_id])
  @@map("strat_neg_proposals")
}

// ========== CONCESSION (Karrass) ==========

model StratNegConcession {
  id                String              @id @default(cuid())
  negotiation_id    String
  data              DateTime
  direcao           ConcessionDirection
  descricao         String              @db.Text
  valor_impacto     BigInt?
  justificativa     String              @db.Text
  contrapartida     String?             @db.Text

  created_at        DateTime            @default(now())

  negotiation       StratNegotiation    @relation(fields: [negotiation_id], references: [id], onDelete: Cascade)

  @@index([negotiation_id])
  @@map("strat_neg_concessions")
}

// ========== ONE-SHEET (Voss) ==========

model StratNegOneSheet {
  id                   String           @id @default(cuid())
  negotiation_id       String

  objetivo_especifico  String           @db.Text
  resumo_situacao      String           @db.Text
  labels_preparados    Json
  accusation_audit     Json
  calibrated_questions Json
  ofertas_nao_monetarias Json?
  black_swans_investigar Json?

  reuniao_data         DateTime?
  reuniao_local        String?
  preparado_por        String?

  created_at           DateTime         @default(now())

  negotiation          StratNegotiation @relation(fields: [negotiation_id], references: [id], onDelete: Cascade)

  @@index([negotiation_id])
  @@map("strat_neg_one_sheets")
}

// ========== NEGOTIATION AI INSIGHT ==========

model NegAIInsight {
  id              String           @id @default(cuid())
  negotiation_id  String?
  tipo            String           // OPORTUNIDADE, RISCO, SUGESTAO, ANALISE, ALERTA, CROSS_NEG, BRIEFING, DEBRIEFING, PRECEDENTE
  titulo          String
  descricao       String           @db.Text
  detalhes        Json?
  acao_sugerida   String?          @db.Text
  framework       String?          // HARVARD, VOSS, TKI, CAMP, KARRASS, GAME_THEORY
  prioridade      String?          // CRITICA, ALTA, MEDIA, BAIXA
  lido            Boolean          @default(false)
  aplicado        Boolean          @default(false)
  expires_at      DateTime?

  created_at      DateTime         @default(now())

  negotiation     StratNegotiation? @relation(fields: [negotiation_id], references: [id], onDelete: Cascade)

  @@index([negotiation_id])
  @@index([tipo])
  @@index([created_at])
  @@map("neg_ai_insights")
}

// ============================================================
// MÓDULO DE RECUPERAÇÃO DE CRÉDITO
// ============================================================

model CreditRecoveryCase {
  id                    String   @id @default(cuid())
  case_id               String?
  person_id             String?

  codigo                String   @unique
  titulo                String
  tipo                  String   // CUMPRIMENTO_SENTENCA, EXECUCAO_TITULO_EXTRAJUDICIAL, EXECUCAO_FISCAL, MONITORIA, BUSCA_APREENSAO, COBRANCA_EXTRAJUDICIAL
  fase                  String   // INVESTIGACAO, PRE_JUDICIAL, EXECUCAO, PENHORA, EXPROPRIACAO, ACORDO, ENCERRADO
  status                String   // ATIVO, SUSPENSO, ACORDO_PARCIAL, ACORDO_TOTAL, PRESCRITO, FRUSTRADO, ENCERRADO_SATISFEITO, ENCERRADO_INSATISFEITO
  prioridade            String   // CRITICA, ALTA, MEDIA, BAIXA

  valor_original        Float
  valor_atualizado      Float?
  valor_honorarios      Float?
  valor_custas          Float?
  valor_total_execucao  Float?
  valor_recuperado      Float?
  valor_bloqueado       Float?
  valor_penhorado       Float?
  percentual_recuperado Float?

  titulo_tipo           String?  // SENTENCA, CHEQUE, NOTA_PROMISSORIA, DUPLICATA, ESCRITURA_PUBLICA, CONTRATO, CDA, CCB, CPR, DEBENTURE
  titulo_numero         String?
  titulo_data_vencimento DateTime?
  titulo_data_prescricao DateTime?

  devedor_nome          String?
  devedor_cpf_cnpj      String?
  devedor_tipo          String?  // PF, PJ
  devedor_endereco      String?
  devedor_telefone      String?
  devedor_email         String?
  devedor_atividade     String?

  score_recuperacao     Int?
  score_fatores         Json?
  risco_prescricao      String?
  risco_insolvencia     String?
  estrategia_ia         String?  @db.Text

  data_constituicao     DateTime?
  data_vencimento       DateTime?
  data_distribuicao     DateTime?
  data_citacao          DateTime?
  data_penhora          DateTime?
  data_acordo           DateTime?
  data_encerramento     DateTime?
  data_proxima_acao     DateTime?
  proxima_acao          String?

  responsavel_id        String?
  observacoes           String?  @db.Text

  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  case_                 Case?    @relation("CaseRecovery", fields: [case_id], references: [id])
  person                Person?  @relation("RecoveryDebtor", fields: [person_id], references: [id])
  responsavel           User?    @relation("RecoveryResponsavel", fields: [responsavel_id], references: [id])
  investigacoes         PatrimonialInvestigation[]
  bens                  AssetFound[]
  acoes_cobranca        CollectionAction[]
  penhoras              Penhora[]
  acordos               RecoveryAgreement[]
  incidentes_desconsidera DesconsideracaoIncident[]
  monitoramentos        DebtorMonitoring[]
  eventos               RecoveryEvent[]
  devedores_solidarios  JointDebtor[]
  investigations_new    Investigation[] @relation("InvestigationCreditCase")

  @@index([case_id])
  @@index([person_id])
  @@index([fase])
  @@index([status])
  @@map("credit_recovery_cases")
}

model PatrimonialInvestigation {
  id                    String   @id @default(cuid())
  recovery_case_id      String

  codigo                String   @unique
  tipo                  String   // COMPLETA, COMPLEMENTAR, ATUALIZACAO, URGENTE
  status                String   // SOLICITADA, EM_ANDAMENTO, CONCLUIDA, CANCELADA
  fase                  String   // PLANEJAMENTO, BUSCA_PUBLICA, BUSCA_JUDICIAL, BUSCA_PRIVADA, OSINT, ANALISE, RELATORIO

  investigar_imoveis    Boolean  @default(true)
  investigar_veiculos   Boolean  @default(true)
  investigar_contas     Boolean  @default(true)
  investigar_empresas   Boolean  @default(true)
  investigar_socios     Boolean  @default(true)
  investigar_grupo_eco  Boolean  @default(true)
  investigar_crypto     Boolean  @default(false)
  investigar_exterior   Boolean  @default(false)
  investigar_osint      Boolean  @default(false)

  total_bens_encontrados Int?
  valor_total_estimado  Float?
  valor_penhoravel_estimado Float?
  patrimonio_visivel    Float?
  patrimonio_oculto_est Float?

  red_flags             Json?
  indicio_fraude        Boolean  @default(false)
  indicio_ocultacao     Boolean  @default(false)
  indicio_grupo_eco     Boolean  @default(false)

  data_solicitacao      DateTime
  data_inicio           DateTime?
  data_conclusao        DateTime?
  prazo_estimado        DateTime?

  responsavel_id        String?
  relatorio_doc_id      String?
  observacoes           String?  @db.Text

  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  recovery_case         CreditRecoveryCase @relation(fields: [recovery_case_id], references: [id], onDelete: Cascade)
  responsavel           User?    @relation("InvestigationResponsavel", fields: [responsavel_id], references: [id])
  buscas                AssetSearch[]
  bens                  AssetFound[]

  @@index([recovery_case_id])
  @@map("patrimonial_investigations")
}

model AssetSearch {
  id                    String   @id @default(cuid())
  investigation_id      String
  recovery_case_id      String?

  sistema               String   // SISBAJUD, RENAJUD, INFOJUD, SNIPER, CNIB, CRI, JUNTA_COMERCIAL, DETRAN, RECEITA_FEDERAL, SERASA, BOA_VISTA, NEOWAY, CNIS_INSS, TSE, ANAC, TRIB_MARITIMO, CCS_BACEN, CENSEC, OSINT_SOCIAL, OSINT_GOOGLE, CRIPTOJUD
  tipo_consulta         String   // INFORMACAO, BLOQUEIO, DESBLOQUEIO, TRANSFERENCIA, RESTRICAO, PENHORA_REGISTRO, TEIMOSINHA

  cpf_cnpj_consultado   String
  nome_consultado       String?
  data_consulta         DateTime
  data_resposta         DateTime?

  status                String   // SOLICITADA, PENDENTE, RESPONDIDA, SEM_RESULTADO, ERRO, PARCIAL
  resultado_resumo      String?  @db.Text
  resultado_detalhado   Json?
  valor_encontrado      Float?
  valor_bloqueado       Float?
  qtd_resultados        Int?

  numero_processo       String?
  numero_ordem_judicial String?
  juizo                 String?

  teimosinha_ativa      Boolean  @default(false)
  teimosinha_dias       Int?
  teimosinha_inicio     DateTime?
  teimosinha_fim        DateTime?
  teimosinha_reiteracoes Int?

  observacoes           String?  @db.Text
  created_at            DateTime @default(now())

  investigation         PatrimonialInvestigation @relation(fields: [investigation_id], references: [id], onDelete: Cascade)

  @@index([investigation_id])
  @@index([sistema])
  @@map("asset_searches")
}

model AssetFound {
  id                    String   @id @default(cuid())
  recovery_case_id      String
  investigation_id      String?

  tipo                  String   // IMOVEL_URBANO, IMOVEL_RURAL, VEICULO, CONTA_BANCARIA, APLICACAO_FINANCEIRA, PARTICIPACAO_SOCIETARIA, CREDITO_JUDICIAL, MARCA_PATENTE, AERONAVE, EMBARCACAO, MAQUINARIO, SEMOVENTE, CRIPTOATIVO, DIREITO_CREDITORIO, PRECATORIO, OUTROS
  subtipo               String?

  descricao             String
  identificador         String?
  localizacao           String?

  valor_estimado        Float?
  valor_avaliacao       Float?
  valor_mercado         Float?
  valor_liquidacao      Float?

  status                String   // LOCALIZADO, VERIFICANDO, CONFIRMADO, PENHORADO, BLOQUEADO, INDISPONIVEL, ARREMATADO, ADJUDICADO, LIBERADO, BEM_FAMILIA, IMPENHORAVEL, GRAVADO, ALIENADO
  penhoravel            Boolean  @default(true)
  motivo_impenhoravel   String?

  titular_nome          String?
  titular_cpf_cnpj      String?
  titular_relacao       String?  // DEVEDOR, CONJUGE, SOCIO, EMPRESA, LARANJA, TERCEIRO

  onus                  Json?
  possui_onus           Boolean  @default(false)

  data_localizacao      DateTime
  data_penhora          DateTime?
  data_avaliacao        DateTime?
  data_expropriacao     DateTime?

  fonte                 String?
  documento_id          String?
  observacoes           String?  @db.Text

  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  recovery_case         CreditRecoveryCase @relation(fields: [recovery_case_id], references: [id], onDelete: Cascade)
  investigation         PatrimonialInvestigation? @relation(fields: [investigation_id], references: [id])
  penhora               Penhora?

  @@index([recovery_case_id])
  @@index([tipo])
  @@map("assets_found")
}

model CollectionAction {
  id                    String   @id @default(cuid())
  recovery_case_id      String

  tipo                  String   // NOTIFICACAO_EXTRAJUDICIAL, PROTESTO, NEGATIVACAO, MEDIACAO, PETICAO_INICIAL, CITACAO, PENHORA_ONLINE, ARRESTO, SEQUESTRO, AVALIACAO, LEILAO, ADJUDICACAO, IDPJ, ACAO_PAULIANA, FRAUDE_EXECUCAO, HABILITACAO_CREDITO, RECURSO, EMBARGOS, IMPUGNACAO, ACORDO, CUMPRIMENTO_ACORDO, PARCELAMENTO_916
  categoria             String   // EXTRAJUDICIAL, JUDICIAL_CONHECIMENTO, JUDICIAL_EXECUCAO, CAUTELAR, INCIDENTAL, RECURSAL, ACORDO

  descricao             String   @db.Text
  data_acao             DateTime
  data_prazo            DateTime?
  data_resultado        DateTime?

  status                String   // PLANEJADA, EM_EXECUCAO, AGUARDANDO_RESPOSTA, DEFERIDA, INDEFERIDA, CUMPRIDA, FRUSTRADA, CANCELADA
  resultado             String?  @db.Text
  valor_envolvido       Float?
  valor_obtido          Float?

  protesto_cartorio     String?
  protesto_protocolo    String?
  protesto_data_intimacao DateTime?
  protesto_data_lavratura DateTime?
  protesto_pago         Boolean?

  negativacao_bureau    String?
  negativacao_protocolo String?
  negativacao_data_inclusao DateTime?
  negativacao_data_exclusao DateTime?

  leilao_leiloeiro      String?
  leilao_data_1praca    DateTime?
  leilao_data_2praca    DateTime?
  leilao_valor_minimo   Float?
  leilao_valor_arrematacao Float?
  leilao_arrematante    String?
  leilao_comissao       Float?

  documento_id          String?
  responsavel_id        String?
  observacoes           String?  @db.Text

  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  recovery_case         CreditRecoveryCase @relation(fields: [recovery_case_id], references: [id], onDelete: Cascade)
  responsavel           User?    @relation("CollectionActionResponsavel", fields: [responsavel_id], references: [id])

  @@index([recovery_case_id])
  @@index([tipo])
  @@map("collection_actions")
}

model Penhora {
  id                    String   @id @default(cuid())
  recovery_case_id      String
  asset_id              String?  @unique

  tipo                  String   // ONLINE_SISBAJUD, IMOVEL, VEICULO, FATURAMENTO, ROSTO_AUTOS, ACOES, RECEBIVEIS, SEMOVENTES, CRIPTOATIVOS
  status                String   // SOLICITADA, EFETIVADA, PARCIAL, IMPUGNADA, MANTIDA, REDUZIDA, SUBSTITUIDA, CANCELADA, CONVERTIDA_RENDA, LIBERADA

  valor_solicitado      Float?
  valor_efetivado       Float?
  valor_excesso         Float?

  data_solicitacao      DateTime
  data_efetivacao       DateTime?
  data_intimacao_devedor DateTime?
  data_impugnacao       DateTime?
  data_decisao_impugnacao DateTime?

  auto_penhora_numero   String?
  depositario_nome      String?
  depositario_cpf       String?

  avaliacao_valor       Float?
  avaliacao_data        DateTime?
  avaliacao_por         String?

  numero_processo       String?
  observacoes           String?  @db.Text

  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  recovery_case         CreditRecoveryCase @relation(fields: [recovery_case_id], references: [id], onDelete: Cascade)
  asset                 AssetFound? @relation(fields: [asset_id], references: [id])

  @@index([recovery_case_id])
  @@map("penhoras")
}

model RecoveryAgreement {
  id                    String   @id @default(cuid())
  recovery_case_id      String

  tipo                  String   // PAGAMENTO_INTEGRAL, PARCELAMENTO, DACAO_PAGAMENTO, DESCONTO, NOVACAO, TRANSACAO
  status                String   // PROPOSTA, NEGOCIANDO, FORMALIZADO, EM_CUMPRIMENTO, CUMPRIDO, DESCUMPRIDO, RESCINDIDO

  valor_divida_original Float
  valor_acordo          Float
  desconto_percentual   Float?
  entrada               Float?
  parcelas              Int?
  valor_parcela         Float?
  taxa_juros_mensal     Float?
  dia_vencimento        Int?

  dacao_bem_descricao   String?
  dacao_bem_valor       Float?

  parcelas_pagas        Int?     @default(0)
  valor_pago_total      Float?   @default(0)
  parcelas_atraso       Int?     @default(0)
  data_ultima_parcela   DateTime?
  proxima_parcela       DateTime?

  data_proposta         DateTime
  data_formalizacao     DateTime?
  data_inicio_pagamento DateTime?
  data_ultima_cobranca  DateTime?

  clausulas_especiais   String?  @db.Text
  documento_id          String?
  responsavel_id        String?

  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  recovery_case         CreditRecoveryCase @relation(fields: [recovery_case_id], references: [id], onDelete: Cascade)
  responsavel           User?    @relation("AgreementResponsavel", fields: [responsavel_id], references: [id])
  parcelas_detalhes     AgreementInstallment[]

  @@index([recovery_case_id])
  @@map("recovery_agreements")
}

model AgreementInstallment {
  id                    String   @id @default(cuid())
  agreement_id          String

  numero                Int
  valor                 Float
  data_vencimento       DateTime
  data_pagamento        DateTime?
  valor_pago            Float?
  status                String   // PENDENTE, PAGA, ATRASADA, PAGA_COM_ATRASO, RENEGOCIADA
  dias_atraso           Int?
  multa_atraso          Float?
  comprovante_id        String?

  created_at            DateTime @default(now())
  agreement             RecoveryAgreement @relation(fields: [agreement_id], references: [id], onDelete: Cascade)

  @@index([agreement_id])
  @@map("agreement_installments")
}

model DesconsideracaoIncident {
  id                    String   @id @default(cuid())
  recovery_case_id      String

  tipo                  String   // DIRETA, INVERSA, EXTENSAO_GRUPO_ECONOMICO
  teoria                String   // MAIOR_CC50, MENOR_CDC28, TRABALHISTA_CLT2, AMBIENTAL
  status                String   // ANALISE_VIABILIDADE, PREPARANDO, PETICIONADO, CITADO, RESPONDIDO, INSTRUINDO, DEFERIDO, INDEFERIDO, RECURSO

  fundamento_legal      String
  hipotese              String   // DESVIO_FINALIDADE, CONFUSAO_PATRIMONIAL, OBSTACULO_CDC, GRUPO_ECONOMICO

  evidencias            Json?
  confusao_patrimonial  Json?
  desvio_finalidade     Json?

  alvos                 Json?

  valor_alcancado       Float?
  decisao_resumo        String?  @db.Text
  data_decisao          DateTime?
  recurso               String?

  data_peticao          DateTime?
  data_citacao_alvos    DateTime?
  data_resposta         DateTime?
  prazo_resposta        DateTime?

  documento_peticao_id  String?
  numero_incidente      String?

  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  recovery_case         CreditRecoveryCase @relation(fields: [recovery_case_id], references: [id], onDelete: Cascade)

  @@index([recovery_case_id])
  @@map("desconsideracao_incidents")
}

model JointDebtor {
  id                    String   @id @default(cuid())
  recovery_case_id      String
  person_id             String?

  nome                  String
  cpf_cnpj              String?
  tipo_responsabilidade String   // DEVEDOR_PRINCIPAL, AVALISTA, FIADOR, SOCIO, ADMINISTRADOR, GRUPO_ECONOMICO, SUCESSOR, CONJUGE
  fundamentacao         String?  @db.Text

  patrimonio_estimado   Float?
  status                String   // IDENTIFICADO, NOTIFICADO, CITADO, EXECUTANDO, ACORDO, INSOLVENTE

  created_at            DateTime @default(now())

  recovery_case         CreditRecoveryCase @relation(fields: [recovery_case_id], references: [id], onDelete: Cascade)
  person                Person?  @relation("JointDebtorPerson", fields: [person_id], references: [id])

  @@index([recovery_case_id])
  @@map("joint_debtors")
}

model DebtorMonitoring {
  id                    String   @id @default(cuid())
  recovery_case_id      String

  tipo                  String   // PROCESSO_JUDICIAL, DIARIO_OFICIAL, CREDITO_BUREAU, PATRIMONIO, SOCIETARIO, REDES_SOCIAIS, CERTIDAO_PROTESTO
  fonte                 String   // DATAJUD, JUDIT, ESCAVADOR, SERASA, NEOWAY, ARISP, CENPROT, MANUAL

  ativo                 Boolean  @default(true)
  frequencia            String   // TEMPO_REAL, DIARIO, SEMANAL, MENSAL

  ultima_verificacao    DateTime?
  ultimo_resultado      Json?
  alertas_pendentes     Int?     @default(0)

  configuracao          Json?
  webhook_url           String?

  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  recovery_case         CreditRecoveryCase @relation(fields: [recovery_case_id], references: [id], onDelete: Cascade)
  alertas               MonitoringAlert[]

  @@index([recovery_case_id])
  @@map("debtor_monitorings")
}

model MonitoringAlert {
  id                    String   @id @default(cuid())
  monitoring_id         String

  tipo                  String   // NOVO_BEM, BEM_ALIENADO, NOVO_PROCESSO, FALENCIA, RECUPERACAO_JUDICIAL, MUDANCA_SOCIETARIA, NOVO_EMPREGO, SCORE_ALTERADO, PROTESTO_PAGO, PUBLICACAO_DO, ESTILO_VIDA
  severidade            String   // CRITICA, ALTA, MEDIA, BAIXA, INFO

  titulo                String
  descricao             String   @db.Text
  dados                 Json?

  lido                  Boolean  @default(false)
  acao_tomada           String?  @db.Text
  data_acao             DateTime?

  created_at            DateTime @default(now())

  monitoring            DebtorMonitoring @relation(fields: [monitoring_id], references: [id], onDelete: Cascade)

  @@index([monitoring_id])
  @@map("monitoring_alerts")
}

model RecoveryEvent {
  id                    String   @id @default(cuid())
  recovery_case_id      String

  data                  DateTime
  tipo                  String   // NOTA, REUNIAO, TELEFONEMA, EMAIL, WHATSAPP, DESPACHO, DECISAO, SENTENCA, PETICAO, AUDIENCIA, DILIGENCIA, PUBLICACAO, ALERTA_IA, MUDANCA_FASE

  descricao             String   @db.Text
  valor_mencionado      Float?
  responsavel_id        String?
  documento_id          String?

  analise_ia            String?  @db.Text
  sentimento            String?  // POSITIVO, NEUTRO, NEGATIVO
  acao_recomendada      String?  @db.Text

  created_at            DateTime @default(now())

  recovery_case         CreditRecoveryCase @relation(fields: [recovery_case_id], references: [id], onDelete: Cascade)
  responsavel           User?    @relation("RecoveryEventResponsavel", fields: [responsavel_id], references: [id])

  @@index([recovery_case_id])
  @@map("recovery_events")
}

// ============================================================
// DEADLINE / COURT CALENDAR / PROCESS PARTY MODELS
// ============================================================

model DeadlineNew {
  id                          String    @id @default(cuid())
  case_id                     String?
  case_                       Case?     @relation(fields: [case_id], references: [id])
  rj_case_id                  String?
  recovery_case_id            String?
  negotiation_id              String?

  codigo                      String    @unique
  titulo                      String
  descricao                   String?   @db.Text

  // Tipo do prazo (String, not enum)
  tipo                        String    // CONTESTACAO, RECONVENCAO, REPLICA, APELACAO, AGRAVO_INSTRUMENTO, AGRAVO_INTERNO, EMBARGOS_DECLARACAO, RECURSO_ESPECIAL, RECURSO_EXTRAORDINARIO, EMBARGOS_EXECUCAO, IMPUGNACAO_CUMPRIMENTO, EMENDA_PI, MANIFESTACAO_DOCUMENTOS, ESPECIFICACAO_PROVAS, ALEGACOES_FINAIS, PAGAMENTO_VOLUNTARIO, PAGAMENTO_EXECUCAO, PARCELAMENTO_916, HABILITACAO_CREDITO_RJ, PLANO_RECUPERACAO, OBJECAO_PLANO, IMPUGNACAO_CREDITO_RJ, STAY_PERIOD, AGC, SUPERVISAO_RJ, INVENTARIO_DECLARACOES, MANDADO_SEGURANCA, ACAO_RESCISORIA, EXECUCAO_FISCAL_EMBARGOS, TUTELA_ANTECIPADA_ADITAMENTO, TUTELA_CAUTELAR_PRINCIPAL, MONITORIA_EMBARGOS, IMPEDIMENTO_SUSPEICAO, SUBSTITUICAO_BEM, COMPROVACAO_IMPENHORAVEL, ALIMENTOS_PAGAR_JUSTIFICAR, PERITO_PROPOSTA, MANIFESTACAO_LAUDO, ASSISTENTE_TECNICO, CUSTOM
  categoria                   String    // PARTE, RECURSAL, JUIZ, PERITO, OUTROS, RJ_ESTATUTARIO, RJ_RECURSAL, MATERIAL
  contagem_tipo               String    // DIAS_UTEIS, DIAS_CORRIDOS

  prazo_dias                  Int
  prazo_dias_efetivo          Int?
  prazo_horas                 Int?

  // Dobra de prazo
  dobra_aplicada              Boolean   @default(false)
  dobra_motivo                String?
  dobra_fator                 Float?

  lei_especifica_prazo        Boolean   @default(false)
  interrompido_embargos       Boolean   @default(false)
  embargos_data_oposicao      DateTime?
  embargos_data_decisao       DateTime?
  prazo_reiniciou             Boolean   @default(false)
  dias_restantes_pre_embargos Int?

  // Datas de contagem
  data_evento_gatilho         DateTime
  metodo_intimacao            String?
  data_disponibilizacao       DateTime?
  data_publicacao             DateTime?
  data_inicio_contagem        DateTime
  data_fim_prazo              DateTime
  data_fim_prazo_fatal        DateTime?
  data_cumprimento            DateTime?

  suspensoes_aplicadas        Json?
  recesso_impactou            Boolean   @default(false)

  // Status e prioridade (String, not enum)
  status                      String    // FUTURO, CORRENDO, PROXIMO, URGENTE, HOJE, VENCIDO, CUMPRIDO, CANCELADO, SUSPENSO, INTERROMPIDO
  prioridade                  String    // FATAL, ALTA, MEDIA, BAIXA

  // Tribunal / jurisdicao
  tribunal_codigo             String?
  tribunal_nome               String?
  uf                          String?
  municipio                   String?
  municipio_ibge              String?
  vara                        String?
  numero_processo             String?

  // Responsaveis
  responsavel_id              String?
  responsavel                 User?     @relation("deadline_responsavel", fields: [responsavel_id], references: [id])
  responsavel_backup_id       String?
  responsavel_backup          User?     @relation("deadline_backup", fields: [responsavel_backup_id], references: [id])

  // Notificacoes de antecedencia
  notificado_d7               Boolean   @default(false)
  notificado_d3               Boolean   @default(false)
  notificado_d1               Boolean   @default(false)
  notificado_d0               Boolean   @default(false)
  notificado_vencido          Boolean   @default(false)

  // Calculo e conferencia
  calculado_por               String?
  calculado_em                DateTime?
  conferido_por               String?
  conferido_em                DateTime?
  log_calculo                 Json?

  // Encadeamento de prazos
  parent_deadline_id          String?
  parent_deadline             DeadlineNew?  @relation("deadline_chain", fields: [parent_deadline_id], references: [id])
  child_deadlines             DeadlineNew[] @relation("deadline_chain")

  // IA e observacoes
  sugestao_ia                 String?   @db.Text
  risco_ia                    String?
  observacoes                 String?   @db.Text
  documento_id                String?

  created_at                  DateTime  @default(now())
  updated_at                  DateTime  @updatedAt

  // Relations
  notificacoes                DeadlineNotification[]
  historico                   DeadlineHistory[]
  workspace                   DeadlineWorkspace?

  @@index([case_id])
  @@index([status])
  @@index([data_fim_prazo])
  @@index([responsavel_id])
  @@map("deadlines_new")
}

model CourtCalendar {
  id                String    @id @default(cuid())
  tribunal_codigo   String
  tribunal_nome     String
  tribunal_tipo     String    // STF, STJ, TST, TSE, STM, TJ, TRF, TRT, TRE
  uf                String?
  ano               Int
  portaria_numero   String?
  portaria_data     DateTime?
  portaria_url      String?
  atualizado_em     DateTime
  atualizado_por    String?

  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt

  // Relations
  feriados          CourtHoliday[]
  suspensoes        CourtSuspension[]
  repositories      CalendarRepository[]

  @@unique([tribunal_codigo, ano])
  @@map("court_calendars")
}

model CourtHoliday {
  id                    String        @id @default(cuid())
  calendar_id           String
  calendar              CourtCalendar @relation(fields: [calendar_id], references: [id], onDelete: Cascade)

  data                  DateTime
  nome                  String
  tipo                  String        // NACIONAL, ESTADUAL, MUNICIPAL, FORENSE, PONTO_FACULTATIVO
  uf                    String?
  municipio             String?
  municipio_ibge        String?

  suspende_expediente   Boolean       @default(true)
  expediente_parcial    Boolean       @default(false)
  horario_expediente    String?
  prazos_prorrogados    Boolean       @default(true)
  fundamento_legal      String?
  observacoes           String?

  created_at            DateTime      @default(now())

  @@index([data])
  @@index([calendar_id, data])
  @@map("court_holidays")
}

model CourtSuspension {
  id                    String        @id @default(cuid())
  calendar_id           String
  calendar              CourtCalendar @relation(fields: [calendar_id], references: [id], onDelete: Cascade)

  tipo                  String        // RECESSO_DEZ_JAN, FERIAS_JULHO, SUSPENSAO_PRAZOS_ART220, SUSPENSAO_PORTARIA, INDISPONIBILIDADE_SISTEMA, LUTO_OFICIAL, CALAMIDADE, ELEICOES, OPERACAO_ESPECIAL
  data_inicio           DateTime
  data_fim              DateTime

  suspende_prazos       Boolean       @default(true)
  suspende_audiencias   Boolean       @default(true)
  suspende_sessoes      Boolean       @default(true)
  plantao_disponivel    Boolean       @default(false)
  horario_plantao       String?

  sistema_afetado       String?
  duracao_minutos       Int?
  certidao_numero       String?
  prorroga_prazo        Boolean       @default(false)
  fundamento_legal      String?

  nome                  String
  observacoes           String?

  created_at            DateTime      @default(now())

  @@index([data_inicio, data_fim])
  @@index([calendar_id, data_inicio])
  @@map("court_suspensions")
}

model DeadlineNotification {
  id                    String      @id @default(cuid())
  deadline_id           String
  deadline              DeadlineNew @relation(fields: [deadline_id], references: [id], onDelete: Cascade)

  tipo                  String      // D_MINUS_7, D_MINUS_3, D_MINUS_1_FATAL, D_ZERO, VENCIDO, ESCALACAO
  canal                 String      // EMAIL, SMS, WHATSAPP, PUSH, IN_APP, TELEFONE
  destinatario_id       String?
  destinatario_tipo     String      // RESPONSAVEL, BACKUP, GESTOR, SOCIO
  destinatario_email    String?
  destinatario_telefone String?

  data_envio            DateTime
  data_leitura          DateTime?
  status                String      // PENDENTE, ENVIADO, ENTREGUE, LIDO, ERRO
  mensagem              String?     @db.Text
  erro_detalhes         String?

  created_at            DateTime    @default(now())

  @@index([deadline_id])
  @@map("deadline_notifications")
}

model DeadlineHistory {
  id                    String      @id @default(cuid())
  deadline_id           String
  deadline              DeadlineNew @relation(fields: [deadline_id], references: [id], onDelete: Cascade)

  acao                  String      // CRIADO, CALCULADO, RECALCULADO, INTERROMPIDO_EMBARGOS, REINICIADO_EMBARGOS, SUSPENSO_RECESSO, RETOMADO_RECESSO, SUSPENSO_INDISPONIBILIDADE, PRORROGADO, CUMPRIDO, CANCELADO, CONFERIDO, EDITADO_MANUAL, NOTIFICACAO_ENVIADA
  dados_antes           Json?
  dados_depois          Json?
  usuario_id            String?
  motivo                String?

  created_at            DateTime    @default(now())

  @@index([deadline_id])
  @@map("deadline_history")
}

model DeadlineCatalog {
  id                        String    @id @default(cuid())
  codigo                    String    @unique
  nome                      String
  descricao                 String    @db.Text

  dias                      Int
  contagem_tipo             String    // DIAS_UTEIS, DIAS_CORRIDOS
  tipo_prazo                String    // PEREMPTORIO, DILATATORIO, IMPROPRIO
  categoria                 String    // PARTE, RECURSAL, JUIZ, MP, PERITO, AUXILIAR, RJ_ESTATUTARIO
  subcategoria              String?

  artigo                    String
  lei                       String
  paragrafos                String?

  admite_dobra              Boolean   @default(true)
  excecao_dobra             String?
  admite_litisconsorcio     Boolean   @default(true)
  excecao_litisconsorcio    String?

  efeito_nao_cumprimento    String?
  efeito_recursal           String?

  termo_inicial             String
  observacoes               String?   @db.Text
  jurisprudencia            String?   @db.Text

  prazo_resposta_dias       Int?
  prazo_resposta_ref        String?

  ativo                     Boolean   @default(true)
  is_system                 Boolean   @default(false)

  created_at                DateTime  @default(now())
  updated_at                DateTime  @updatedAt

  @@map("deadline_catalog")
}

model DeadlineTypeCatalog {
  id                    String           @id @default(cuid())
  type                  DeadlineType     @unique
  displayName           String
  shortName             String
  category              DeadlineCategory
  legalBasis            String?          // Ex: "Art. 335, CPC"
  defaultDays           Int
  countingType          CountingType     @default(DIAS_UTEIS)
  isExtendable          Boolean          @default(false)
  isFatal               Boolean          @default(false)
  defaultPriority       String           @default("MEDIA") // CRITICA, URGENTE, ALTA, MEDIA, BAIXA
  color                 String           @default("#6B7280")
  icon                  String?
  doubleForPublicEntity Boolean          @default(true)
  doubleForDefensoria   Boolean          @default(true)
  specialRules          Json?            // Regras especiais como prorrogação, condições, etc.
  isActive              Boolean          @default(true)
  sortOrder             Int              @default(0)

  triggeredByPieces     DeadlinePieceTrigger[]

  created_at            DateTime         @default(now())
  updated_at            DateTime         @updatedAt

  @@index([category])
  @@index([isActive, sortOrder])
  @@map("deadline_type_catalog")
}

model DeadlinePieceTrigger {
  id                    String               @id @default(cuid())
  deadlineTypeId        String
  deadlineTypeCatalog   DeadlineTypeCatalog   @relation(fields: [deadlineTypeId], references: [id], onDelete: Cascade)
  deadlineType          DeadlineType
  triggerPieceType      PieceType
  triggerDescription    String                // Ex: "Contestação após citação"
  targetRole            PartyRole             @default(REU)
  isSuggestion          Boolean               @default(true)
  isDefault             Boolean               @default(false)
  notes                 String?

  created_at            DateTime              @default(now())

  @@unique([deadlineType, triggerPieceType, targetRole])
  @@index([triggerPieceType])
  @@map("deadline_piece_triggers")
}

model ProcessParty {
  id                        String    @id @default(cuid())
  case_id                   String
  case_                     Case      @relation(fields: [case_id], references: [id], onDelete: Cascade)
  person_id                 String?
  person                    Person?   @relation(fields: [person_id], references: [id])

  nome                      String
  cpf_cnpj                  String?

  polo                      String    // AUTOR, REU, TERCEIRO, ASSISTENTE, LITISCONSORTE, MP, AMICUS
  tipo_parte                String    // PRIVADO, FAZENDA_FEDERAL, FAZENDA_ESTADUAL, FAZENDA_MUNICIPAL, AUTARQUIA, FUNDACAO_PUBLICA, MP_FEDERAL, MP_ESTADUAL, DEFENSORIA, EMPRESA_PUBLICA, SEM

  prazo_dobro               Boolean   @default(false)
  fundamento_dobro          String?
  advogado_escritorio       String?
  advogados_diferentes      Boolean   @default(false)
  processo_eletronico       Boolean   @default(true)

  created_at                DateTime  @default(now())

  @@index([case_id])
  @@map("process_parties")
}

model CalendarRepository {
  id                    String         @id @default(cuid())
  tribunal_codigo       String
  tribunal_nome         String
  tribunal_tipo         String         // STF, STJ, TJ, TRF, TRT, TRE, etc.
  uf                    String?
  ano                   Int
  tipo_documento        String         // PORTARIA, RESOLUCAO, PROVIMENTO, ATO
  numero_documento      String?
  data_documento        DateTime?
  ementa                String?        @db.Text
  arquivo_url           String?
  arquivo_nome          String?
  texto_extraido        String?        @db.Text
  status                String         @default("PENDENTE") // PENDENTE, PROCESSANDO, PROCESSADO, ERRO
  feriados_extraidos    Int            @default(0)
  suspensoes_extraidas  Int            @default(0)
  calendar_id           String?
  calendar              CourtCalendar? @relation(fields: [calendar_id], references: [id])
  processado_por_ia     Boolean        @default(false)
  erro_processamento    String?
  uploaded_by           String?
  created_at            DateTime       @default(now())
  updated_at            DateTime       @updatedAt

  @@index([tribunal_codigo, ano])
  @@index([status])
  @@map("calendar_repositories")
}

// ============================================================
// EMAIL INTEGRATION
// ============================================================

model MicrosoftAccount {
  id            String   @id @default(cuid())
  userId        String   @unique
  email         String
  accessToken   String   @db.Text
  refreshToken  String   @db.Text
  expiresAt     DateTime
  scope         String
  status        String   @default("CONNECTED") // CONNECTED, EXPIRED, DISCONNECTED
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("microsoft_accounts")
}

model EmailLink {
  id            String    @id @default(cuid())
  outlookMsgId  String
  subject       String?
  fromEmail     String
  fromName      String?
  receivedAt    DateTime?
  caseId        String?
  projectId     String?
  userId        String
  notes         String?
  createdAt     DateTime  @default(now())
  case          Case?     @relation(fields: [caseId], references: [id])
  project       Project?  @relation(fields: [projectId], references: [id])
  user          User      @relation(fields: [userId], references: [id])

  @@unique([outlookMsgId, userId])
  @@index([caseId])
  @@index([projectId])
  @@index([userId])
  @@map("email_links")
}

// ============================================================
// EMAIL ACTIVITY (generate activities/deadlines from email)
// ============================================================

model EmailActivity {
  id                String              @id @default(cuid())
  outlook_message_id String
  email_subject     String?
  email_from        String?
  email_received_at DateTime?

  tipo              EmailActivityType
  titulo            String
  descricao         String?             @db.Text
  status            EmailActivityStatus @default(PENDENTE)

  // Links
  case_id           String?
  case_             Case?               @relation(fields: [case_id], references: [id])
  project_id        String?
  project           Project?            @relation(fields: [project_id], references: [id])

  // Generated items
  deadline_id       String?             @unique
  deadline          Deadline?           @relation("DeadlineFromEmail", fields: [deadline_id], references: [id])
  calendar_event_id String?             @unique
  calendar_event    CalendarEvent?      @relation("CalendarEventFromEmail", fields: [calendar_event_id], references: [id])

  // Deadline-specific fields
  data_limite       DateTime?
  contagem_tipo     DeadlineCountType?
  dias_prazo        Int?

  // Meeting-specific fields
  data_evento       DateTime?
  local_evento      String?
  link_virtual      String?

  // Responsibility
  responsavel_id    String?
  responsavel       User?               @relation("ActivityResponsible", fields: [responsavel_id], references: [id])

  // Metadata
  extracted_data    Json?
  created_by_id     String
  created_by        User                @relation("ActivityCreator", fields: [created_by_id], references: [id])
  created_at        DateTime            @default(now())
  updated_at        DateTime            @updatedAt

  // Relations
  reminders         EmailActivityReminder[]

  @@index([outlook_message_id])
  @@index([case_id])
  @@index([project_id])
  @@index([responsavel_id])
  @@index([status])
  @@map("email_activities")
}

model EmailActivityReminder {
  id                String          @id @default(cuid())
  email_activity_id String
  email_activity    EmailActivity   @relation(fields: [email_activity_id], references: [id], onDelete: Cascade)
  channel           ReminderChannel
  offset_minutes    Int
  sent              Boolean         @default(false)
  sent_at           DateTime?

  @@map("email_activity_reminders")
}

// ============================================================
// WHATSAPP INTEGRATION
// ============================================================

model WhatsAppConversation {
  id                  String    @id @default(cuid())
  phone_number        String    @unique
  person_id           String?
  person              Person?   @relation(fields: [person_id], references: [id])
  case_id             String?
  case_               Case?     @relation(fields: [case_id], references: [id])
  project_id          String?
  project             Project?  @relation(fields: [project_id], references: [id])
  contact_name        String?
  last_message        String?
  last_message_at     DateTime?
  last_interaction_at DateTime?
  unread_count        Int       @default(0)
  status              String    @default("ACTIVE") // ACTIVE, ARCHIVED
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt

  messages WhatsAppMessage[]

  @@index([person_id])
  @@index([case_id])
  @@index([project_id])
  @@index([status])
  @@map("whatsapp_conversations")
}

model WhatsAppMessage {
  id              String   @id @default(cuid())
  conversation_id String
  conversation    WhatsAppConversation @relation(fields: [conversation_id], references: [id], onDelete: Cascade)
  direction       String   // INBOUND, OUTBOUND
  type            String   // TEXT, IMAGE, DOCUMENT, AUDIO, VIDEO, TEMPLATE
  content         String?  @db.Text
  media_url       String?
  media_filename  String?
  template_name   String?
  wa_message_id   String?  @unique
  status          String   @default("SENT") // SENT, DELIVERED, READ, FAILED
  ocr_text        String?  @db.Text
  ocr_processed   Boolean  @default(false)
  created_at      DateTime @default(now())

  @@index([conversation_id])
  @@index([wa_message_id])
  @@map("whatsapp_messages")
}

model WhatsAppTemplate {
  id               String   @id @default(cuid())
  name             String   @unique
  display_name     String
  category         String   // UTILITY, MARKETING
  language         String   @default("pt_BR")
  body_text        String   @db.Text
  variables        Json?
  approval_status  String   @default("PENDING") // PENDING, APPROVED, REJECTED
  rejection_reason String?
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  @@map("whatsapp_templates")
}

// ============================================================
// CRJ — NEGOCIAÇÕES INDIVIDUAIS COM CREDORES DA RJ
// ============================================================

enum CRJNegotiationType {
  ACORDO_SIMPLES
  CREDOR_PARCEIRO
  CESSAO_CREDITOS
  SUBCLASSE_ESPECIAL
  OUTRO
}

enum CRJNegotiationStatus {
  MAPEAMENTO
  CONTATO_INICIAL
  PROPOSTA_ENVIADA
  CONTRAPROPOSTA
  MEDIACAO
  ACORDO_VERBAL
  FORMALIZACAO
  HOMOLOGACAO
  CONCLUIDA
  SUSPENSA
  CANCELADA
}

enum CRJPriority {
  BAIXA
  MEDIA
  ALTA
  CRITICA
}

enum CRJRoundType {
  PROPOSTA_INICIAL
  CONTRAPROPOSTA_ESCRITORIO
  CONTRAPROPOSTA_CREDOR
  REUNIAO
  MEDIACAO
  AJUSTE
  ACORDO_FINAL
}

enum CRJRoundOutcome {
  PENDENTE
  ACEITA
  REJEITADA
  CONTRAPROPOSTA
  ADIADA
}

enum CRJTemplateType {
  ACORDO_SIMPLES
  CREDOR_PARCEIRO_ROTATIVO
  CESSAO_CREDITOS
  SUBCLASSE_MODALIDADES
  CUSTOMIZADO
}

enum CRJProposalStatus {
  RASCUNHO
  APROVADA_INTERNA
  ENVIADA
  RESPONDIDA
  ACEITA
  REJEITADA
}

enum CRJEventType {
  CRIACAO
  MUDANCA_STATUS
  PROPOSTA_ENVIADA
  PROPOSTA_RECEBIDA
  REUNIAO
  LIGACAO
  EMAIL_ENVIADO
  EMAIL_RECEBIDO
  DOCUMENTO_GERADO
  ACORDO
  OBSERVACAO
  LEMBRETE
  CONTATO_CREDOR
}

enum CRJInstallmentStatus {
  PENDENTE
  PAGO
  ATRASADO
  RENEGOCIADO
}

enum CRJEmailDirection {
  ENVIADO
  RECEBIDO
}

enum CRJAIInsightType {
  OPORTUNIDADE
  RISCO
  SUGESTAO
  ANALISE
  CONEXAO
  URGENCIA
  CHECKLIST
}

enum CRJAIActionType {
  GERAR_PROPOSTA
  ENVIAR_EMAIL
  NOVA_RODADA
  MUDAR_STATUS
  ABRIR_NEGOCIACAO
  FOLLOW_UP
  VER_NEGOCIACAO
  GERAR_CHECKLIST
}

// ============================================================
// CRJ MODELS
// ============================================================

model CRJNegotiation {
  id                    String               @id @default(cuid())

  // Links to existing entities
  jrc_id                String
  jrc                   JudicialRecoveryCase @relation(fields: [jrc_id], references: [id], onDelete: Cascade)
  creditor_id           String
  creditor              RJCreditor           @relation(fields: [creditor_id], references: [id], onDelete: Cascade)
  assigned_to_id        String?
  assigned_to           User?                @relation("CRJNegAssignee", fields: [assigned_to_id], references: [id])

  // Identification
  title                 String
  type                  CRJNegotiationType   @default(ACORDO_SIMPLES)
  status                CRJNegotiationStatus @default(MAPEAMENTO)
  priority              CRJPriority          @default(MEDIA)

  // Credit data (pulled from QGC)
  credit_amount         BigInt               @default(0)
  credit_class          String               @default("")

  // Proposal values
  proposed_amount       BigInt?
  agreed_amount         BigInt?
  discount_percentage   Float?
  installments          Int?

  // Rotating credit
  has_rotating_credit   Boolean              @default(false)
  rotating_credit_value BigInt?
  rotating_credit_cycles Int?

  // Credit insurance
  has_credit_insurance  Boolean              @default(false)
  insurer_name          String?

  // Assignment (cessão)
  has_assignment        Boolean              @default(false)
  assignment_partner    String?
  assignment_percentage Float?

  // Payment terms
  entry_payment         BigInt?
  entry_date            DateTime?
  grace_period_months   Int?
  payment_term_years    Int?
  monetary_correction   String?

  // Notes
  notes                 String?              @db.Text

  // Dates
  start_date            DateTime             @default(now())
  target_date           DateTime?
  closed_date           DateTime?

  // Tags
  tags                  String[]             @default([])

  created_at            DateTime             @default(now())
  updated_at            DateTime             @updatedAt

  // Relations
  rounds                CRJNegotiationRound[]
  proposals             CRJProposal[]
  events                CRJNegotiationEvent[]
  emails                CRJNegotiationEmail[]
  installment_schedule  CRJInstallmentSchedule[]
  collective_round_links CRJCollectiveRoundLink[]
  ai_insights           CRJAIInsight[]

  @@index([jrc_id])
  @@index([creditor_id])
  @@index([status])
  @@index([type])
  @@index([assigned_to_id])
  @@map("crj_negotiations")
}

model CRJNegotiationRound {
  id                    String               @id @default(cuid())
  negotiation_id        String
  negotiation           CRJNegotiation       @relation(fields: [negotiation_id], references: [id], onDelete: Cascade)

  round_number          Int
  type                  CRJRoundType         @default(PROPOSTA_INICIAL)
  date                  DateTime             @default(now())
  description           String               @db.Text
  proposed_by_us        Boolean              @default(true)

  // Values proposed in this round
  value_proposed        BigInt?
  discount_proposed     Float?
  installments_proposed Int?
  has_rotating_credit   Boolean?
  rotating_value        BigInt?
  rotating_cycles       Int?
  entry_payment         BigInt?
  payment_term_years    Int?
  conditions_summary    String?              @db.Text

  // Creditor response
  creditor_response     String?              @db.Text
  creditor_counter_value BigInt?
  outcome               CRJRoundOutcome      @default(PENDENTE)
  next_steps            String?              @db.Text

  // Attachments
  attachments           String[]             @default([])

  created_at            DateTime             @default(now())
  updated_at            DateTime             @updatedAt

  // Relations
  proposals             CRJProposal[]

  @@index([negotiation_id])
  @@map("crj_negotiation_rounds")
}

model CRJProposal {
  id                    String               @id @default(cuid())
  negotiation_id        String
  negotiation           CRJNegotiation       @relation(fields: [negotiation_id], references: [id], onDelete: Cascade)
  round_id              String?
  round                 CRJNegotiationRound? @relation(fields: [round_id], references: [id])

  template_type         CRJTemplateType      @default(ACORDO_SIMPLES)
  version               Int                  @default(1)
  status                CRJProposalStatus    @default(RASCUNHO)

  // Generated files
  generated_pdf_path    String?
  generated_docx_path   String?

  // Email tracking
  sent_via_email        Boolean              @default(false)
  sent_at               DateTime?
  email_id              String?

  // Template data (all filled fields as JSON)
  data                  Json                 @default("{}")

  created_at            DateTime             @default(now())
  updated_at            DateTime             @updatedAt

  // Relations
  emails                CRJNegotiationEmail[] @relation("ProposalEmails")
  installment_schedule  CRJInstallmentSchedule[]

  @@index([negotiation_id])
  @@index([round_id])
  @@map("crj_proposals")
}

model CRJNegotiationEvent {
  id                    String               @id @default(cuid())
  negotiation_id        String
  negotiation           CRJNegotiation       @relation(fields: [negotiation_id], references: [id], onDelete: Cascade)

  type                  CRJEventType         @default(OBSERVACAO)
  description           String               @db.Text
  metadata              Json?

  user_id               String?
  user                  User?                @relation("CRJEventUser", fields: [user_id], references: [id])
  is_automatic          Boolean              @default(false)

  created_at            DateTime             @default(now())

  @@index([negotiation_id])
  @@index([type])
  @@map("crj_negotiation_events")
}

model CRJInstallmentSchedule {
  id                    String               @id @default(cuid())
  negotiation_id        String
  negotiation           CRJNegotiation       @relation(fields: [negotiation_id], references: [id], onDelete: Cascade)
  proposal_id           String?
  proposal              CRJProposal?         @relation(fields: [proposal_id], references: [id])

  installment_number    Int
  due_date              DateTime
  amount                BigInt
  amount_corrected      BigInt?
  supply_value          BigInt?
  remaining_balance     BigInt?
  status                CRJInstallmentStatus @default(PENDENTE)
  paid_at               DateTime?
  paid_amount           BigInt?
  notes                 String?

  @@index([negotiation_id])
  @@index([proposal_id])
  @@map("crj_installment_schedule")
}

model CRJNegotiationEmail {
  id                    String               @id @default(cuid())
  negotiation_id        String
  negotiation           CRJNegotiation       @relation(fields: [negotiation_id], references: [id], onDelete: Cascade)

  microsoft_message_id  String?
  direction             CRJEmailDirection    @default(ENVIADO)
  from_address          String
  to_addresses          String[]             @default([])
  cc_addresses          String[]             @default([])
  subject               String
  body_preview          String               @db.Text
  has_attachments       Boolean              @default(false)
  attachment_paths      String[]             @default([])

  // Link to proposal if email carries one
  proposal_id           String?
  proposal              CRJProposal?         @relation("ProposalEmails", fields: [proposal_id], references: [id])

  sent_at               DateTime
  created_at            DateTime             @default(now())

  @@index([negotiation_id])
  @@index([microsoft_message_id])
  @@map("crj_negotiation_emails")
}

model CRJDocumentTemplate {
  id                    String               @id @default(cuid())
  name                  String
  type                  CRJTemplateType
  description           String?
  template_path         String
  placeholders          Json                 @default("{}")
  is_active             Boolean              @default(true)
  version               Int                  @default(1)

  created_at            DateTime             @default(now())
  updated_at            DateTime             @updatedAt

  @@map("crj_document_templates")
}

model CRJCollectiveRoundLink {
  id                    String               @id @default(cuid())
  rj_negotiation_id     String
  rj_negotiation        RJNegotiation        @relation(fields: [rj_negotiation_id], references: [id], onDelete: Cascade)
  crj_negotiation_id    String
  crj_negotiation       CRJNegotiation       @relation(fields: [crj_negotiation_id], references: [id], onDelete: Cascade)

  created_at            DateTime             @default(now())

  @@unique([rj_negotiation_id, crj_negotiation_id])
  @@index([rj_negotiation_id])
  @@index([crj_negotiation_id])
  @@map("crj_collective_round_links")
}

model CRJAIInsight {
  id                    String               @id @default(cuid())
  negotiation_id        String?
  negotiation           CRJNegotiation?      @relation(fields: [negotiation_id], references: [id], onDelete: Cascade)
  jrc_id                String?

  type                  CRJAIInsightType
  title                 String
  description           String               @db.Text
  suggested_action      String?
  action_type           CRJAIActionType?
  action_payload        Json?

  is_read               Boolean              @default(false)
  is_dismissed          Boolean              @default(false)
  confidence            Float                @default(0.8)
  trigger_source        String?

  created_at            DateTime             @default(now())

  @@index([negotiation_id])
  @@index([jrc_id])
  @@index([is_read])
  @@index([is_dismissed])
  @@map("crj_ai_insights")
}

// ---------------------------------------------------------------------------
// CRJ AI Configuration — per-JRC AI settings
// ---------------------------------------------------------------------------
model CRJAIConfig {
  id                      String   @id @default(cuid())
  jrc_id                  String?  @unique

  // Section 1: Model & Performance
  default_model           String   @default("standard") // "standard" | "premium"
  proactive_ai            Boolean  @default(true)
  briefing_frequency      String   @default("daily") // "login" | "daily" | "disabled"
  autocomplete_enabled    Boolean  @default(true)

  // Section 2: Triggers (individual on/off)
  trigger_on_create       Boolean  @default(true)
  trigger_on_proposal     Boolean  @default(true)
  trigger_on_counter      Boolean  @default(true)
  trigger_on_status       Boolean  @default(true)
  trigger_on_deadline     Boolean  @default(true)
  trigger_on_patterns     Boolean  @default(true)
  trigger_on_email        Boolean  @default(true)
  days_inactive_alert     Int      @default(14)
  days_no_response        Int      @default(10)
  days_before_target      Int      @default(7)

  // Section 3: Prompt Templates
  custom_system_prompt    String?  @db.Text
  prompt_proposal         String?  @db.Text
  prompt_email            String?  @db.Text
  prompt_analysis         String?  @db.Text
  persistent_instructions String?  @db.Text

  // Section 4: Reference Data
  class_conditions        Json     @default("{}")
  vpn_discount_rate       Float    @default(12.0)
  correction_indices      String[] @default(["INPC", "IPCA", "IGPM", "CDI"])

  created_at              DateTime @default(now())
  updated_at              DateTime @updatedAt

  @@map("crj_ai_configs")
}

// ============================================================
// DEADLINE WORKSPACE — Autonomous workspace for each deadline
// ============================================================

model DeadlineWorkspace {
  id                    String    @id @default(cuid())
  deadline_id           String    @unique
  deadline              DeadlineNew @relation(fields: [deadline_id], references: [id], onDelete: Cascade)

  // Phase pipeline: RASCUNHO → REVISAO → APROVACAO → PROTOCOLO → CONCLUIDO
  phase                 String    @default("RASCUNHO") // RASCUNHO, REVISAO, APROVACAO, PROTOCOLO, CONCLUIDO
  phase_changed_at      DateTime  @default(now())
  phase_changed_by      String?

  // Editor content (kept for backward compat, no longer used by UI)
  editor_content        String?   @db.Text
  editor_html           String?   @db.Text
  editor_saved_at       DateTime?

  // AI analysis of the main draft (minuta)
  analise_ia            String?   @db.Text  // JSON with AI analysis result
  analise_ia_data       DateTime?            // when the analysis was generated
  analise_ia_arquivo    String?              // filename that generated the analysis

  // Reviewer (revisor)
  revisor_id            String?
  revisor_parecer       String?   @db.Text
  revisor_data          DateTime?

  // Protocol confirmation
  protocolo_data        DateTime?  // date/time informed by the lawyer
  protocolo_observacoes String?    @db.Text  // free-text observations
  protocolo_confirmado_por String? // user who confirmed

  // Metadata
  total_words           Int       @default(0)
  total_characters      Int       @default(0)
  estimated_pages       Int       @default(0)

  // Locked for editing?
  locked                Boolean   @default(false)
  locked_by             String?
  locked_at             DateTime?

  created_at            DateTime  @default(now())
  updated_at            DateTime  @updatedAt

  // Relations
  documents             WorkspaceDocument[]
  document_versions     WorkspaceDocVersion[]
  comments              WorkspaceComment[]
  theses                WorkspaceThesis[]
  checklist_items       WorkspaceChecklist[]
  approvals             WorkspaceApproval[]
  activities            WorkspaceActivity[]

  @@index([phase])
  @@map("deadline_workspaces")
}

model WorkspaceDocument {
  id                    String    @id @default(cuid())
  workspace_id          String
  workspace             DeadlineWorkspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  title                 String
  file_url              String
  file_name             String
  file_size             Int       @default(0)
  mime_type             String?
  category              String    @default("ANEXO") // ANEXO, PROVA, PROCURACAO, GUIA, COMPROVANTE, JURISPRUDENCIA, LEGISLACAO, MODELO, RASCUNHO, OUTRO
  description           String?

  is_minuta_principal   Boolean   @default(false)  // flag: main draft file (only 1 per workspace)
  is_versao_anterior    Boolean   @default(false)  // flag: replaced minuta (kept as history)
  substituido_por_id    String?                    // ID of the newer document that replaced this one

  fase_origem           String    @default("RASCUNHO") // phase when document was added: RASCUNHO, REVISAO, APROVACAO, PROTOCOLO

  order                 Int       @default(0)
  is_required           Boolean   @default(false)
  is_validated          Boolean   @default(false)
  validated_by          String?
  validated_at          DateTime?

  uploaded_by           String?
  uploaded_by_name      String?
  created_at            DateTime  @default(now())
  updated_at            DateTime  @updatedAt

  @@index([workspace_id])
  @@map("workspace_documents")
}

model WorkspaceDocVersion {
  id                    String    @id @default(cuid())
  workspace_id          String
  workspace             DeadlineWorkspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  version_number        Int
  title                 String?
  content_json          String?   @db.Text
  content_html          String?   @db.Text
  change_summary        String?
  word_count            Int       @default(0)

  created_by            String?
  created_at            DateTime  @default(now())

  @@index([workspace_id])
  @@index([workspace_id, version_number])
  @@map("workspace_doc_versions")
}

model WorkspaceComment {
  id                    String    @id @default(cuid())
  workspace_id          String
  workspace             DeadlineWorkspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  // Threaded comments
  parent_id             String?
  parent                WorkspaceComment?  @relation("CommentThread", fields: [parent_id], references: [id])
  replies               WorkspaceComment[] @relation("CommentThread")

  // Content
  content               String    @db.Text
  type                  String    @default("GERAL") // GERAL, REVISAO, SUGESTAO, APROVACAO, REJEICAO, CORRECAO
  resolved              Boolean   @default(false)
  resolved_by           String?
  resolved_at           DateTime?

  // Inline positioning (for inline comments on text)
  anchor_from           Int?      // start position in editor
  anchor_to             Int?      // end position in editor
  anchor_text           String?   // quoted text snippet

  user_id               String
  created_at            DateTime  @default(now())
  updated_at            DateTime  @updatedAt

  @@index([workspace_id])
  @@index([parent_id])
  @@map("workspace_comments")
}

model WorkspaceThesis {
  id                    String    @id @default(cuid())
  workspace_id          String
  workspace             DeadlineWorkspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  // IRAC format
  title                 String
  issue                 String?   @db.Text  // Issue (questão jurídica)
  rule                  String?   @db.Text  // Rule (fundamento legal)
  analysis              String?   @db.Text  // Analysis (argumentação)
  conclusion            String?   @db.Text  // Conclusion (pedido/conclusão)

  // Classification
  type                  String    @default("MERITO") // PRELIMINAR, PREJUDICIAL, MERITO, SUBSIDIARIA
  status                String    @default("RASCUNHO") // RASCUNHO, REVISAO, APROVADA, DESCARTADA
  order                 Int       @default(0)
  strength              String?   // FORTE, MEDIA, FRACA

  // References
  legal_refs            String[]  @default([])  // ["Art. 333 CPC", "Súmula 301 STJ"]
  case_refs             String[]  @default([])  // jurisprudence references
  doctrine_refs         String[]  @default([])  // doctrine references

  // AI suggestion
  ai_generated          Boolean   @default(false)
  ai_confidence         Float?

  created_by            String?
  created_at            DateTime  @default(now())
  updated_at            DateTime  @updatedAt

  @@index([workspace_id])
  @@map("workspace_theses")
}

model WorkspaceChecklist {
  id                    String    @id @default(cuid())
  workspace_id          String
  workspace             DeadlineWorkspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  // Item details
  title                 String
  description           String?
  category              String    @default("GERAL") // REQUISITOS_FORMAIS, DOCUMENTOS, FUNDAMENTACAO, PEDIDOS, ASSINATURAS, CUSTAS, PROTOCOLO, GERAL
  order                 Int       @default(0)

  // Completion
  checked               Boolean   @default(false)
  checked_by            String?
  checked_at            DateTime?
  auto_check            Boolean   @default(false)   // auto-verified by system
  auto_check_rule       String?   // rule for auto-check (e.g., "has_procuracao")

  // Blocking
  blocks_protocol       Boolean   @default(false)   // must be checked before protocol
  is_required           Boolean   @default(true)

  // Template origin
  template_source       String?   // which template generated this item

  created_at            DateTime  @default(now())
  updated_at            DateTime  @updatedAt

  @@index([workspace_id])
  @@map("workspace_checklists")
}

model WorkspaceApproval {
  id                    String    @id @default(cuid())
  workspace_id          String
  workspace             DeadlineWorkspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  // Approval details
  round                 Int       @default(1)
  status                String    @default("PENDENTE") // PENDENTE, APROVADO, REPROVADO, APROVADO_COM_RESSALVAS
  requested_by          String
  approver_id           String
  requested_at          DateTime  @default(now())
  decided_at            DateTime?

  // Feedback
  feedback              String?   @db.Text
  corrections_required  String?   @db.Text

  // What was reviewed (snapshot)
  content_snapshot      String?   @db.Text
  version_number        Int?

  created_at            DateTime  @default(now())

  @@index([workspace_id])
  @@index([approver_id])
  @@index([status])
  @@map("workspace_approvals")
}

model WorkspaceActivity {
  id                    String    @id @default(cuid())
  workspace_id          String
  workspace             DeadlineWorkspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  // Activity details
  action                String    // CREATED, PHASE_CHANGED, CONTENT_EDITED, VERSION_SAVED, COMMENT_ADDED, COMMENT_RESOLVED, THESIS_ADDED, THESIS_UPDATED, CHECKLIST_CHECKED, APPROVAL_REQUESTED, APPROVAL_DECIDED, DOCUMENT_UPLOADED, DOCUMENT_VALIDATED, LOCKED, UNLOCKED, DELEGATED, PROTOCOL_REGISTERED
  description           String
  metadata              Json?

  user_id               String?
  user_name             String?
  is_system             Boolean   @default(false)

  created_at            DateTime  @default(now())

  @@index([workspace_id])
  @@index([action])
  @@map("workspace_activities")
}

// ============================================================
// PORTAL MESSAGES (bidirectional client ↔ office)
// ============================================================

model PortalMessage {
  id         String   @id @default(cuid())
  person_id  String
  person     Person   @relation(fields: [person_id], references: [id], onDelete: Cascade)

  direction  String   // CLIENTE_PARA_ESCRITORIO | ESCRITORIO_PARA_CLIENTE
  content    String   @db.Text
  read       Boolean  @default(false)
  read_at    DateTime?

  sender_name String? // name of who sent
  user_id     String? // if sent by internal user

  created_at DateTime @default(now())

  @@index([person_id])
  @@map("portal_messages")
}

// ============================================================
// SYSTEM CONFIG (key-value store for locks, settings, etc.)
// ============================================================

model SystemConfig {
  key        String   @id
  value      String   @db.Text
  updated_at DateTime @default(now()) @updatedAt

  @@map("system_configs")
}

// ============================================================
// AUDIT LOG (security & compliance)
// ============================================================

model AuditLog {
  id         String   @id @default(cuid())
  timestamp  DateTime @default(now())

  // Who
  user_id    String?
  user_email String?
  user_role  String?
  ip_address String?
  user_agent String?

  // What
  action     String   // CREATE, READ, UPDATE, DELETE, LOGIN, LOGOUT, EXPORT, PERMISSION_CHANGE
  resource   String   // e.g. "Case", "Person", "Document", "Fee"
  resource_id String?

  // Details
  description String?
  old_values  Json?   // previous state (for UPDATE/DELETE)
  new_values  Json?   // new state (for CREATE/UPDATE)
  metadata    Json?   // extra context

  // Result
  success    Boolean  @default(true)
  error      String?

  @@index([user_id])
  @@index([action])
  @@index([resource, resource_id])
  @@index([timestamp])
  @@map("audit_logs")
}

// ═══════════════════════════════════════════════════════════
// INVESTIGAÇÃO PATRIMONIAL — CORE
// ═══════════════════════════════════════════════════════════

model Investigation {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Identificação do alvo
  targetName      String
  targetDocument  String
  targetType      TargetType
  targetEmail     String?
  targetPhone     String?

  // Vinculação ao caso de recuperação de crédito
  creditCaseId    String?
  creditCase      CreditRecoveryCase? @relation("InvestigationCreditCase", fields: [creditCaseId], references: [id])

  // Vinculação a processo judicial (opcional)
  caseId          String?
  case_           Case?    @relation("InvestigationCase", fields: [caseId], references: [id])

  // Vinculação a projeto/negociação (opcional)
  projectId       String?
  project         Project? @relation("InvestigationProject", fields: [projectId], references: [id])

  // Status e controle
  status          InvestigationStatus @default(PENDENTE)
  priority        Priority @default(MEDIA)
  depth           InvestigationDepth @default(PADRAO)

  // Quem solicitou e quem executa
  requestedById   String
  requestedBy     User     @relation("InvestigationRequester", fields: [requestedById], references: [id])
  assignedToId    String?
  assignedTo      User?    @relation("InvestigationAssignee", fields: [assignedToId], references: [id])

  // Resumo patrimonial consolidado
  totalEstimatedValue   Decimal? @db.Decimal(18, 2)
  totalDebts            Decimal? @db.Decimal(18, 2)
  riskScore             Int?
  riskClassification    String?
  aiSummary             String?  @db.Text

  // Dados cadastrais extraídos
  cadastralData         Json?
  corporateStructure    Json?

  // Controle de consultas
  lastFullScanAt        DateTime?
  autoMonitor           Boolean  @default(false)
  monitorFrequency      MonitorFrequency?

  notes                 String?  @db.Text

  // Relações
  queries               InvestigationQuery[]
  assets                DiscoveredAsset[]
  debts                 DiscoveredDebt[]
  lawsuits              DiscoveredLawsuit[]
  corporateLinks        CorporateLink[]
  alerts                InvestigationAlert[]
  reports               InvestigationReport[]
  relatedPersons        RelatedPerson[]

  @@index([targetDocument])
  @@index([creditCaseId])
  @@index([status])
  @@index([assignedToId])
  @@map("investigations")
}

model InvestigationQuery {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())

  investigationId   String
  investigation     Investigation @relation(fields: [investigationId], references: [id], onDelete: Cascade)

  provider          ApiProvider
  endpoint          String
  queryType         QueryType

  inputParams       Json
  rawResponse       Json?
  parsedData        Json?

  status            QueryStatus     @default(PENDENTE)
  errorMessage      String?
  responseTimeMs    Int?
  cost              Decimal?        @db.Decimal(8, 4)

  legalBasis        LgpdLegalBasis  @default(EXERCICIO_DIREITOS)
  retentionUntil    DateTime?
  executedById      String
  executedBy        User            @relation("InvestigationQueryExecutor", fields: [executedById], references: [id])

  @@index([investigationId])
  @@index([provider])
  @@index([status])
  @@map("investigation_queries")
}

model DiscoveredAsset {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  investigationId   String
  investigation     Investigation @relation(fields: [investigationId], references: [id], onDelete: Cascade)

  category          AssetCategory
  subcategory       String?
  description       String
  registrationId    String?
  location          String?
  state             String?
  city              String?

  estimatedValue    Decimal?  @db.Decimal(18, 2)
  valuationMethod   String?
  valuationDate     DateTime?

  hasRestriction    Boolean   @default(false)
  restrictionType   String?
  restrictionDetail String?  @db.Text
  isSeizable        Boolean  @default(true)
  impenhorabilityReason String?

  ownershipPercentage Decimal? @db.Decimal(5, 2)
  coOwners          Json?

  sourceProvider    ApiProvider
  sourceQueryId     String?
  rawSourceData     Json?

  verified          Boolean   @default(false)
  verifiedAt        DateTime?
  verifiedById      String?

  latitude          Decimal?  @db.Decimal(10, 7)
  longitude         Decimal?  @db.Decimal(10, 7)
  areaHectares      Decimal?  @db.Decimal(12, 4)
  carCode           String?

  @@index([investigationId])
  @@index([category])
  @@map("discovered_assets")
}

model DiscoveredDebt {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())

  investigationId   String
  investigation     Investigation @relation(fields: [investigationId], references: [id], onDelete: Cascade)

  debtType          DebtType
  creditor          String
  creditorDocument  String?

  originalValue     Decimal?  @db.Decimal(18, 2)
  currentValue      Decimal?  @db.Decimal(18, 2)

  inscriptionDate   DateTime?
  dueDate           DateTime?

  description       String?
  caseNumber        String?
  status            String?
  origin            String?

  sourceProvider    ApiProvider
  rawSourceData     Json?

  @@index([investigationId])
  @@index([debtType])
  @@map("discovered_debts")
}

model DiscoveredLawsuit {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())

  investigationId   String
  investigation     Investigation @relation(fields: [investigationId], references: [id], onDelete: Cascade)

  caseNumber        String
  court             String
  vara              String?
  subject           String?
  class_            String?
  role              String
  otherParties      Json?

  estimatedValue    Decimal?  @db.Decimal(18, 2)
  status            String?
  lastMovement      String?
  lastMovementDate  DateTime?
  distributionDate  DateTime?

  relevance         LawsuitRelevance @default(MEDIA)
  hasAssetFreeze    Boolean   @default(false)
  notes             String?   @db.Text

  sourceProvider    ApiProvider
  rawSourceData     Json?

  @@index([investigationId])
  @@index([caseNumber])
  @@map("discovered_lawsuits")
}

model CorporateLink {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())

  investigationId   String
  investigation     Investigation @relation(fields: [investigationId], references: [id], onDelete: Cascade)

  companyName       String
  companyCnpj      String
  companyStatus     String?
  cnae              String?
  openDate          DateTime?

  role              String
  sharePercentage   Decimal?  @db.Decimal(5, 2)
  capitalValue      Decimal?  @db.Decimal(18, 2)
  entryDate         DateTime?
  exitDate          DateTime?

  isOffshore        Boolean   @default(false)
  isRecentCreation  Boolean   @default(false)
  hasIrregularity   Boolean   @default(false)
  irregularityDesc  String?

  sourceProvider    ApiProvider
  rawSourceData     Json?

  @@index([investigationId])
  @@index([companyCnpj])
  @@map("corporate_links")
}

model RelatedPerson {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())

  investigationId   String
  investigation     Investigation @relation(fields: [investigationId], references: [id], onDelete: Cascade)

  name              String
  document          String?
  relationship      String

  shouldInvestigate Boolean  @default(false)
  childInvestigationId String?
  riskFlag          String?

  sourceProvider    ApiProvider?
  rawSourceData     Json?

  @@index([investigationId])
  @@map("related_persons")
}

model InvestigationAlert {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())

  investigationId   String
  investigation     Investigation @relation(fields: [investigationId], references: [id], onDelete: Cascade)

  alertType         AlertType
  severity          AlertSeverity @default(MEDIA)
  title             String
  description       String  @db.Text

  sourceProvider    ApiProvider?
  triggeredBy       String?

  read              Boolean  @default(false)
  readAt            DateTime?
  readById          String?
  actionTaken       String?  @db.Text
  dismissed         Boolean  @default(false)

  @@index([investigationId])
  @@index([alertType])
  @@index([read])
  @@map("investigation_alerts")
}

model InvestigationReport {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())

  investigationId   String
  investigation     Investigation @relation(fields: [investigationId], references: [id], onDelete: Cascade)

  reportType        ReportType
  title             String

  content           String   @db.Text
  aiGenerated       Boolean  @default(false)

  fileUrl           String?
  fileName          String?

  generatedById     String
  generatedBy       User     @relation("InvestigationReportGenerator", fields: [generatedById], references: [id])

  @@index([investigationId])
  @@map("investigation_reports")
}

// ═══════════════════════════════════════════════════════════
// CONFIGURAÇÃO DE APIs EXTERNAS
// ═══════════════════════════════════════════════════════════

model ApiProviderConfig {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  provider        ApiProvider @unique
  displayName     String
  category        ApiCategory

  apiKey          String?
  apiSecret       String?
  baseUrl         String?
  extraConfig     Json?

  isActive        Boolean  @default(false)
  isConfigured    Boolean  @default(false)
  lastTestedAt    DateTime?
  lastTestResult  String?

  monthlyBudget   Decimal? @db.Decimal(10, 2)
  monthlySpent    Decimal  @default(0) @db.Decimal(10, 2)
  costPerQuery    Decimal? @db.Decimal(8, 4)
  rateLimitPerMin Int?
  rateLimitPerDay Int?

  @@index([provider])
  @@index([isActive])
  @@map("api_provider_configs")
}

// ═══════════════════════════════════════════════════════════
// INVESTIGATION ENUMS
// ═══════════════════════════════════════════════════════════

enum TargetType {
  PF
  PJ
}

enum InvestigationStatus {
  PENDENTE
  EM_ANDAMENTO
  CONSULTAS_CONCLUIDAS
  ANALISE_IA
  CONCLUIDA
  ARQUIVADA
}

enum InvestigationDepth {
  BASICA
  PADRAO
  APROFUNDADA
  COMPLETA
}

enum MonitorFrequency {
  DIARIO
  SEMANAL
  QUINZENAL
  MENSAL
}

enum ApiProvider {
  BRASILAPI
  CNPJA
  DATAJUD
  CVM_DADOS_ABERTOS
  BACEN
  RECEITA_FEDERAL
  PGFN
  INPI
  INFOSIMPLES
  ESCAVADOR
  JUDIT
  ASSERTIVA
  NEOWAY
  BIGDATACORP
  JUSBRASIL
  SERASA
  BOA_VISTA
  QUOD
  DENATRAN_SERPRO
  ONR_SREI
  CENPROT
  INCRA_SIGEF
  SICAR
  MAPBIOMAS
  GOOGLE_EARTH_ENGINE
  PLANET_LABS
  SENTINEL_HUB
  INPE_TERRABRASILIS
  COMPLYADVANTAGE
  REFINITIV_WORLDCHECK
  OPENCORPORATES
  SAYARI
  DNB
  CHAINALYSIS
  OPENSANCTIONS
  SANCTIONS_IO
  MANUAL
}

enum ApiCategory {
  CADASTRAL
  JUDICIAL
  PATRIMONIAL
  VEICULAR
  IMOBILIARIO
  RURAL_SATELITE
  CREDITICIO
  COMPLIANCE
  SOCIETARIO
  PROTESTOS
}

enum QueryType {
  CONSULTA_CPF
  CONSULTA_CNPJ
  CONSULTA_PROCESSO
  CONSULTA_VEICULO
  CONSULTA_IMOVEL
  CONSULTA_PROTESTO
  CONSULTA_DIVIDA_ATIVA
  CONSULTA_SCORING
  CONSULTA_PEP_SANCOES
  CONSULTA_SOCIETARIA
  CONSULTA_CVM
  CONSULTA_SATELITE
  CONSULTA_RURAL
  CONSULTA_MARCAS
  MONITORAMENTO
}

enum QueryStatus {
  PENDENTE
  EXECUTANDO
  CONCLUIDA
  ERRO
  TIMEOUT
  SEM_DADOS
  MOCK
}

enum LgpdLegalBasis {
  EXERCICIO_DIREITOS
  PROTECAO_CREDITO
  LEGITIMO_INTERESSE
  CUMPRIMENTO_OBRIGACAO
}

enum AssetCategory {
  IMOVEL_URBANO
  IMOVEL_RURAL
  VEICULO_AUTOMOVEL
  VEICULO_CAMINHAO
  VEICULO_MOTOCICLETA
  VEICULO_OUTRO
  EMBARCACAO
  AERONAVE
  PARTICIPACAO_SOCIETARIA
  ACOES_BOLSA
  FUNDOS_INVESTIMENTO
  DEPOSITO_BANCARIO
  CREDITOS_RECEBER
  MARCAS_PATENTES
  MAQUINAS_EQUIPAMENTOS
  CRIPTOATIVOS
  OUTROS
}

enum DebtType {
  DIVIDA_ATIVA_UNIAO
  DIVIDA_ATIVA_ESTADO
  DIVIDA_ATIVA_MUNICIPIO
  PROTESTO
  NEGATIVACAO_SERASA
  NEGATIVACAO_SPC
  EXECUCAO_FISCAL
  EXECUCAO_TRABALHISTA
  EXECUCAO_CIVEL
  PRECATORIO
  OUTROS
}

enum LawsuitRelevance {
  BAIXA
  MEDIA
  ALTA
  CRITICA
}

enum AlertType {
  PATRIMONIO_ALIENADO
  EMPRESA_BAIXADA
  NOVA_EMPRESA_CRIADA
  NOVO_PROCESSO
  VEICULO_TRANSFERIDO
  IMOVEL_GRAVADO
  PROTESTO_INCLUIDO
  DIVIDA_INSCRITA
  SANCAO_DETECTADA
  PEP_DETECTADO
  SOCIEDADE_ALTERADA
  DESMATAMENTO_DETECTADO
  SCORE_ALTERADO
}

enum AlertSeverity {
  BAIXA
  MEDIA
  ALTA
  CRITICA
}

enum ReportType {
  DOSSIE_COMPLETO
  RESUMO_PATRIMONIAL
  RELATORIO_BENS
  RELATORIO_PROCESSOS
  RELATORIO_SOCIETARIO
  RELATORIO_COMPLIANCE
  PETICAO_MEDIDA_CONSTRITIVA
  LAUDO_AVALIACAO
}

// ============================================================
// CADASTROS — VARAS, JUÍZES, ADM. JUDICIAIS, PESSOAS VINCULADAS
// ============================================================

enum CourtType {
  VARA_CIVEL
  VARA_EMPRESARIAL
  VARA_FAZENDA_PUBLICA
  VARA_TRABALHO
  VARA_FEDERAL
  VARA_FAMILIA
  VARA_CRIMINAL
  VARA_FALENCIAS_RJ
  JUIZADO_ESPECIAL
  TURMA_RECURSAL
  CAMARA_CIVEL
  CAMARA_EMPRESARIAL
  TURMA_TRF
  SECAO_TRF
  TURMA_TST
  TURMA_STJ
  TURMA_STF
  PLENARIO
  CORTE_ESPECIAL
  OUTRO_COURT
}

enum CourtInstance {
  PRIMEIRA
  SEGUNDA
  SUPERIOR
  SUPREMO
}

enum JudgeTitle {
  JUIZ
  JUIZ_FEDERAL
  JUIZ_TRABALHO
  JUIZ_SUBSTITUTO
  DESEMBARGADOR_TJ
  DESEMBARGADOR_FEDERAL
  MINISTRO_STJ
  MINISTRO_TST
  MINISTRO_STF
}

enum CourtStaffRole {
  ESCRIVAO
  ESCREVENTE
  ANALISTA_JUDICIARIO
  OFICIAL_JUSTICA
  ASSESSOR
  SECRETARIO_CAMARA
  CONCILIADOR
  PERITO_JUDICIAL
  CONTADOR_JUDICIAL
  ESTAGIARIO_COURT
  OUTRO_STAFF
}

enum JudicialAdminRole {
  ADMINISTRADOR_PRINCIPAL
  ADVOGADO_AJ
  CONTADOR_AJ
  ECONOMISTA
  ANALISTA_AJ
  GESTOR_OPERACIONAL
  SECRETARIO_AJ
  ESTAGIARIO_AJ
  OUTRO_AJ
}

enum ClientRelationshipType {
  // Societário
  SOCIO
  SOCIO_ADMINISTRADOR
  SOCIO_MINORITARIO
  ACIONISTA
  CONSELHEIRO
  // Diretoria / Gestão
  CEO
  CFO
  COO
  DIRETOR
  GERENTE_GERAL
  GERENTE
  SUPERVISOR
  // Operacional
  FUNCIONARIO
  CONTADOR_OP
  ADVOGADO_INTERNO
  CONSULTOR_EXT
  PREPOSTO
  // Familiar
  CONJUGE
  FILHO
  PAI_MAE
  IRMAO
  PARENTE
  // Influência externa
  POLITICO
  CREDOR_CHAVE
  FORNECEDOR_CHAVE
  PARCEIRO_COMERCIAL
  AGENTE_FINANCEIRO
  CORRETOR
  DESPACHANTE
  // Profissionais ligados
  PERITO_REL
  MEDIADOR
  ARBITRO
  LEILOEIRO
  TRADUTOR
  OUTRO_REL
}

enum InfluenceLevel {
  CRITICO
  ALTO_INF
  MEDIO_INF
  BAIXO_INF
  INFORMATIVO
}

// ─── Court (Vara / Comarca) ───────────────────────────────

model Court {
  id            String        @id @default(cuid())
  name          String
  shortName     String?
  courtType     CourtType
  instance      CourtInstance
  comarca       String
  city          String
  state         String
  tribunal      String
  tribunalCode  String?
  phone         String?
  email         String?
  address       String?
  cep           String?
  notes         String?       @db.Text
  isActive      Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  judges        Judge[]
  staffMembers  CourtStaff[]
  cases         Case[]        @relation("CourtCases")

  @@index([state, comarca])
  @@index([tribunal])
  @@index([courtType])
  @@map("courts")
}

// ─── Judge (Juiz / Desembargador) ─────────────────────────

model Judge {
  id                 String      @id @default(cuid())
  name               String
  title              JudgeTitle
  registrationNumber String?
  email              String?
  phone              String?
  cellphone          String?
  assistantName      String?
  assistantEmail     String?
  assistantPhone     String?
  courtId            String?
  court              Court?      @relation(fields: [courtId], references: [id])
  chamberName        String?
  specialty          String?
  appointmentDate    DateTime?
  tendencyNotes      String?     @db.Text
  avgDecisionDays    Int?
  relevantDecisions  String?     @db.Text
  photoUrl           String?
  notes              String?     @db.Text
  isActive           Boolean     @default(true)
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  cases              CaseJudge[]

  @@index([courtId])
  @@index([name])
  @@map("judges")
}

// ─── CaseJudge (N:N Case ↔ Judge) ────────────────────────

model CaseJudge {
  id        String    @id @default(cuid())
  caseId    String
  case      Case      @relation(fields: [caseId], references: [id], onDelete: Cascade)
  judgeId   String
  judge     Judge     @relation(fields: [judgeId], references: [id], onDelete: Cascade)
  role      String?
  startDate DateTime?
  endDate   DateTime?
  isCurrent Boolean   @default(true)

  @@unique([caseId, judgeId])
  @@index([judgeId])
  @@map("case_judges")
}

// ─── CourtStaff (Servidores da Vara) ──────────────────────

model CourtStaff {
  id          String         @id @default(cuid())
  name        String
  role        CourtStaffRole
  customRole  String?
  courtId     String
  court       Court          @relation(fields: [courtId], references: [id], onDelete: Cascade)
  email       String?
  phone       String?
  cellphone   String?
  notes       String?
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([courtId])
  @@map("court_staff")
}

// ─── JudicialAdministrator (Empresa AJ) ───────────────────

model JudicialAdministrator {
  id               String    @id @default(cuid())
  companyName      String
  tradeName        String?
  cnpj             String?   @unique
  email            String?
  phone            String?
  website          String?
  address          String?
  city             String?
  state            String?
  mainContactName  String?
  mainContactEmail String?
  mainContactPhone String?
  rating           Int?
  specialties      String?
  avgFeePercentage Float?
  notes            String?   @db.Text
  isActive         Boolean   @default(true)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  teamMembers      JudicialAdminTeamMember[]
  cases            CaseAdministrator[]

  @@index([state])
  @@map("judicial_administrators")
}

// ─── JudicialAdminTeamMember ──────────────────────────────

model JudicialAdminTeamMember {
  id              String                @id @default(cuid())
  administratorId String
  administrator   JudicialAdministrator @relation(fields: [administratorId], references: [id], onDelete: Cascade)
  name            String
  role            JudicialAdminRole
  customRole      String?
  cpf             String?
  oabNumber       String?
  crcNumber       String?
  email           String?
  phone           String?
  cellphone       String?
  assignedCases   String?
  notes           String?
  isActive        Boolean               @default(true)
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  @@index([administratorId])
  @@map("judicial_admin_team_members")
}

// ─── CaseAdministrator (N:N Case ↔ JudicialAdministrator) ─

model CaseAdministrator {
  id              String                @id @default(cuid())
  caseId          String
  case            Case                  @relation(fields: [caseId], references: [id], onDelete: Cascade)
  administratorId String
  administrator   JudicialAdministrator @relation(fields: [administratorId], references: [id])
  appointmentDate DateTime?
  dismissalDate   DateTime?
  feePercentage   Float?
  feeAmount       BigInt?
  status          String?

  @@unique([caseId, administratorId])
  @@map("case_administrators")
}

// ─── ClientRelatedPerson (Mapa de Influência) ─────────────

model ClientRelatedPerson {
  id                 String                 @id @default(cuid())
  clientId           String
  client             Person                 @relation("ClientRelatedPersons", fields: [clientId], references: [id], onDelete: Cascade)
  name               String
  relationship       ClientRelationshipType
  customRelationship String?
  cpf                String?
  rg                 String?
  birthDate          DateTime?
  email              String?
  phone              String?
  cellphone          String?
  whatsapp           String?
  address            String?
  city               String?
  state              String?
  cep                String?
  company            String?
  position           String?
  department         String?
  influenceLevel     InfluenceLevel         @default(MEDIO_INF)
  influenceNotes     String?                @db.Text
  decisionPower      Boolean                @default(false)
  isKeyPerson        Boolean                @default(false)
  contactFrequency   String?
  lastContactDate    DateTime?
  preferredChannel   String?
  relatedCaseIds     String?
  linkedPersonId     String?
  linkedPerson       Person?                @relation("LinkedRelatedPerson", fields: [linkedPersonId], references: [id])
  photoUrl           String?
  notes              String?                @db.Text
  isActive           Boolean                @default(true)
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt

  @@index([clientId])
  @@index([relationship])
  @@index([clientId, isKeyPerson])
  @@map("client_related_persons")
}

// ═══════════════════════════════════════════════════════════
// PATRIMÔNIO — ENUMS
// ═══════════════════════════════════════════════════════════

enum PropertyOwnership {
  PROPRIO
  ARRENDADO
  PARCERIA
  COMODATO
  POSSE
  CONDOMINIO
}

enum HarvestSeason {
  SAFRA
  SAFRINHA
  INVERNO
  PERENE
}

enum CropType {
  SOJA
  MILHO
  MILHO_SAFRINHA
  ALGODAO
  CAFE
  CANA_DE_ACUCAR
  ARROZ
  FEIJAO
  TRIGO
  SORGO
  GIRASSOL
  EUCALIPTO
  PECUARIA_CORTE
  PECUARIA_LEITE
  SUINOCULTURA
  AVICULTURA
  PISCICULTURA
  FRUTICULTURA
  HORTICULTURA
  SILVICULTURA
  OUTRA
}

enum UrbanPropertyType {
  CASA
  APARTAMENTO
  SALA_COMERCIAL
  GALPAO
  TERRENO
  LOJA
  PREDIO_COMERCIAL
  FAZENDA_URBANA
  OUTRO
}

enum VehicleCategory {
  AUTOMOVEL
  CAMINHONETE
  CAMINHAO
  CAMINHAO_PESADO
  VAN_UTILITARIO
  MOTOCICLETA
  TRATOR
  COLHEITADEIRA
  PLANTADEIRA
  PULVERIZADOR
  CARRETA_AGRICOLA
  SILO
  SECADOR
  PIVO_IRRIGACAO
  GERADOR
  EQUIPAMENTO_INDUSTRIAL
  EQUIPAMENTO_ESCRITORIO
  OUTRO_VEICULO
}

enum ParticipationType {
  SOCIO_QUOTISTA
  SOCIO_ADMINISTRADOR_PART
  ACIONISTA_CONTROLADOR
  ACIONISTA_MINORITARIO
  COOPERADO
  CONSORCIO
}

enum FinancialPeriod {
  ANUAL
  TRIMESTRAL
  MENSAL
}

// ═══════════════════════════════════════════════════════════
// IMÓVEIS RURAIS (FAZENDAS)
// ═══════════════════════════════════════════════════════════

model ClientRuralProperty {
  id                 String            @id @default(cuid())
  clientId           String
  client             Person            @relation("ClientRuralProperties", fields: [clientId], references: [id], onDelete: Cascade)

  name               String
  registrationNumber String?
  carCode            String?
  incraCode          String?
  nirf               String?

  address            String?
  city               String
  state              String
  comarca            String?
  latitude           Float?
  longitude          Float?

  totalArea          Float
  productiveArea     Float?
  pastureland        Float?
  nativeVegetation   Float?
  forestArea         Float?
  improvementArea    Float?
  irrigatedArea      Float?

  ownership          PropertyOwnership @default(PROPRIO)
  ownerName          String?
  ownerDocument      String?
  contractEndDate    DateTime?
  annualRent         BigInt?

  estimatedValue     BigInt?
  valuePerHectare    BigInt?
  appraisalDate      DateTime?
  appraisalSource    String?

  hasLien            Boolean           @default(false)
  lienHolder         String?
  lienAmount         BigInt?
  hasJudicialBlock   Boolean           @default(false)
  blockDetails       String?
  hasEnvironmentalIssue Boolean        @default(false)
  environmentalNotes String?

  productions        ClientAgriculturalProduction[]

  notes              String?           @db.Text
  isActive           Boolean           @default(true)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  @@index([clientId])
  @@index([state, city])
  @@map("client_rural_properties")
}

// ═══════════════════════════════════════════════════════════
// PRODUÇÃO AGRÍCOLA (por safra/propriedade)
// ═══════════════════════════════════════════════════════════

model ClientAgriculturalProduction {
  id                String              @id @default(cuid())
  clientId          String
  client            Person              @relation("ClientProductions", fields: [clientId], references: [id], onDelete: Cascade)

  ruralPropertyId   String?
  ruralProperty     ClientRuralProperty? @relation(fields: [ruralPropertyId], references: [id])

  harvestYear       String
  season            HarvestSeason
  crop              CropType
  customCrop        String?
  plantedArea       Float
  expectedYield     Float?
  actualYield       Float?
  yieldUnit         String?
  totalProduction   Float?

  averagePrice      BigInt?
  priceUnit         String?
  totalRevenue      BigInt?
  percentageSold    Float?
  percentageHedged  Float?

  productionCost    BigInt?
  costPerHectare    BigInt?

  hasCPR            Boolean             @default(false)
  cprDetails        String?
  financingSource   String?
  financingAmount   BigInt?

  notes             String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@index([clientId])
  @@index([clientId, harvestYear])
  @@index([ruralPropertyId])
  @@map("client_agricultural_productions")
}

// ═══════════════════════════════════════════════════════════
// IMÓVEIS URBANOS
// ═══════════════════════════════════════════════════════════

model ClientUrbanProperty {
  id                 String            @id @default(cuid())
  clientId           String
  client             Person            @relation("ClientUrbanProperties", fields: [clientId], references: [id], onDelete: Cascade)

  propertyType       UrbanPropertyType
  description        String
  registrationNumber String?

  address            String
  neighborhood       String?
  city               String
  state              String
  cep                String?

  builtArea          Float?
  landArea           Float?

  ownership          PropertyOwnership @default(PROPRIO)
  ownerName          String?

  estimatedValue     BigInt?
  appraisalDate      DateTime?
  appraisalSource    String?
  monthlyRent        BigInt?

  hasLien            Boolean           @default(false)
  lienHolder         String?
  lienAmount         BigInt?
  hasJudicialBlock   Boolean           @default(false)
  blockDetails       String?

  notes              String?
  isActive           Boolean           @default(true)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  @@index([clientId])
  @@map("client_urban_properties")
}

// ═══════════════════════════════════════════════════════════
// VEÍCULOS, MÁQUINAS E EQUIPAMENTOS
// ═══════════════════════════════════════════════════════════

model ClientVehicle {
  id                String          @id @default(cuid())
  clientId          String
  client            Person          @relation("ClientVehicles", fields: [clientId], references: [id], onDelete: Cascade)

  category          VehicleCategory
  description       String
  brand             String?
  model             String?
  year              Int?
  plate             String?
  renavam           String?
  chassi            String?
  serialNumber      String?

  estimatedValue    BigInt?
  fipeValue         BigInt?
  appraisalDate     DateTime?

  hasLien           Boolean         @default(false)
  lienHolder        String?
  lienAmount        BigInt?
  hasJudicialBlock  Boolean         @default(false)

  condition         String?
  location          String?

  notes             String?
  isActive          Boolean         @default(true)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([clientId])
  @@index([category])
  @@map("client_vehicles")
}

// ═══════════════════════════════════════════════════════════
// PARTICIPAÇÕES SOCIETÁRIAS
// ═══════════════════════════════════════════════════════════

model ClientCorporateParticipation {
  id                String            @id @default(cuid())
  clientId          String
  client            Person            @relation("ClientParticipations", fields: [clientId], references: [id], onDelete: Cascade)

  companyName       String
  cnpj              String?
  participationType ParticipationType
  sharePercentage   Float?
  capitalAmount     BigInt?

  role              String?
  companyStatus     String?
  cnaeDescription   String?

  estimatedValue    BigInt?
  annualDividends   BigInt?

  notes             String?
  isActive          Boolean           @default(true)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([clientId])
  @@map("client_corporate_participations")
}

// ═══════════════════════════════════════════════════════════
// DADOS FINANCEIROS (por exercício)
// ═══════════════════════════════════════════════════════════

model ClientFinancialData {
  id                    String          @id @default(cuid())
  clientId              String
  client                Person          @relation("ClientFinancials", fields: [clientId], references: [id], onDelete: Cascade)

  year                  Int
  period                FinancialPeriod @default(ANUAL)
  quarter               Int?

  grossRevenue          BigInt?
  netRevenue            BigInt?
  cogs                  BigInt?
  grossProfit           BigInt?
  operatingExpenses     BigInt?
  ebitda                BigInt?
  depreciation          BigInt?
  ebit                  BigInt?
  financialExpenses     BigInt?
  financialIncome       BigInt?
  netIncome             BigInt?

  totalAssets           BigInt?
  currentAssets         BigInt?
  nonCurrentAssets      BigInt?
  totalLiabilities      BigInt?
  currentLiabilities    BigInt?
  nonCurrentLiabilities BigInt?
  equity                BigInt?
  cash                  BigInt?

  totalDebt             BigInt?
  shortTermDebt         BigInt?
  longTermDebt          BigInt?
  netDebt               BigInt?

  operatingCashFlow     BigInt?
  investingCashFlow     BigInt?
  financingCashFlow     BigInt?

  source                String?
  documentUrl           String?

  notes                 String?         @db.Text
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  @@unique([clientId, year, period, quarter])
  @@index([clientId])
  @@index([clientId, year])
  @@map("client_financial_data")
}

// ═══════════════════════════════════════════════════════════
// INDICADORES OPERACIONAIS
// ═══════════════════════════════════════════════════════════

model ClientOperationalData {
  id                String   @id @default(cuid())
  clientId          String
  client            Person   @relation("ClientOperational", fields: [clientId], references: [id], onDelete: Cascade)

  year              Int

  totalEmployees    Int?
  cltEmployees      Int?
  temporaryWorkers  Int?
  monthlyPayroll    BigInt?
  annualPayroll     BigInt?

  totalManagedArea  Float?
  ownedArea         Float?
  leasedArea        Float?
  storageCapacity   Float?
  cattleHeadCount   Int?

  vehicleCount      Int?
  machineCount      Int?
  truckCount        Int?

  operationalUnits  Int?
  states            String?
  certifications    String?

  notes             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([clientId, year])
  @@index([clientId])
  @@map("client_operational_data")
}

// ════════════════════════════════════════
// TEAM MANAGEMENT MODULE
// ════════════════════════════════════════

enum TeamRole {
  SOCIO
  ADVOGADO_SENIOR
  ADVOGADO_PLENO
  ADVOGADO_JUNIOR
  ESTAGIARIO
  PARALEGAL
  ADMINISTRATIVO
}

enum CareerTrack {
  JURIDICO
  ADMINISTRATIVO_TRACK
  PARALEGAL_TRACK
}

enum BurnoutRisk {
  LOW
  MODERATE
  HIGH
  CRITICAL
}

enum OKRStatus {
  DRAFT
  ACTIVE
  REVIEW
  CLOSED
}

enum OKRCategory {
  PRODUTIVIDADE
  QUALIDADE
  CAPTACAO
  DESENVOLVIMENTO
  FINANCEIRO
  OPERACIONAL
}

enum FeedbackType {
  POSITIVO
  CONSTRUTIVO
  FEEDFORWARD
  RECONHECIMENTO
}

enum FeedbackDirection {
  MANAGER_TO_REPORT
  REPORT_TO_MANAGER
  PEER_TO_PEER
  SELF
  CLIENT_ORIGINATED
}

enum FeedbackVisibility {
  PRIVATE
  TEAM
  MANAGERS_ONLY
}

enum FeedbackReaction {
  AGRADECIDO
  CONCORDO
  PARCIALMENTE_CONCORDO
  DISCORDO
  PRECISO_CONVERSAR
}

enum LegalCompetency {
  TECNICA_JURIDICA
  COMUNICACAO_CLIENTE
  NEGOCIACAO
  GESTAO_PRAZOS
  REDACAO_JURIDICA
  ORATORIA_AUDIENCIA
  PESQUISA_JURISPRUDENCIAL
  BUSINESS_DEVELOPMENT
  TRABALHO_EQUIPE
  LIDERANCA
  COMPETENCIA_TECNOLOGICA
  ETICA_PROFISSIONAL
}

enum Review360Status {
  SETUP
  COLLECTING
  PROCESSING
  REVIEW_360
  RELEASED
  CLOSED_360
}

enum Review360ParticipantStatus {
  PENDING_360
  IN_PROGRESS_360
  COMPLETED_360
  RESULTS_AVAILABLE
}

enum OneOnOneStatus {
  SCHEDULED
  IN_PROGRESS_1ON1
  COMPLETED_1ON1
  CANCELLED_1ON1
  RESCHEDULED
}

enum OneOnOneFrequency {
  WEEKLY_1ON1
  BIWEEKLY_1ON1
  MONTHLY_1ON1
}

enum PDIStatus {
  DRAFT_PDI
  ACTIVE_PDI
  MID_REVIEW
  FINAL_REVIEW
  COMPLETED_PDI
  ARCHIVED_PDI
}

enum SurveyType {
  PULSE
  ENPS
  CLIMA
  CUSTOM_SURVEY
  ONBOARDING_SURVEY
  EXIT_SURVEY
}

enum SurveyStatus {
  DRAFT_SURVEY
  ACTIVE_SURVEY
  CLOSED_SURVEY
  ANALYZED
}

enum SurveyFrequency {
  WEEKLY_SURVEY
  BIWEEKLY_SURVEY
  MONTHLY_SURVEY
  QUARTERLY
  SEMESTRAL
}

enum ClientFeedbackType {
  NPS
  CSAT
  CES
  FULL_FEEDBACK
}

enum NPSCategory {
  PROMOTER
  PASSIVE
  DETRACTOR
}

enum ClientFeedbackStatus {
  PENDING_CF
  RESPONDED
  FOLLOWED_UP
  EXPIRED_CF
}

enum ComplaintCategory {
  ASSEDIO_MORAL
  ASSEDIO_SEXUAL
  DISCRIMINACAO
  DESVIO_ETICO
  CONFLITO_INTERESSES
  IRREGULARIDADE_FINANCEIRA
  CONDICOES_TRABALHO
  RELACAO_INTERPESSOAL
  SUGESTAO_MELHORIA
  ELOGIO
  OUTRO_COMPLAINT
}

enum ComplaintSeverity {
  LOW_SEV
  MEDIUM_SEV
  HIGH_SEV
  CRITICAL_SEV
}

enum ComplaintStatus {
  RECEIVED
  UNDER_ANALYSIS
  INVESTIGATING
  ACTION_TAKEN
  RESOLVED_COMPLAINT
  DISMISSED
  ARCHIVED_COMPLAINT
}

enum ComplaintChannel {
  INTERNAL_SYSTEM
  EMAIL_CHANNEL
  WHATSAPP_CHANNEL
  IN_PERSON
  EXTERNAL_LINK
}

enum RecognitionCategory {
  HIGH_FIVE
  STAR_OF_WEEK
  MILESTONE_REC
  CLIENT_PRAISE
  INNOVATION
  MENTORSHIP
}

model TeamMember {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id])

  role            TeamRole @default(ESTAGIARIO)
  department      String?
  oabNumber       String?
  admissionDate   DateTime
  birthDate       DateTime?

  careerTrack     CareerTrack @default(JURIDICO)
  currentLevel    Int      @default(1)
  targetLevel     Int?

  managerMemberId String?
  manager         TeamMember? @relation("ManagerSubordinate", fields: [managerMemberId], references: [id])
  subordinates    TeamMember[] @relation("ManagerSubordinate")

  lastWellbeingScore  Int?
  burnoutRiskLevel    BurnoutRisk @default(LOW)

  okrs              OKR[]
  kpiEntries        KPIEntry[]
  feedbackGiven     Feedback[]     @relation("FeedbackAuthor")
  feedbackReceived  Feedback[]     @relation("FeedbackTarget")
  review360Cycles   Review360Participant[]
  oneOnOnes         OneOnOne[]     @relation("OneOnOneSubordinate")
  oneOnOnesManagedBy OneOnOne[]   @relation("OneOnOneManager")
  pdiPlans          PDIPlan[]
  pulseSurveyResponses PulseSurveyResponse[]
  clientFeedbackFor    ClientFeedback[]
  complaintsSubmitted  Complaint[]  @relation("ComplaintSubmitter")
  complaintsAssigned   Complaint[]  @relation("ComplaintAssignee")
  recognitionsGiven    Recognition[] @relation("RecognitionFrom")
  recognitionsReceived Recognition[] @relation("RecognitionTo")
  wellbeingCheckins    WellbeingCheckin[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("team_members")
}

model OKR {
  id            String    @id @default(cuid())
  teamMemberId  String
  teamMember    TeamMember @relation(fields: [teamMemberId], references: [id])

  quarter       Int
  year          Int
  status        OKRStatus @default(DRAFT)

  objective     String
  category      OKRCategory

  keyResults    Json

  overallProgress Float   @default(0)

  finalScore      Float?
  selfAssessment  String?
  managerComment  String?

  parentOkrId     String?
  parentOkr       OKR?    @relation("OKRAlignment", fields: [parentOkrId], references: [id])
  childOkrs       OKR[]   @relation("OKRAlignment")

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("okrs")
}

model KPIEntry {
  id            String   @id @default(cuid())
  teamMemberId  String
  teamMember    TeamMember @relation(fields: [teamMemberId], references: [id])

  period        DateTime

  billableHours       Float?
  totalHours          Float?
  utilizationRate     Float?
  casesActive         Int?
  deadlinesMet        Int?
  deadlinesTotal      Int?
  deadlineComplianceRate Float?

  piecesProduced      Int?
  piecesQualityScore  Float?
  caseSuccessRate     Float?

  revenueGenerated    Float?
  clientsAcquired     Int?

  trainingHours       Float?
  mentoringSessions   Int?

  overallScore        Float?
  aiInsights          String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([teamMemberId, period])
  @@map("kpi_entries")
}

model Feedback {
  id            String   @id @default(cuid())

  authorId      String
  author        TeamMember @relation("FeedbackAuthor", fields: [authorId], references: [id])
  targetId      String
  target        TeamMember @relation("FeedbackTarget", fields: [targetId], references: [id])

  type          FeedbackType
  direction     FeedbackDirection
  visibility    FeedbackVisibility @default(PRIVATE)

  situation     String
  behavior      String
  impact        String

  feedforward   String?

  competency    LegalCompetency?

  caseId        String?

  acknowledged  Boolean   @default(false)
  reaction      FeedbackReaction?
  replyText     String?

  aiSuggested   Boolean   @default(false)
  aiTone        String?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("feedbacks")
}

model Review360Cycle {
  id            String   @id @default(cuid())

  name          String
  period        String
  status        Review360Status @default(SETUP)

  competencies  Json

  includeClients      Boolean @default(true)
  includePeers        Boolean @default(true)
  includeSelfReview   Boolean @default(true)
  anonymousComments   Boolean @default(true)
  minReviewersPerCategory Int @default(2)

  startDate     DateTime
  endDate       DateTime
  resultsDate   DateTime?

  participants  Review360Participant[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("review_360_cycles")
}

model Review360Participant {
  id            String   @id @default(cuid())
  cycleId       String
  cycle         Review360Cycle @relation(fields: [cycleId], references: [id])
  teamMemberId  String
  teamMember    TeamMember @relation(fields: [teamMemberId], references: [id])

  selfReview    Json?
  managerReview Json?
  peerReviews   Json?
  clientReviews Json?

  consolidatedScores  Json?
  strengthsSummary    String?
  developmentAreas    String?
  aiNarrative         String?

  performanceScore    Float?
  potentialScore      Float?
  nineBoxPosition     String?

  status        Review360ParticipantStatus @default(PENDING_360)
  completedAt   DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([cycleId, teamMemberId])
  @@map("review_360_participants")
}

model OneOnOne {
  id            String   @id @default(cuid())

  managerId     String
  manager       TeamMember @relation("OneOnOneManager", fields: [managerId], references: [id])
  subordinateId String
  subordinate   TeamMember @relation("OneOnOneSubordinate", fields: [subordinateId], references: [id])

  scheduledAt   DateTime
  duration      Int      @default(45)
  location      String?
  status        OneOnOneStatus @default(SCHEDULED)

  recurring     Boolean  @default(true)
  frequency     OneOnOneFrequency @default(WEEKLY_1ON1)

  agenda        Json?
  notes         String?
  actionItems   Json?

  moodScore     Int?
  energyLevel   Int?
  workloadPerception Int?

  aiSummary     String?
  aiSuggestions Json?

  calendarEventId String?

  completedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("one_on_ones")
}

model PDIPlan {
  id            String   @id @default(cuid())
  teamMemberId  String
  teamMember    TeamMember @relation(fields: [teamMemberId], references: [id])

  title         String
  period        String
  status        PDIStatus @default(DRAFT_PDI)

  goals         Json

  currentRole   TeamRole
  targetRole    TeamRole?
  timelineMonths Int?

  midReview     Json?
  finalReview   Json?
  overallProgress Float  @default(0)

  aiRecommendations String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("pdi_plans")
}

model PulseSurvey {
  id            String   @id @default(cuid())

  title         String
  type          SurveyType
  status        SurveyStatus @default(DRAFT_SURVEY)

  questions     Json

  anonymous     Boolean  @default(true)
  frequency     SurveyFrequency?

  startDate     DateTime
  endDate       DateTime

  responseCount Int      @default(0)
  responseRate  Float?
  avgScore      Float?
  enpsScore     Int?
  aiAnalysis    String?

  responses     PulseSurveyResponse[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("pulse_surveys")
}

model PulseSurveyResponse {
  id            String   @id @default(cuid())
  surveyId      String
  survey        PulseSurvey @relation(fields: [surveyId], references: [id])

  respondentId  String?
  respondent    TeamMember? @relation(fields: [respondentId], references: [id])

  answers       Json

  submittedAt   DateTime @default(now())

  @@unique([surveyId, respondentId])
  @@map("pulse_survey_responses")
}

model ClientFeedback {
  id            String   @id @default(cuid())

  clientName    String
  clientEmail   String?
  clientCompany String?

  teamMemberId  String?
  teamMember    TeamMember? @relation(fields: [teamMemberId], references: [id])

  caseId        String?

  type          ClientFeedbackType
  triggerMoment String?

  npsScore      Int?
  npsCategory   NPSCategory?

  csatCommunication    Int?
  csatResult           Int?
  csatSpeed            Int?
  csatCompetence       Int?
  csatTransparency     Int?
  csatOverall          Float?

  cesScore      Int?

  positiveComment  String?
  improvementComment String?
  wouldRecommend   Boolean?

  status        ClientFeedbackStatus @default(PENDING_CF)
  followUpDone  Boolean  @default(false)
  followUpNotes String?

  accessToken   String   @unique @default(cuid())
  expiresAt     DateTime

  respondedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("client_feedbacks")
}

model Complaint {
  id            String   @id @default(cuid())

  submitterId   String?
  submitter     TeamMember? @relation("ComplaintSubmitter", fields: [submitterId], references: [id])
  isAnonymous   Boolean  @default(true)

  category      ComplaintCategory
  severity      ComplaintSeverity @default(MEDIUM_SEV)

  title         String
  description   String
  evidence      Json?

  involvedPersonDescription String?

  status        ComplaintStatus @default(RECEIVED)
  assigneeId    String?
  assignee      TeamMember? @relation("ComplaintAssignee", fields: [assigneeId], references: [id])

  timeline      Json?

  resolution    String?
  resolvedAt    DateTime?

  channel       ComplaintChannel @default(INTERNAL_SYSTEM)

  trackingCode  String   @unique @default(cuid())

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("complaints")
}

model Recognition {
  id          String   @id @default(cuid())

  fromId      String
  from        TeamMember @relation("RecognitionFrom", fields: [fromId], references: [id])
  toId        String
  to          TeamMember @relation("RecognitionTo", fields: [toId], references: [id])

  message     String
  category    RecognitionCategory
  competency  LegalCompetency?

  isPublic    Boolean  @default(true)

  reactions   Json?

  caseId      String?

  createdAt   DateTime @default(now())

  @@map("recognitions")
}

model WellbeingCheckin {
  id            String   @id @default(cuid())
  teamMemberId  String
  teamMember    TeamMember @relation(fields: [teamMemberId], references: [id])

  mood          Int
  energy        Int
  workload      Int
  satisfaction  Int
  sleepQuality  Int?

  feelingBurnout  Boolean @default(false)
  needsSupport    Boolean @default(false)

  notes         String?

  weekHoursLogged Float?
  deadlinesPending Int?

  aiAlert       String?
  aiAlertLevel  BurnoutRisk?

  checkedAt     DateTime @default(now())

  @@index([teamMemberId, checkedAt])
  @@map("wellbeing_checkins")
}
