generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================
// ENUMS
// ============================================================

enum UserRole {
  ADMIN
  SOCIO
  ADVOGADO
  ESTAGIARIO
}

enum PersonType {
  CLIENTE
  PARTE_CONTRARIA
  JUIZ
  DESEMBARGADOR
  PERITO
  ADMINISTRADOR_JUDICIAL
  CREDOR
  TESTEMUNHA
  OUTRO
}

enum PersonSubtype {
  PESSOA_FISICA
  PESSOA_JURIDICA
}

enum PersonSegment {
  AGRO
  INDUSTRIA
  COMERCIO
  SERVICOS
  FINANCEIRO
  GOVERNO
  OUTRO
}

enum PersonDocType {
  CNH
  RG
  CPF
  CNPJ_CARD
  CONTRATO_SOCIAL
  ALTERACAO_CONTRATO_SOCIAL
  PROCURACAO
  IMPOSTO_RENDA
  BALANCO
  DRE
  ESCRITURA
  CERTIDAO
  COMPROVANTE_ENDERECO
  DOCUMENTO_FINANCEIRO
  DOCUMENTO_FISCAL
  OUTRO
}

enum CaseType {
  RECUPERACAO_JUDICIAL
  FALENCIA
  EXECUCAO
  COBRANCA
  REESTRUTURACAO_EXTRAJUDICIAL
  AGRONEGOCIO
  TRABALHISTA
  TRIBUTARIO
  SOCIETARIO
  CONTRATUAL
  OUTRO
}

enum CaseStatus {
  ATIVO
  SUSPENSO
  ARQUIVADO
  ENCERRADO
}

enum CasePartyRole {
  AUTOR
  REU
  TERCEIRO_INTERESSADO
  ASSISTENTE
  LITISCONSORTE
  AMICUS_CURIAE
  ADMINISTRADOR_JUDICIAL
  MINISTERIO_PUBLICO
  OUTRO
}

enum CaseTeamRole {
  RESPONSAVEL
  MEMBRO
  CONSULTOR
  ESTAGIARIO
}

enum DeadlineType {
  FATAL
  ORDINARIO
  DILIGENCIA
  AUDIENCIA
  ASSEMBLEIA
}

enum DeadlineStatus {
  PENDENTE
  CUMPRIDO
  PERDIDO
  CANCELADO
}

enum MovementType {
  DESPACHO
  DECISAO
  SENTENCA
  ACORDAO
  PUBLICACAO
  INTIMACAO
  CITACAO
  ATO_ORDINATORIO
  OUTRO
}

enum DocumentType {
  PETICAO_INICIAL
  CONTESTACAO
  REPLICA
  EMBARGOS_DECLARACAO
  AGRAVO_INSTRUMENTO
  APELACAO
  RECURSO_ESPECIAL
  RECURSO_EXTRAORDINARIO
  CONTRARRAZOES
  MEMORIAIS
  PLANO_RJ
  LISTA_CREDORES
  HABILITACAO_CREDITO
  IMPUGNACAO_CREDITO
  RELATORIO_AJ
  PARECER
  MEMORANDO
  CONTRATO
  PROCURACAO
  NOTIFICACAO
  PROPOSTA
  CONTRAPROPOSTA
  RELATORIO_CLIENTE
  PLANILHA
  EMAIL_SALVO
  ALVARA
  CERTIDAO
  ACORDO
  OUTRO
}

enum TemplateArea {
  RECUPERACAO_JUDICIAL
  FALENCIA
  EXECUCAO
  AGRONEGOCIO
  TRABALHISTA
  TRIBUTARIO
  SOCIETARIO
  CONTRATUAL
  BANCARIO
  GERAL
}

enum ProjectCategory {
  NEGOCIACAO_COMERCIAL
  FECHAMENTO_OPERACAO
  RECUPERACAO_CREDITO
  PLANEJAMENTO_TRIBUTARIO
  ALVARA_LIBERACAO
  DUE_DILIGENCE
  REESTRUTURACAO_SOCIETARIA
  CONSULTORIA_PERMANENTE
  COMPLIANCE
  SUCESSAO_PATRIMONIAL
  OPERACAO_CREDITO_RURAL
  OUTRO
}

enum ProjectStatus {
  PLANEJAMENTO
  EM_ANDAMENTO
  AGUARDANDO_CLIENTE
  AGUARDANDO_TERCEIRO
  AGUARDANDO_ORGAO
  PAUSADO
  CONCLUIDO
  CANCELADO
}

enum Priority {
  CRITICA
  ALTA
  MEDIA
  BAIXA
}

enum ProjectPhaseStatus {
  NAO_INICIADA
  EM_ANDAMENTO
  CONCLUIDA
  BLOQUEADA
}

enum ProjectTaskType {
  DOCUMENTO
  REUNIAO
  DILIGENCIA
  ANALISE
  COMUNICACAO
  COBRANCA
  ACOMPANHAMENTO
  PROTOCOLO
  OBTENCAO_CERTIDAO
  OBTENCAO_ALVARA
  LIBERACAO_VALORES
  NEGOCIACAO
  ASSINATURA
  REGISTRO
  PAGAMENTO
  OUTRO
}

enum ProjectTaskStatus {
  BACKLOG
  A_FAZER
  EM_ANDAMENTO
  EM_REVISAO
  AGUARDANDO
  CONCLUIDA
  CANCELADA
}

enum MilestoneStatus {
  PENDENTE
  ALCANCADO
  ATRASADO
  CANCELADO
}

enum MilestoneImpact {
  CRITICO
  ALTO
  MEDIO
  BAIXO
}

enum CalendarEventType {
  REUNIAO
  AUDIENCIA
  SUSTENTACAO_ORAL
  DESPACHO_ORAL
  PESQUISA_JURIDICA
  ANALISE_CASO
  PRAZO_ANTECIPADO
  PRAZO_FATAL
  RETORNO_EMAIL
  ATIVIDADE_GERAL
}

enum CalendarEventStatus {
  AGENDADO
  EM_ANDAMENTO
  CONCLUIDO
  CANCELADO
}

enum ActivityType {
  REUNIAO
  AUDIENCIA
  SUSTENTACAO
  DESPACHO
  PESQUISA
  ANALISE
  PETICAO
  EMAIL
  TELEFONEMA
  NEGOCIACAO
  DILIGENCIA
  TAREFA_PROJETO
  MARCO_ALCANCADO
  OUTRO
}

enum CreditorClass {
  I_TRABALHISTA
  II_GARANTIA_REAL
  III_QUIROGRAFARIO
  IV_ME_EPP
}

enum CreditorStatus {
  PENDENTE
  HABILITADO
  IMPUGNADO
  RETIFICADO
  EXCLUIDO
}

enum NegotiationStatus {
  PREPARACAO
  EM_CURSO
  PROPOSTA_ENVIADA
  CONTRAPROPOSTA
  ACORDO
  IMPASSE
  ENCERRADA
}

enum StakeholderRole {
  CLIENTE
  PARTE
  CREDOR
  ORGAO_PUBLICO
  BANCO
  NOTARIO
  CONTADOR
  OUTRO
}

enum ProjectTeamRole {
  RESPONSAVEL
  MEMBRO
  CONSULTOR
  ESTAGIARIO
}

enum LibraryEntryType {
  JURISPRUDENCIA
  SUMULA
  DOUTRINA
  ARTIGO
  LEGISLACAO
  MODELO_PECA
  PARECER_INTERNO
  PESQUISA
  TESE
  NOTA_TECNICA
  LIVRO
  ENUNCIADO
  CONTRATO_MODELO
  ESTRATEGIA
  CASO_REFERENCIA
  MATERIAL_ESTUDO
  TABELA_REFERENCIA
  OUTRO
}

// ============================================================
// JUDICIAL RECOVERY (RJ) ENUMS
// ============================================================

enum JRStatus {
  PROCESSAMENTO
  VERIFICACAO_CREDITOS
  AGC_PENDENTE
  PLANO_APROVADO
  CUMPRIMENTO
  ENCERRADA
  CONVOLADA_FALENCIA
}

enum CreditClass {
  CLASSE_I_TRABALHISTA
  CLASSE_II_GARANTIA_REAL
  CLASSE_III_QUIROGRAFARIO
  CLASSE_IV_ME_EPP
}

enum CreditNature {
  TRABALHISTA
  ACIDENTARIO
  HIPOTECA
  PENHOR
  ALIENACAO_FIDUCIARIA_IMOVEL
  ALIENACAO_FIDUCIARIA_MOVEL
  CESSAO_FIDUCIARIA_RECEBIVEIS
  ANTICRESE
  QUIROGRAFARIO
  PRIVILEGIO_ESPECIAL
  PRIVILEGIO_GERAL
  SUBORDINADO
  ME_EPP
}

enum GuaranteeType {
  HIPOTECA
  PENHOR
  ALIENACAO_FIDUCIARIA
  CESSAO_FIDUCIARIA
  ANTICRESE
  NONE
}

enum RJCreditStatus {
  HABILITADO
  HABILITACAO_RETARDATARIA
  IMPUGNADO
  DIVERGENCIA
  EXCLUIDO
  EXTRACONCURSAL
}

enum VoteDirection {
  FAVOR
  CONTRA
  ABSTENCAO
  AUSENTE
}

enum IndexationType {
  TR
  IPCA
  IGP_M
  CDI
  SELIC
  INPC
  SEM_CORRECAO
}

enum CreditorSource {
  MANUAL
  IMPORT_CSV
  IMPORT_EXCEL
  IMPORT_PJE
  HABILITACAO
}

enum SubclassValidation {
  RASCUNHO
  PENDENTE_VALIDACAO
  VALIDADA
  REJEITADA
  REQUER_AJUSTE
}

enum CramDownRisk {
  BAIXO
  MEDIO
  ALTO
  CRITICO
}

enum TableVersionType {
  INICIAL
  AJ_VERIFICACAO
  POS_HABILITACOES
  CONSOLIDADO_AGC
  RETIFICACAO
  HOMOLOGADO
}

enum ChallengeType {
  HABILITACAO
  HABILITACAO_RETARDATARIA
  IMPUGNACAO_CREDOR
  IMPUGNACAO_MP
  IMPUGNACAO_DEVEDOR
  DIVERGENCIA
}

enum ChallengeResolution {
  DEFERIDA
  DEFERIDA_PARCIAL
  INDEFERIDA
  DESISTENCIA
  ACORDO
  PENDENTE
}

enum CreditorDocType {
  CONTRATO
  NOTA_FISCAL
  DUPLICATA
  CCB
  CPR
  SENTENCA_TRABALHISTA
  CERTIDAO_CREDITO
  COMPROVANTE_GARANTIA
  HABILITACAO_PETICAO
  IMPUGNACAO_PETICAO
  PROCURACAO
  OUTROS
}

enum InstallmentStatus {
  PENDENTE
  VENCIDO
  PAGO
  PAGO_PARCIAL
  INADIMPLIDO
}

// ============================================================
// MODELS
// ============================================================

model User {
  id              String   @id @default(cuid())
  name            String
  email           String   @unique
  password        String
  role            UserRole @default(ADVOGADO)
  oab_number      String?
  microsoft_tokens Json?
  avatar_url      String?
  active          Boolean  @default(true)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  // Relations
  cases_responsible    Case[]               @relation("CaseResponsible")
  case_teams           CaseTeam[]
  deadlines            Deadline[]
  documents_created    Document[]
  templates_created    Template[]
  activities           Activity[]
  calendar_events      CalendarEvent[]       @relation("EventResponsible")
  calendar_created     CalendarEvent[]       @relation("EventCreator")
  projects_responsible Project[]             @relation("ProjectResponsible")
  project_teams        ProjectTeam[]
  project_tasks        ProjectTask[]
  task_comments        ProjectTaskComment[]
  task_check_done      ProjectTaskCheckItem[] @relation("CheckItemDoneBy")
  project_notes        ProjectNote[]
  persons_created      Person[]              @relation("PersonCreator")
  person_docs_uploaded PersonDocument[]
  financial_releases_created FinancialRelease[] @relation("FinancialReleaseCreator")
  reports_created      ReportSnapshot[]       @relation("ReportCreator")
  chat_messages        ChatMessage[]
  ai_usage_logs        AIUsageLog[]           @relation("AIUsageLogs")
  library_search_logs  LibrarySearchLog[]     @relation("LibrarySearchLogs")

  @@map("users")
}

model Person {
  id              String        @id @default(cuid())
  tipo            PersonType
  subtipo         PersonSubtype
  nome            String
  razao_social    String?
  cpf_cnpj        String?       @unique
  rg              String?
  orgao_emissor   String?
  nacionalidade   String?
  estado_civil    String?
  profissao       String?
  data_nascimento DateTime?

  // Address
  cep          String?
  logradouro   String?
  numero       String?
  complemento  String?
  bairro       String?
  cidade       String?
  estado       String?
  pais         String?  @default("Brasil")

  // Contacts
  telefone_fixo    String?
  celular          String?
  whatsapp         String?
  email            String?
  email_secundario String?

  // Banking (encrypted in practice)
  banco   String?
  agencia String?
  conta   String?
  pix     String?

  segmento    PersonSegment?
  observacoes String?

  // Portal access
  portal_access   Boolean @default(false)
  portal_password String?

  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  created_by_id String?
  created_by    User?    @relation("PersonCreator", fields: [created_by_id], references: [id])

  // Relations
  person_documents     PersonDocument[]
  case_parties         CaseParty[]
  cases_as_client      Case[]              @relation("CaseClient")
  cases_as_judge       Case[]              @relation("CaseJudge")
  creditors            Creditor[]
  negotiations         Negotiation[]       @relation("NegotiationPerson")
  projects_as_client   Project[]           @relation("ProjectClient")
  project_stakeholders ProjectStakeholder[]
  activities           Activity[]
  financial_releases   FinancialRelease[]
  report_snapshots     ReportSnapshot[]
  rj_creditors         RJCreditor[]             @relation("RJCreditorPerson")
  rj_admin_cases       JudicialRecoveryCase[]   @relation("RJAdminJudicial")
  extraconcursal_creditors ExtraconcursalCreditor[] @relation("ExtraconcursalPerson")

  @@map("persons")
}

model PersonDocument {
  id           String        @id @default(cuid())
  person_id    String
  person       Person        @relation(fields: [person_id], references: [id], onDelete: Cascade)
  tipo         PersonDocType
  titulo       String
  arquivo_url  String
  data_validade DateTime?
  observacoes  String?
  uploaded_at  DateTime      @default(now())
  uploaded_by_id String?
  uploaded_by  User?         @relation(fields: [uploaded_by_id], references: [id])

  @@map("person_documents")
}

model Case {
  id               String     @id @default(cuid())
  numero_processo  String?    @unique
  tipo             CaseType
  status           CaseStatus @default(ATIVO)
  fase_processual  String?
  vara             String?
  comarca          String?
  tribunal         String?
  uf               String?
  juiz_id          String?
  juiz             Person?    @relation("CaseJudge", fields: [juiz_id], references: [id])
  valor_causa      Decimal?   @db.Decimal(18, 2)
  valor_risco      Decimal?   @db.Decimal(18, 2)

  cliente_id              String
  cliente                 Person  @relation("CaseClient", fields: [cliente_id], references: [id])
  advogado_responsavel_id String
  advogado_responsavel    User    @relation("CaseResponsible", fields: [advogado_responsavel_id], references: [id])

  projeto_id String?
  projeto    Project? @relation(fields: [projeto_id], references: [id])

  tags String[] @default([])

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  partes        CaseParty[]
  equipe        CaseTeam[]
  prazos        Deadline[]
  documentos    Document[]
  movimentacoes CaseMovement[]
  atividades    Activity[]
  credores      Creditor[]
  negociacoes   Negotiation[]
  calendar_events CalendarEvent[]
  library_entries     LibraryEntry[]      @relation("LibraryCases")
  library_refs        LibraryEntry[]      @relation("LibraryCaseRef")
  financial_releases  FinancialRelease[]
  chat_messages       ChatMessage[]       @relation("ChatMessageCase")
  judicialRecoveryCase JudicialRecoveryCase?

  @@map("cases")
}

model CaseParty {
  id        String        @id @default(cuid())
  case_id   String
  case_     Case          @relation(fields: [case_id], references: [id], onDelete: Cascade)
  person_id String
  person    Person        @relation(fields: [person_id], references: [id])
  role      CasePartyRole

  @@unique([case_id, person_id, role])
  @@map("case_parties")
}

model CaseTeam {
  id      String       @id @default(cuid())
  case_id String
  case_   Case         @relation(fields: [case_id], references: [id], onDelete: Cascade)
  user_id String
  user    User         @relation(fields: [user_id], references: [id])
  role    CaseTeamRole

  @@unique([case_id, user_id])
  @@map("case_teams")
}

model Deadline {
  id             String         @id @default(cuid())
  case_id        String
  case_          Case           @relation(fields: [case_id], references: [id], onDelete: Cascade)
  tipo           DeadlineType
  descricao      String
  data_limite    DateTime
  data_alerta    DateTime[]
  status         DeadlineStatus @default(PENDENTE)
  responsavel_id String
  responsavel    User           @relation(fields: [responsavel_id], references: [id])
  recorrente     Boolean        @default(false)
  origem         String?
  movimento_id   String?
  lembrete_enviado Boolean      @default(false)
  documento_cumprimento_id String?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("deadlines")
}

model CaseMovement {
  id                String       @id @default(cuid())
  case_id           String
  case_             Case         @relation(fields: [case_id], references: [id], onDelete: Cascade)
  data              DateTime
  tipo              MovementType
  descricao         String
  conteudo_integral String?      @db.Text
  fonte             String?
  fonte_url         String?
  prazo_gerado      Boolean      @default(false)
  notificar_cliente Boolean      @default(false)
  lida              Boolean      @default(false)
  created_at        DateTime     @default(now())

  @@map("case_movements")
}

model Document {
  id               String       @id @default(cuid())
  case_id          String?
  case_            Case?        @relation(fields: [case_id], references: [id])
  person_id        String?
  negotiation_id   String?
  negotiation      Negotiation? @relation(fields: [negotiation_id], references: [id])
  project_id       String?
  project          Project?     @relation(fields: [project_id], references: [id])
  task_id          String?
  task             ProjectTask? @relation(fields: [task_id], references: [id])
  tipo             DocumentType
  titulo           String
  arquivo_url      String?
  versao           Int          @default(1)
  gerado_por_ia    Boolean      @default(false)
  template_id      String?
  criado_por_id    String?
  criado_por       User?        @relation(fields: [criado_por_id], references: [id])
  compartilhado_portal Boolean  @default(false)
  tags             String[]     @default([])
  created_at       DateTime     @default(now())
  updated_at       DateTime     @updatedAt

  @@map("documents")
}

model Template {
  id              String       @id @default(cuid())
  nome            String
  tipo_documento  DocumentType
  area            TemplateArea
  conteudo        String       @db.Text
  variaveis       String[]     @default([])
  prompt_ia       String?      @db.Text
  estrutura_topicos String?    @db.Text
  ativo           Boolean      @default(true)
  created_by_id   String?
  created_by      User?        @relation(fields: [created_by_id], references: [id])
  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt

  @@map("templates")
}

model Creditor {
  id                 String        @id @default(cuid())
  case_id            String
  case_              Case          @relation(fields: [case_id], references: [id], onDelete: Cascade)
  person_id          String
  person             Person        @relation(fields: [person_id], references: [id])
  classe             CreditorClass
  valor_original     Decimal       @db.Decimal(18, 2)
  valor_atualizado   Decimal?      @db.Decimal(18, 2)
  valor_sujeito_plano Decimal?     @db.Decimal(18, 2)
  garantias          String?
  status_credito     CreditorStatus @default(PENDENTE)
  voto               String?
  created_at         DateTime      @default(now())
  updated_at         DateTime      @updatedAt

  @@map("creditors")
}

model Negotiation {
  id                String            @id @default(cuid())
  case_id           String?
  case_             Case?             @relation(fields: [case_id], references: [id])
  project_id        String?
  project           Project?          @relation(fields: [project_id], references: [id])
  creditor_id       String?
  person_id         String?
  person            Person?           @relation("NegotiationPerson", fields: [person_id], references: [id])
  status            NegotiationStatus @default(PREPARACAO)
  timeline_eventos  Json?
  propostas         Json?
  contrapropostas   Json?
  valor_pretendido  Decimal?          @db.Decimal(18, 2)
  valor_proposto    Decimal?          @db.Decimal(18, 2)
  valor_acordado    Decimal?          @db.Decimal(18, 2)
  analise_financeira Json?
  created_at        DateTime          @default(now())
  updated_at        DateTime          @updatedAt

  documents Document[]

  @@map("negotiations")
}

model CalendarEvent {
  id            String              @id @default(cuid())
  case_id       String?
  case_         Case?               @relation(fields: [case_id], references: [id])
  project_id    String?
  project       Project?            @relation(fields: [project_id], references: [id])
  task_id       String?
  task          ProjectTask?        @relation(fields: [task_id], references: [id])
  tipo_evento   CalendarEventType
  titulo        String
  descricao     String?             @db.Text
  data_inicio   DateTime
  data_fim      DateTime?
  dia_inteiro   Boolean             @default(false)
  local         String?
  link_virtual  String?
  campos_especificos Json?
  status        CalendarEventStatus @default(AGENDADO)
  responsavel_id String?
  responsavel   User?               @relation("EventResponsible", fields: [responsavel_id], references: [id])
  participantes_internos String[]   @default([])
  participantes_externos String[]   @default([])
  lembrete_minutos Int?
  recorrencia   Json?
  sincronizado_outlook Boolean      @default(false)
  outlook_event_id     String?
  cor           String?
  created_at    DateTime            @default(now())
  updated_at    DateTime            @updatedAt
  created_by_id String?
  created_by    User?               @relation("EventCreator", fields: [created_by_id], references: [id])

  activities Activity[]

  @@map("calendar_events")
}

model Activity {
  id                String        @id @default(cuid())
  case_id           String?
  case_             Case?         @relation(fields: [case_id], references: [id])
  project_id        String?
  project           Project?      @relation(fields: [project_id], references: [id])
  task_id           String?
  task              ProjectTask?  @relation(fields: [task_id], references: [id])
  calendar_event_id String?
  calendar_event    CalendarEvent? @relation(fields: [calendar_event_id], references: [id])
  person_id         String?
  person            Person?       @relation(fields: [person_id], references: [id])
  user_id           String
  user              User          @relation(fields: [user_id], references: [id])
  tipo              ActivityType
  subtipo           String?
  descricao         String        @db.Text
  data              DateTime
  duracao_minutos   Int?
  resultado         String?       @db.Text
  visivel_portal    Boolean       @default(false)
  faturavel         Boolean       @default(true)
  valor_hora        Decimal?      @db.Decimal(10, 2)
  include_in_report Boolean       @default(true)
  report_priority   Int           @default(0)
  communication_type String?
  recipients        String[]      @default([])
  financial_impact  Decimal?      @db.Decimal(15, 2)
  financial_type    String?
  created_at        DateTime      @default(now())
  updated_at        DateTime      @updatedAt

  @@index([case_id])
  @@index([project_id])
  @@index([person_id])
  @@index([tipo])
  @@index([created_at(sort: Desc)])
  @@map("activities")
}

model FinancialRelease {
  id               String   @id @default(cuid())
  tipo             String   // ALVARA, RPV, PRECATORIO
  numero_referencia String
  case_id          String?
  case_            Case?    @relation(fields: [case_id], references: [id])
  person_id        String?
  person           Person?  @relation(fields: [person_id], references: [id])
  valor            Decimal  @db.Decimal(15, 2)
  status           String   @default("PENDENTE") // PENDENTE, EXPEDIDO, LIBERADO, BLOQUEADO, CANCELADO
  data_prevista    DateTime? @db.Date
  data_liberacao   DateTime? @db.Date
  observacoes      String?  @db.Text
  activity_id      String?
  created_by_id    String?
  created_by       User?    @relation("FinancialReleaseCreator", fields: [created_by_id], references: [id])
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  @@index([person_id])
  @@index([case_id])
  @@index([status])
  @@map("financial_releases")
}

model ReportSnapshot {
  id              String   @id @default(cuid())
  person_id       String
  person          Person   @relation(fields: [person_id], references: [id], onDelete: Cascade)
  period_start    DateTime @db.Date
  period_end      DateTime @db.Date
  executive_summary String? @db.Text
  next_steps      String?  @db.Text
  kpis_data       Json?
  report_data     Json?
  pdf_path        String?
  shared_with_client Boolean @default(false)
  shared_at       DateTime?
  created_by_id   String?
  created_by      User?    @relation("ReportCreator", fields: [created_by_id], references: [id])
  created_at      DateTime @default(now())

  @@index([person_id])
  @@index([period_start, period_end])
  @@map("report_snapshots")
}

model LibraryEntry {
  id              String           @id @default(cuid())
  tipo            LibraryEntryType
  titulo          String
  resumo          String?          @db.Text
  conteudo        String?          @db.Text
  fonte           String?
  url_fonte       String?
  area            TemplateArea?
  tags            String[]         @default([])
  arquivo_url     String?
  relevancia      Int?             @default(0)
  favorito        Boolean          @default(false)
  metadata        Json?
  arquivo_tipo    String?
  arquivo_tamanho Int?
  case_id         String?
  case_           Case?            @relation("LibraryCaseRef", fields: [case_id], references: [id])

  utilizado_em_casos    Case[]    @relation("LibraryCases")
  utilizado_em_projetos Project[] @relation("LibraryProjects")

  created_at    DateTime @default(now())
  updated_at    DateTime @default(now()) @updatedAt
  created_by_id String?

  @@index([tipo])
  @@index([area])
  @@index([case_id])
  @@map("library_entries")
}

// ============================================================
// PROJECT MODULE MODELS
// ============================================================

model Project {
  id          String          @id @default(cuid())
  titulo      String
  codigo      String          @unique
  cliente_id  String
  cliente     Person          @relation("ProjectClient", fields: [cliente_id], references: [id])
  categoria   ProjectCategory
  descricao   String?         @db.Text
  valor_envolvido  Decimal?   @db.Decimal(18, 2)
  valor_honorarios Decimal?   @db.Decimal(18, 2)
  status      ProjectStatus   @default(PLANEJAMENTO)
  prioridade  Priority        @default(MEDIA)
  data_inicio DateTime?
  data_prevista_conclusao DateTime?
  data_conclusao_real     DateTime?
  advogado_responsavel_id String
  advogado_responsavel    User    @relation("ProjectResponsible", fields: [advogado_responsavel_id], references: [id])
  visivel_portal Boolean     @default(false)
  tags         String[]      @default([])
  created_at   DateTime      @default(now())
  updated_at   DateTime      @updatedAt
  created_by_id String?

  // Relations
  equipe          ProjectTeam[]
  stakeholders    ProjectStakeholder[]
  processos       Case[]
  etapas          ProjectPhase[]
  tarefas         ProjectTask[]
  marcos          ProjectMilestone[]
  documentos      Document[]
  atividades      Activity[]
  anotacoes       ProjectNote[]
  despesas        ProjectExpense[]
  negociacoes     Negotiation[]
  calendar_events CalendarEvent[]
  library_entries LibraryEntry[] @relation("LibraryProjects")
  chat_messages   ChatMessage[]  @relation("ChatMessageProject")

  @@map("projects")
}

model ProjectTeam {
  id         String          @id @default(cuid())
  project_id String
  project    Project         @relation(fields: [project_id], references: [id], onDelete: Cascade)
  user_id    String
  user       User            @relation(fields: [user_id], references: [id])
  role       ProjectTeamRole

  @@unique([project_id, user_id])
  @@map("project_teams")
}

model ProjectStakeholder {
  id         String          @id @default(cuid())
  project_id String
  project    Project         @relation(fields: [project_id], references: [id], onDelete: Cascade)
  person_id  String
  person     Person          @relation(fields: [person_id], references: [id])
  role       StakeholderRole

  @@unique([project_id, person_id, role])
  @@map("project_stakeholders")
}

model ProjectPhase {
  id                    String             @id @default(cuid())
  project_id            String
  project               Project            @relation(fields: [project_id], references: [id], onDelete: Cascade)
  titulo                String
  descricao             String?            @db.Text
  ordem                 Int
  status                ProjectPhaseStatus @default(NAO_INICIADA)
  data_inicio_prevista  DateTime?
  data_fim_prevista     DateTime?
  data_inicio_real      DateTime?
  data_fim_real         DateTime?
  percentual_conclusao  Int                @default(0)
  dependencia_fase_id   String?
  dependencia_fase      ProjectPhase?      @relation("PhaseDependency", fields: [dependencia_fase_id], references: [id])
  fases_dependentes     ProjectPhase[]     @relation("PhaseDependency")
  cor                   String?

  tarefas ProjectTask[]

  @@map("project_phases")
}

model ProjectTask {
  id          String            @id @default(cuid())
  project_id  String
  project     Project           @relation(fields: [project_id], references: [id], onDelete: Cascade)
  phase_id    String?
  phase       ProjectPhase?     @relation(fields: [phase_id], references: [id])
  case_id     String?
  titulo      String
  descricao   String?           @db.Text
  tipo        ProjectTaskType   @default(OUTRO)
  status      ProjectTaskStatus @default(BACKLOG)
  prioridade  Priority          @default(MEDIA)
  responsavel_id String?
  responsavel User?             @relation(fields: [responsavel_id], references: [id])
  data_limite DateTime?
  data_alerta DateTime?
  data_conclusao DateTime?
  estimativa_horas Decimal?     @db.Decimal(6, 2)
  horas_gastas     Decimal?     @db.Decimal(6, 2)
  campos_especificos Json?
  dependencia_tarefa_id String?
  dependencia_tarefa    ProjectTask?  @relation("TaskDependency", fields: [dependencia_tarefa_id], references: [id])
  tarefas_dependentes   ProjectTask[] @relation("TaskDependency")
  notificar_cliente Boolean       @default(false)
  created_at  DateTime          @default(now())
  updated_at  DateTime          @updatedAt

  // Relations
  checklist       ProjectTaskCheckItem[]
  comentarios     ProjectTaskComment[]
  documentos      Document[]
  calendar_events CalendarEvent[]
  activities      Activity[]

  @@map("project_tasks")
}

model ProjectTaskCheckItem {
  id             String    @id @default(cuid())
  task_id        String
  task           ProjectTask @relation(fields: [task_id], references: [id], onDelete: Cascade)
  descricao      String
  concluido      Boolean   @default(false)
  concluido_por_id String?
  concluido_por  User?     @relation("CheckItemDoneBy", fields: [concluido_por_id], references: [id])
  concluido_em   DateTime?
  ordem          Int       @default(0)

  @@map("project_task_check_items")
}

model ProjectTaskComment {
  id         String      @id @default(cuid())
  task_id    String
  task       ProjectTask @relation(fields: [task_id], references: [id], onDelete: Cascade)
  user_id    String
  user       User        @relation(fields: [user_id], references: [id])
  conteudo   String      @db.Text
  created_at DateTime    @default(now())

  @@map("project_task_comments")
}

model ProjectMilestone {
  id               String          @id @default(cuid())
  project_id       String
  project          Project         @relation(fields: [project_id], references: [id], onDelete: Cascade)
  titulo           String
  descricao        String?         @db.Text
  data_prevista    DateTime?
  data_alcancada   DateTime?
  status           MilestoneStatus @default(PENDENTE)
  impacto          MilestoneImpact @default(MEDIO)
  notificar_cliente Boolean        @default(false)

  @@map("project_milestones")
}

model ProjectNote {
  id         String   @id @default(cuid())
  project_id String
  project    Project  @relation(fields: [project_id], references: [id], onDelete: Cascade)
  user_id    String
  user       User     @relation(fields: [user_id], references: [id])
  conteudo   String   @db.Text
  fixada     Boolean  @default(false)
  created_at DateTime @default(now())

  @@map("project_notes")
}

model Holiday {
  id   String   @id @default(cuid())
  data DateTime @db.Date
  nome String
  tipo String   // NACIONAL, ESTADUAL, MUNICIPAL
  uf   String?  // null for national, state code for state holidays

  @@unique([data, nome])
  @@map("holidays")
}

model ProjectExpense {
  id              String   @id @default(cuid())
  project_id      String
  project         Project  @relation(fields: [project_id], references: [id], onDelete: Cascade)
  descricao       String
  valor           Decimal  @db.Decimal(18, 2)
  data            DateTime
  categoria       String   // CERTIDAO, REGISTRO, CUSTAS, VIAGEM, PERICIA, OUTRO
  comprovante_url String?
  created_by_id   String?
  created_at      DateTime @default(now())

  @@map("project_expenses")
}

model ProjectTemplate {
  id           String          @id @default(cuid())
  titulo       String
  categoria    ProjectCategory
  descricao    String?         @db.Text
  fases_padrao Json?
  marcos_padrao Json?
  ativo        Boolean         @default(true)
  created_at   DateTime        @default(now())

  @@map("project_templates")
}

// ============================================================
// AI / CONFECÇÃO MODULE MODELS
// ============================================================

model ChatMessage {
  id        String   @id @default(cuid())
  sessionId String
  role      String   // 'user' | 'assistant' | 'system'
  content   String   @db.Text
  metadata  Json?

  caseId    String?
  case_     Case?    @relation("ChatMessageCase", fields: [caseId], references: [id])
  projectId String?
  project   Project? @relation("ChatMessageProject", fields: [projectId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@index([sessionId])
  @@index([caseId])
  @@index([userId])
  @@map("chat_messages")
}

model AIUsageLog {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation("AIUsageLogs", fields: [userId], references: [id])
  actionType String   // 'chat' | 'generate' | 'review'
  docType    String?
  tokensIn   Int      @default(0)
  tokensOut  Int      @default(0)
  model         String
  durationMs    Int      @default(0)
  costEstimated Decimal  @default(0) @db.Decimal(10, 6)
  caseId        String?
  projectId     String?
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@map("ai_usage_logs")
}

model LibrarySearchLog {
  id                    String   @id @default(cuid())
  user_id               String
  user                  User     @relation("LibrarySearchLogs", fields: [user_id], references: [id])
  query                 String   @db.Text
  results_count         Int
  entries_used          String[] @default([])
  document_generated_id String?
  context               String   // CHAT | DOCUMENTO | REVISAO | MANUAL
  created_at            DateTime @default(now())

  @@index([user_id])
  @@index([created_at])
  @@map("library_search_logs")
}

// ============================================================
// JUDICIAL RECOVERY (RJ) MODULE MODELS
// ============================================================

model JudicialRecoveryCase {
  id                    String    @id @default(cuid())
  case_id               String    @unique
  case_                 Case      @relation(fields: [case_id], references: [id], onDelete: Cascade)

  // RJ-specific data
  status_rj             JRStatus  @default(PROCESSAMENTO)
  data_pedido           DateTime?
  data_deferimento      DateTime?
  data_agc              DateTime?
  data_aprovacao_plano  DateTime?
  data_homologacao      DateTime?
  data_encerramento     DateTime?

  // Administrador Judicial
  administrador_judicial_id String?
  administrador_judicial    Person?  @relation("RJAdminJudicial", fields: [administrador_judicial_id], references: [id])

  // Totals (cached, recalculated)
  total_credores        Int       @default(0)
  total_credito         BigInt    @default(0)
  total_classe_i        BigInt    @default(0)
  total_classe_ii       BigInt    @default(0)
  total_classe_iii      BigInt    @default(0)
  total_classe_iv       BigInt    @default(0)

  // Plan info
  plano_versao          Int       @default(0)
  plano_aprovado        Boolean   @default(false)

  observacoes           String?   @db.Text

  created_at            DateTime  @default(now())
  updated_at            DateTime  @updatedAt

  // Relations
  credores              RJCreditor[]
  subclasses            CreditorSubclass[]
  versoes               CreditorTableVersion[]
  impugnacoes           CreditorChallenge[]
  voting_scenarios      VotingScenario[]
  financial_projections FinancialProjection[]
  negotiations          RJNegotiation[]
  extraconcursais       ExtraconcursalCreditor[]

  @@map("judicial_recovery_cases")
}

model RJCreditor {
  id                    String          @id @default(cuid())
  jrc_id                String
  jrc                   JudicialRecoveryCase @relation(fields: [jrc_id], references: [id], onDelete: Cascade)

  // Identification
  nome                  String
  cpf_cnpj              String?
  pessoa_fisica         Boolean         @default(false)

  // Optional link to Person
  person_id             String?
  person                Person?         @relation("RJCreditorPerson", fields: [person_id], references: [id])

  // Classification
  classe                CreditClass
  natureza              CreditNature
  status                RJCreditStatus  @default(HABILITADO)
  fonte                 CreditorSource  @default(MANUAL)

  // Values (all stored as BigInt centavos for precision)
  valor_original        BigInt          @default(0)
  valor_atualizado      BigInt          @default(0)
  valor_garantia        BigInt          @default(0)
  valor_quirografario   BigInt          @default(0)
  valor_trabalhista_150sm BigInt        @default(0)
  valor_trabalhista_excedente BigInt    @default(0)

  // Guarantee details
  tipo_garantia         GuaranteeType   @default(NONE)
  descricao_garantia    String?         @db.Text
  matricula_imovel      String?
  valor_avaliacao_garantia BigInt       @default(0)

  // Payment terms from plan
  desagio_percentual    Float?
  carencia_meses        Int?
  parcelas              Int?
  indexador             IndexationType?
  juros_percentual      Float?

  // Voting
  voto                  VoteDirection?
  presente_agc          Boolean         @default(false)

  // Subclass
  subclass_id           String?
  subclass              CreditorSubclass? @relation(fields: [subclass_id], references: [id])

  // Metadata
  observacoes           String?         @db.Text
  ordem                 Int             @default(0)

  created_at            DateTime        @default(now())
  updated_at            DateTime        @updatedAt

  // Relations
  documentos            CreditorDocument[]
  impugnacoes           CreditorChallenge[]
  parcelas_pgto         PaymentInstallment[]
  negotiation_creditors NegotiationCreditor[]

  @@index([jrc_id])
  @@index([classe])
  @@index([status])
  @@index([subclass_id])
  @@map("rj_creditors")
}

model CreditorSubclass {
  id                    String              @id @default(cuid())
  jrc_id                String
  jrc                   JudicialRecoveryCase @relation(fields: [jrc_id], references: [id], onDelete: Cascade)

  nome                  String
  descricao             String?             @db.Text
  classe_base           CreditClass

  // STJ REsp 1.634.844/SP validation
  criterios_objetivos   Json?
  justificativa_interesse_homogeneo String? @db.Text
  protecao_direitos     String?             @db.Text

  // Payment conditions for this subclass
  desagio_percentual    Float?
  carencia_meses        Int?
  parcelas              Int?
  indexador             IndexationType?
  juros_percentual      Float?

  // Validation status
  validacao             SubclassValidation  @default(RASCUNHO)
  validacao_notas       String?             @db.Text
  risco_cram_down       CramDownRisk?

  // Stats (cached)
  total_credores        Int                 @default(0)
  total_valor           BigInt              @default(0)

  ordem                 Int                 @default(0)
  cor                   String?

  created_at            DateTime            @default(now())
  updated_at            DateTime            @updatedAt

  // Relations
  credores              RJCreditor[]

  @@index([jrc_id])
  @@index([classe_base])
  @@map("creditor_subclasses")
}

model CreditorTableVersion {
  id                    String              @id @default(cuid())
  jrc_id                String
  jrc                   JudicialRecoveryCase @relation(fields: [jrc_id], references: [id], onDelete: Cascade)

  versao                Int
  tipo                  TableVersionType
  titulo                String
  descricao             String?             @db.Text

  // Snapshot data
  snapshot_data         Json
  summary_data          Json?

  // Metadata
  publicada             Boolean             @default(false)
  data_publicacao       DateTime?

  created_at            DateTime            @default(now())
  created_by_id         String?

  @@index([jrc_id])
  @@map("creditor_table_versions")
}

model CreditorChallenge {
  id                    String              @id @default(cuid())
  jrc_id                String
  jrc                   JudicialRecoveryCase @relation(fields: [jrc_id], references: [id], onDelete: Cascade)

  creditor_id           String?
  creditor              RJCreditor?         @relation(fields: [creditor_id], references: [id])

  tipo                  ChallengeType
  requerente_nome       String
  requerente_cpf_cnpj   String?

  // Values
  valor_pretendido      BigInt              @default(0)
  classe_pretendida     CreditClass?

  // Resolution
  resolucao             ChallengeResolution @default(PENDENTE)
  valor_reconhecido     BigInt?
  classe_reconhecida    CreditClass?

  // Process info
  numero_processo       String?
  data_protocolo        DateTime?
  data_resolucao        DateTime?
  fundamentacao         String?             @db.Text
  decisao               String?             @db.Text

  created_at            DateTime            @default(now())
  updated_at            DateTime            @updatedAt

  @@index([jrc_id])
  @@index([creditor_id])
  @@map("creditor_challenges")
}

model CreditorDocument {
  id                    String              @id @default(cuid())
  creditor_id           String
  creditor              RJCreditor          @relation(fields: [creditor_id], references: [id], onDelete: Cascade)

  tipo                  CreditorDocType
  titulo                String
  arquivo_url           String?
  observacoes           String?

  uploaded_at           DateTime            @default(now())

  @@index([creditor_id])
  @@map("creditor_documents")
}

model PaymentInstallment {
  id                    String              @id @default(cuid())
  creditor_id           String
  creditor              RJCreditor          @relation(fields: [creditor_id], references: [id], onDelete: Cascade)

  numero                Int
  data_vencimento       DateTime
  valor_principal       BigInt              @default(0)
  valor_juros           BigInt              @default(0)
  valor_correcao        BigInt              @default(0)
  valor_total           BigInt              @default(0)
  valor_pago            BigInt              @default(0)

  status                InstallmentStatus   @default(PENDENTE)
  data_pagamento        DateTime?

  created_at            DateTime            @default(now())

  @@index([creditor_id])
  @@map("payment_installments")
}

// ============================================================
// PRJ APPROVAL MODULE MODELS
// ============================================================

enum ScenarioType {
  BASE
  OTIMISTA
  PESSIMISTA
  CRAM_DOWN
  CUSTOM
}

enum ProjectionStatus {
  RASCUNHO
  EM_ANALISE
  APROVADO
  REJEITADO
}

model VotingScenario {
  id                    String              @id @default(cuid())
  jrc_id                String
  jrc                   JudicialRecoveryCase @relation(fields: [jrc_id], references: [id], onDelete: Cascade)

  nome                  String
  tipo                  ScenarioType        @default(BASE)
  descricao             String?             @db.Text

  // Scenario data: overrides per creditor { creditor_id: { voto, presente_agc } }
  overrides             Json?

  // Computed results (cached)
  resultado             Json?
  aprovado              Boolean?
  cram_down_viavel      Boolean?

  ativo                 Boolean             @default(true)

  created_at            DateTime            @default(now())
  updated_at            DateTime            @updatedAt
  created_by_id         String?

  @@index([jrc_id])
  @@map("voting_scenarios")
}

model FinancialProjection {
  id                    String              @id @default(cuid())
  jrc_id                String
  jrc                   JudicialRecoveryCase @relation(fields: [jrc_id], references: [id], onDelete: Cascade)

  nome                  String
  tipo                  ScenarioType        @default(BASE)
  status                ProjectionStatus    @default(RASCUNHO)

  // Input parameters
  anos_projecao         Int                 @default(5)
  receita_ano_base      BigInt              @default(0)
  taxa_crescimento      Float               @default(0)    // % annual
  margem_ebitda         Float               @default(0)    // %
  capex_percentual      Float               @default(0)    // % of revenue
  capital_giro_pct      Float               @default(0)    // % of revenue
  taxa_desconto         Float               @default(12)   // % annual (WACC)
  aliquota_ir           Float               @default(34)   // IRPJ + CSLL

  // Stress test parameters
  stress_receita        Float?              // % variation
  stress_margem         Float?              // % variation
  stress_juros          Float?              // % variation

  // Computed results (cached as JSON)
  resultado_dre         Json?
  resultado_fluxo_caixa Json?
  resultado_dscr        Json?
  resultado_sensibilidade Json?

  observacoes           String?             @db.Text

  created_at            DateTime            @default(now())
  updated_at            DateTime            @updatedAt
  created_by_id         String?

  @@index([jrc_id])
  @@map("financial_projections")
}

// ============================================================
// NEGOTIATION MODULE — Enums
// ============================================================

enum NegotiationPhase {
  MAPEAMENTO
  CONTATO_INICIAL
  PROPOSTA_ENVIADA
  CONTRAPROPOSTA
  MEDIACAO
  ACORDO_VERBAL
  FORMALIZACAO
  HOMOLOGACAO
  CONCLUIDA
  IMPASSE
}

enum NegotiationPriority {
  CRITICA
  ALTA
  MEDIA
  BAIXA
}

enum CreditorNegotiationStatus {
  NAO_CONTATADO
  EM_CONTATO
  PROPOSTA_RECEBIDA
  CONTRAPROPOSTA_ENVIADA
  EM_MEDIACAO
  ACORDO_PARCIAL
  ACORDO_TOTAL
  RECUSOU
  PARCEIRO
  DESISTIU
}

enum NegActivityType {
  CONTATO_TELEFONICO
  EMAIL_ENVIADO
  EMAIL_RECEBIDO
  REUNIAO_PRESENCIAL
  REUNIAO_VIRTUAL
  PROPOSTA_ENVIADA
  CONTRAPROPOSTA_RECEBIDA
  ACORDO_VERBAL
  ACORDO_FORMALIZADO
  DOCUMENTO_ENVIADO
  DOCUMENTO_RECEBIDO
  MEDIACAO_SESSAO
  OBSERVACAO
}

enum NegTemplateType {
  PROPOSTA_INICIAL
  CONTRAPROPOSTA
  CONVITE_PARCEIRO
  CONVITE_MEDIACAO
  TERMO_ACORDO
  NOTIFICACAO
  LEMBRETE
}

enum CommunicationChannel {
  EMAIL
  WHATSAPP
  TELEFONE
  CARTA
  REUNIAO_PRESENCIAL
  REUNIAO_VIRTUAL
  SISTEMA
}

// ============================================================
// NEGOTIATION MODULE — Models
// ============================================================

model RJNegotiation {
  id                    String              @id @default(cuid())
  jrc_id                String
  jrc                   JudicialRecoveryCase @relation(fields: [jrc_id], references: [id], onDelete: Cascade)

  // Identification
  titulo                String
  descricao             String?             @db.Text
  fase                  NegotiationPhase    @default(MAPEAMENTO)
  prioridade            NegotiationPriority @default(MEDIA)

  // Dates
  data_inicio           DateTime            @default(now())
  data_limite           DateTime?
  data_conclusao        DateTime?

  // Proposal values
  valor_total_original  BigInt              @default(0)
  valor_proposta_atual  BigInt              @default(0)
  desagio_proposto      Float?              // % discount
  carencia_proposta     Int?                // months
  parcelas_propostas    Int?
  juros_proposto        Float?              // % annual

  // Counters (cached)
  total_credores        Int                 @default(0)
  credores_acordados    Int                 @default(0)
  valor_acordado        BigInt              @default(0)

  // Partner program
  programa_parceiro     Boolean             @default(false)
  beneficio_parceiro    String?             @db.Text

  // Mediation
  mediacao_ativa        Boolean             @default(false)
  mediador_nome         String?
  mediador_contato      String?
  proxima_sessao        DateTime?

  observacoes           String?             @db.Text

  created_at            DateTime            @default(now())
  updated_at            DateTime            @updatedAt
  created_by_id         String?

  // Relations
  credores              NegotiationCreditor[]
  atividades            NegotiationActivity[]

  @@index([jrc_id])
  @@index([fase])
  @@map("rj_negotiations")
}

model NegotiationCreditor {
  id                    String                    @id @default(cuid())
  negotiation_id        String
  negotiation           RJNegotiation             @relation(fields: [negotiation_id], references: [id], onDelete: Cascade)

  creditor_id           String
  creditor              RJCreditor                @relation(fields: [creditor_id], references: [id], onDelete: Cascade)

  // Status in this negotiation
  status                CreditorNegotiationStatus @default(NAO_CONTATADO)
  is_parceiro           Boolean                   @default(false)

  // Individual proposal
  valor_original        BigInt                    @default(0)
  valor_proposto        BigInt                    @default(0)
  valor_contraproposta  BigInt?
  valor_acordado        BigInt?
  desagio_individual    Float?
  carencia_individual   Int?
  parcelas_individual   Int?
  juros_individual      Float?

  // Contact info
  ultimo_contato        DateTime?
  proximo_contato       DateTime?
  canal_preferido       CommunicationChannel?
  contato_nome          String?
  contato_email         String?
  contato_telefone      String?

  observacoes           String?                   @db.Text

  created_at            DateTime                  @default(now())
  updated_at            DateTime                  @updatedAt

  @@unique([negotiation_id, creditor_id])
  @@index([negotiation_id])
  @@index([creditor_id])
  @@index([status])
  @@map("negotiation_creditors")
}

model NegotiationActivity {
  id                    String              @id @default(cuid())
  negotiation_id        String
  negotiation           RJNegotiation       @relation(fields: [negotiation_id], references: [id], onDelete: Cascade)

  tipo                  NegActivityType
  canal                 CommunicationChannel?
  descricao             String              @db.Text
  resultado             String?             @db.Text

  // Optional link to specific creditor
  creditor_id           String?
  creditor_nome         String?

  // Attachments (JSON array of { nome, url })
  anexos                Json?

  data_atividade        DateTime            @default(now())
  created_by_id         String?

  created_at            DateTime            @default(now())

  @@index([negotiation_id])
  @@index([data_atividade])
  @@map("negotiation_activities")
}

model NegotiationTemplate {
  id                    String              @id @default(cuid())
  tipo                  NegTemplateType
  titulo                String
  assunto               String?
  conteudo              String              @db.Text
  variaveis             Json?               // available template variables
  canal                 CommunicationChannel?
  ativo                 Boolean             @default(true)

  created_at            DateTime            @default(now())
  updated_at            DateTime            @updatedAt
  created_by_id         String?

  @@map("negotiation_templates")
}

// ===== IMPORTAÇÃO INTELIGENTE =====

enum ImportEntityType {
  PERSON
  CASE
  DEADLINE
  CASE_MOVEMENT
  RJ_CREDITOR
}

enum ImportStatus {
  PENDENTE
  PROCESSANDO
  CONCLUIDO
  CONCLUIDO_PARCIAL
  ERRO
  REVERTIDO
}

model ImportTemplate {
  id              String           @id @default(cuid())
  nome            String
  descricao       String?
  entity_type     ImportEntityType
  field_mapping   Json             // { sourceField: targetField }
  ai_prompt_hint  String?          @db.Text
  ativo           Boolean          @default(true)

  created_at      DateTime         @default(now())
  updated_at      DateTime         @updatedAt
  created_by_id   String?

  import_logs     ImportLog[]

  @@map("import_templates")
}

model ImportLog {
  id              String           @id @default(cuid())
  entity_type     ImportEntityType
  status          ImportStatus     @default(PENDENTE)
  arquivo_nome    String
  arquivo_tipo    String
  total_linhas    Int              @default(0)
  importados      Int              @default(0)
  erros           Int              @default(0)
  ignorados       Int              @default(0)
  detalhes        Json?            // { errors: [], warnings: [], created_ids: [] }
  ai_analysis     Json?
  template_id     String?
  template        ImportTemplate?  @relation(fields: [template_id], references: [id])
  revertido       Boolean          @default(false)

  created_at      DateTime         @default(now())
  created_by_id   String?

  @@index([entity_type])
  @@index([created_at])
  @@map("import_logs")
}

// ===== CREDORES EXTRACONCURSAIS (Art. 49, §3º) =====

enum ExtraconcursalGuaranteeType {
  ALIENACAO_FIDUCIARIA_IMOVEL
  ALIENACAO_FIDUCIARIA_MOVEL
  CESSAO_FIDUCIARIA_RECEBIVEIS
  CESSAO_FIDUCIARIA_DIREITOS_CREDITORIOS
  HIPOTECA
  PENHOR_AGRICOLA
  PENHOR_MERCANTIL
  RESERVA_DOMINIO
  ARRENDAMENTO_MERCANTIL
  CESSAO_FIDUCIARIA_TITULOS
  OUTRO
}

enum BemSituacao {
  EM_POSSE_DEVEDOR
  EM_POSSE_CREDOR
  BUSCA_APREENSAO
  CONSOLIDADO
  LEILAO_AGENDADO
  VENDIDO
  PERECIDO
}

enum ExtraconcursalNegStatus {
  NAO_INICIADA
  EM_NEGOCIACAO
  PROPOSTA_ENVIADA
  CONTRAPROPOSTA
  ACORDO
  EXECUCAO_GARANTIA
  BUSCA_APREENSAO_JUDICIAL
}

enum RiskLevel {
  BAIXO
  MEDIO
  ALTO
  CRITICO
}

enum ImpactLevel {
  NENHUM
  BAIXO
  MEDIO
  ALTO
  CRITICO
}

enum ExtraconcursalEventType {
  CONTATO_INICIAL
  PROPOSTA
  CONTRAPROPOSTA
  REUNIAO
  EMAIL
  TELEFONEMA
  ACORDO
  IMPASSE
  NOTIFICACAO
  BUSCA_APREENSAO
  DECISAO_JUDICIAL
}

model ExtraconcursalCreditor {
  id                        String                    @id @default(cuid())
  jrc_id                    String
  jrc                       JudicialRecoveryCase      @relation(fields: [jrc_id], references: [id], onDelete: Cascade)

  // Optional link to Person
  person_id                 String?
  person                    Person?                   @relation("ExtraconcursalPerson", fields: [person_id], references: [id])

  // Creditor identification
  nome                      String
  cpf_cnpj                  String?

  // Credit values (BigInt centavos)
  valor_total               BigInt                    @default(0)
  valor_garantia            BigInt                    @default(0)
  saldo_devedor             BigInt                    @default(0)

  // Guarantee (art. 49, §3º)
  tipo_garantia             ExtraconcursalGuaranteeType
  descricao_garantia        String                    @db.Text
  matricula_registro        String?
  avaliacao_data            DateTime?
  avaliacao_valor           BigInt                    @default(0)
  avaliacao_responsavel     String?

  // Situação do Bem
  situacao_bem              BemSituacao               @default(EM_POSSE_DEVEDOR)
  localizacao_bem           String?

  // Essencialidade (art. 49, §3º parte final)
  essencial_atividade       Boolean                   @default(false)
  justificativa_essencialidade String?                @db.Text

  // Stay period (art. 6º, §§ 4º e 5º)
  data_deferimento_rj       DateTime?
  prazo_suspensao_fim       DateTime?
  suspensao_ativa           Boolean                   @default(true)

  // Negociação
  status_negociacao         ExtraconcursalNegStatus   @default(NAO_INICIADA)
  rodada_atual              Int                       @default(1)

  // Valores de negociação (BigInt centavos)
  valor_proposto_devedor    BigInt?
  valor_pedido_credor       BigInt?
  valor_acordado            BigInt?
  condicoes_acordo          String?                   @db.Text

  // Risco
  risco_perda_bem           RiskLevel                 @default(MEDIO)
  impacto_operacional       ImpactLevel               @default(MEDIO)

  // Datas
  data_vencimento_original  DateTime?
  data_notificacao_credor   DateTime?

  observacoes               String?                   @db.Text
  created_at                DateTime                  @default(now())
  updated_at                DateTime                  @updatedAt

  // Relations
  eventos                   ExtraconcursalNegotiationEvent[]

  @@index([jrc_id])
  @@index([tipo_garantia])
  @@index([status_negociacao])
  @@map("extraconcursal_creditors")
}

model ExtraconcursalNegotiationEvent {
  id                        String                    @id @default(cuid())
  extraconcursal_creditor_id String
  creditor                  ExtraconcursalCreditor    @relation(fields: [extraconcursal_creditor_id], references: [id], onDelete: Cascade)

  rodada                    Int                       @default(1)
  data                      DateTime                  @default(now())
  tipo                      ExtraconcursalEventType
  descricao                 String                    @db.Text
  valor_proposto            BigInt?
  responsavel_id            String?
  documento_id              String?

  created_at                DateTime                  @default(now())

  @@index([extraconcursal_creditor_id])
  @@map("extraconcursal_negotiation_events")
}
